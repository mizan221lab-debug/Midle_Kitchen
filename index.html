<!doctype html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>BKP Kitchen ERP (Single-File)</title>

  <!-- Tailwind + Font -->
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;600;700;800&display=swap" rel="stylesheet">

  <!-- React (UMD) -->
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>

  <!-- Chart.js (for graphs, lighter + stable on GH Pages) -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

  <!-- Lucide Icons -->
  <script src="https://unpkg.com/lucide@latest"></script>

  <style>
    body { font-family: 'Sarabun', sans-serif; background:#f1f5f9; margin:0; }
    .glass-card { background: rgba(255,255,255,0.95); backdrop-filter: blur(10px); border: 1px solid rgba(226,232,240,.9); }
    .sidebar-active { background:#2563eb; color:#fff; box-shadow:0 10px 15px -3px rgba(37,99,235,.25); }
    .input-premium{ width:100%; padding:1rem; border-radius:1rem; border:1px solid #e2e8f0; background:#f8fafc; font-weight:700; outline:none; transition:.15s; }
    .input-premium:focus{ box-shadow:0 0 0 2px rgba(59,130,246,.55); background:#fff; }
    .no-scrollbar::-webkit-scrollbar{ display:none; }
    @media print { .no-print{ display:none !important; } body{ background:#fff; -webkit-print-color-adjust:exact; } main{ padding:0 !important; margin:0 !important; } }
    .animate-in{ animation: fadeIn .35s ease-out; }
    @keyframes fadeIn { from{ opacity:0; transform: translateY(10px);} to{ opacity:1; transform: translateY(0);} }
    .mono{ font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }
  </style>
</head>

<body class="text-slate-900">
  <div id="root">
    <!-- Loader fallback (will be replaced when app mounts) -->
    <div class="h-screen flex flex-col items-center justify-center bg-[#0f172a] text-white">
      <div class="animate-spin rounded-full h-16 w-16 border-t-4 border-blue-500 mb-6 shadow-2xl"></div>
      <h1 class="text-2xl font-black tracking-widest uppercase animate-pulse">กำลังโหลดระบบ BKP...</h1>
      <p class="text-slate-400 text-sm mt-4">ถ้าค้างนานเกิน 10 วินาที กดรีเฟรช (Cmd+Shift+R)</p>
    </div>
  </div>

<script>
(function () {
  // -----------------------------
  // Utilities (Back-office logic in single file)
  // -----------------------------
  const LS = {
    get(key, fallback) {
      try {
        const raw = localStorage.getItem(key);
        if (raw === null || raw === undefined || raw === "") return fallback;
        return JSON.parse(raw);
      } catch (e) {
        console.warn("LS.get parse fail:", key, e);
        return fallback;
      }
    },
    set(key, value) {
      try { localStorage.setItem(key, JSON.stringify(value)); }
      catch (e) { console.warn("LS.set fail:", key, e); }
    }
  };

  const fmtMoney = (n) => {
    const v = Number(n || 0);
    return v.toLocaleString(undefined, { maximumFractionDigits: 2 });
  };

  const toDateISO = (d) => new Date(d).toISOString().split("T")[0];

  const sum = (arr) => arr.reduce((s, x) => s + (Number(x) || 0), 0);

  const uid = () => String(Date.now()) + "_" + Math.random().toString(16).slice(2);

  // -----------------------------
  // Keys + Initial Master Data
  // -----------------------------
  const KEYS = {
    PRODS: "bkp_prods_th",
    COSTS: "bkp_costs_th",
    SHARES: "bkp_shares_th",
    INVS: "bkp_invs_th",
    EXPS: "bkp_exps_th"
  };

  const INITIAL = {
    PRODUCTS: [
      { id: "p1", name: "น้ำยำปลาร้า", rmCost: 50.79, price: 160, color: "#f43f5e" },
      { id: "p2", name: "ซอสผัดไทย", rmCost: 59.27, price: 150, color: "#f59e0b" },
      { id: "p3", name: "น้ำจิ้มแจ่ว", rmCost: 79.32, price: 140, color: "#10b981" },
      { id: "p4", name: "ซอสหมักไก่", rmCost: 105.55, price: 160, color: "#3b82f6" },
      { id: "p5", name: "น้ำส้มตำ", rmCost: 74.72, price: 120, color: "#8b5cf6" }
    ],
    SHAREHOLDERS: [
      { id: "s1", name: "บี", percent: 50, color: "#3b82f6" },
      { id: "s2", name: "กล้วย", percent: 25, color: "#10b981" },
      { id: "s3", name: "เป้", percent: 25, color: "#f59e0b" }
    ],
    OP_COSTS: { labor: 15, accounting: 8, electricity: 1, cleaning: 0, depreciation: 2, gas: 4 }
  };

  // -----------------------------
  // Error overlay to avoid "loading stuck silently"
  // -----------------------------
  function showFatal(err) {
    console.error(err);
    const root = document.getElementById("root");
    if (!root) return;
    root.innerHTML = `
      <div class="min-h-screen p-6 bg-[#0f172a] text-white">
        <div class="max-w-3xl mx-auto">
          <h1 class="text-2xl font-black mb-2">เกิดข้อผิดพลาด ทำให้ระบบไม่สามารถเริ่มได้</h1>
          <p class="text-slate-300 mb-4">เปิด DevTools → Console เพื่อดูรายละเอียด (หรือส่งรูปให้ฉันดูได้)</p>
          <div class="bg-white/5 border border-white/10 rounded-2xl p-4 mono text-sm overflow-auto">
            ${String(err && (err.stack || err.message || err)).replace(/</g,"&lt;")}
          </div>
          <div class="mt-6 flex gap-2">
            <button class="px-4 py-2 rounded-xl bg-blue-600 font-bold" onclick="location.reload()">รีเฟรช</button>
            <button class="px-4 py-2 rounded-xl bg-slate-700 font-bold" onclick="localStorage.clear();location.reload()">ล้างข้อมูลในเครื่องแล้วเริ่มใหม่</button>
          </div>
        </div>
      </div>`;
  }

  try {
    // -----------------------------
    // React setup (NO BABEL / NO JSX)
    // -----------------------------
    const { useEffect, useMemo, useRef, useState } = React;
    const h = React.createElement;

    // -----------------------------
    // Reusable Components
    // -----------------------------
    function Icon({ name, className }) {
      return h("i", { "data-lucide": name, className: className || "w-5 h-5" });
    }

    function NavItem({ active, onClick, icon, label }) {
      return h("button", {
        onClick,
        className:
          "w-full flex items-center gap-3 px-4 py-3 rounded-xl transition-all " +
          (active
            ? "sidebar-active text-white"
            : "text-slate-400 hover:bg-white/5 hover:text-slate-200")
      }, h(Icon, { name: icon, className: "w-5 h-5" }),
         h("span", { className: "text-sm font-bold" }, label));
    }

    function StatCard({ label, value, color, icon, sub, bg }) {
      return h("div", { className: `p-6 rounded-3xl border border-slate-200 glass-card shadow-sm ${bg || "bg-white"}` }, [
        h("div", { className: "flex justify-between items-center mb-4", key: "h" }, [
          h("p", { className: "text-[10px] font-black text-slate-400 uppercase tracking-widest", key:"l" }, label),
          h("div", { className: "p-2 bg-slate-50 rounded-xl text-slate-300", key:"i" }, h(Icon, { name: icon, className: "w-4 h-4" }))
        ]),
        h("h3", { className: `text-2xl font-black ${color} tracking-tight`, key:"v" }, "฿" + fmtMoney(value)),
        h("p", { className: "text-[9px] font-bold text-slate-300 uppercase mt-1", key:"s" }, sub || "")
      ]);
    }

    // Chart component (Trend)
    function SalesChart({ labels, values }) {
      const canvasRef = useRef(null);
      const chartRef = useRef(null);

      useEffect(() => {
        if (!window.Chart || !canvasRef.current) return;
        if (chartRef.current) chartRef.current.destroy();

        const ctx = canvasRef.current.getContext("2d");
        chartRef.current = new Chart(ctx, {
          type: "line",
          data: {
            labels,
            datasets: [{
              label: "ยอดขาย",
              data: values,
              tension: 0.35,
              borderWidth: 3,
              pointRadius: 3,
              fill: true
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: { display: false },
              tooltip: { enabled: true }
            },
            scales: {
              x: { grid: { display: false }, ticks: { font: { size: 10 } } },
              y: { grid: { display: false }, ticks: { display: false } }
            }
          }
        });

        return () => { if (chartRef.current) chartRef.current.destroy(); };
      }, [labels.join("|"), values.join("|")]);

      return h("div", { className: "h-[250px]" }, h("canvas", { ref: canvasRef }));
    }

    // -----------------------------
    // App
    // -----------------------------
    function App() {
      const [activeTab, setActiveTab] = useState("dashboard");

      // Load from localStorage (or initial)
      const [products, setProducts] = useState(() => LS.get(KEYS.PRODS, INITIAL.PRODUCTS));
      const [opCosts, setOpCosts] = useState(() => LS.get(KEYS.COSTS, INITIAL.OP_COSTS));
      const [shareholders, setShareholders] = useState(() => LS.get(KEYS.SHARES, INITIAL.SHAREHOLDERS));
      const [invoices, setInvoices] = useState(() => LS.get(KEYS.INVS, []));
      const [expenses, setExpenses] = useState(() => LS.get(KEYS.EXPS, []));

      const [reportRange, setReportRange] = useState(() => ({
        start: toDateISO(new Date(new Date().getFullYear(), new Date().getMonth(), 1)),
        end: toDateISO(new Date())
      }));

      // Persist
      useEffect(() => { LS.set(KEYS.PRODS, products); }, [products]);
      useEffect(() => { LS.set(KEYS.COSTS, opCosts); }, [opCosts]);
      useEffect(() => { LS.set(KEYS.SHARES, shareholders); }, [shareholders]);
      useEffect(() => { LS.set(KEYS.INVS, invoices); }, [invoices]);
      useEffect(() => { LS.set(KEYS.EXPS, expenses); }, [expenses]);

      // Refresh lucide icons
      useEffect(() => { if (window.lucide) window.lucide.createIcons(); }, [activeTab, products.length, shareholders.length]);

      const opRate = useMemo(() => {
        const vals = Object.values(opCosts || {}).map(v => Number(v) || 0);
        return sum(vals);
      }, [opCosts]);

      const analysis = useMemo(() => {
        const start = new Date(reportRange.start);
        const end = new Date(reportRange.end);
        end.setHours(23, 59, 59, 999);

        const filteredInv = (invoices || []).filter(i => {
          const d = new Date(i.date);
          return d >= start && d <= end;
        });

        const filteredExp = (expenses || []).filter(e => {
          const d = new Date(e.date);
          return d >= start && d <= end;
        });

        let rev = 0, kg = 0, paid = 0;
        const prodMap = {};

        for (const inv of filteredInv) {
          const total = Number(inv.total || 0);
          rev += total;
          paid += Number(inv.paidAmount || 0);

          const items = inv.items || {};
          for (const pid of Object.keys(items)) {
            const qty = Number(items[pid] || 0);
            if (qty <= 0) continue;
            kg += qty;

            if (!prodMap[pid]) prodMap[pid] = { qty: 0, rev: 0, profit: 0 };

            const p = products.find(x => x.id === pid);
            if (!p) continue;

            const costPerKg = (Number(p.rmCost || 0) + opRate);
            prodMap[pid].qty += qty;
            prodMap[pid].rev += qty * Number(p.price || 0);
            prodMap[pid].profit += qty * (Number(p.price || 0) - costPerKg);
          }
        }

        const expenseTotal = filteredExp.reduce((s, e) => s + (Number(e.amount) || 0), 0);
        const profit = Object.values(prodMap).reduce((s, v) => s + (Number(v.profit) || 0), 0);

        return {
          rev, kg, paid,
          receivable: rev - paid,
          profit,
          prodMap,
          expenseTotal,
          invCount: filteredInv.length
        };
      }, [invoices, expenses, products, reportRange, opRate]);

      const latest10 = useMemo(() => {
        const arr = (invoices || []).slice().sort((a,b) => new Date(a.date) - new Date(b.date));
        const last = arr.slice(-10);
        return {
          labels: last.map(x => x.date),
          values: last.map(x => Number(x.total || 0))
        };
      }, [invoices]);

      const forecast30 = useMemo(() => {
        const days = Math.max(1, analysis.invCount);
        const avgPerBill = analysis.rev / days;
        return avgPerBill * 30;
      }, [analysis.rev, analysis.invCount]);

      const exportCSV = () => {
        let csv = `รายงาน BKP Kitchen\nระยะเวลา: ${reportRange.start} ถึง ${reportRange.end}\n\n`;
        csv += "สินค้า,จำนวน(กก.),ยอดขาย,กำไรสุทธิ\n";
        Object.entries(analysis.prodMap).forEach(([id, v]) => {
          const name = (products.find(p => p.id === id) || {}).name || id;
          csv += `${name},${Number(v.qty||0)},${Number(v.rev||0)},${Number(v.profit||0)}\n`;
        });
        csv += `\nกำไรสุทธิรวม,${analysis.profit}\n\nส่วนแบ่งกำไร\n`;
        (shareholders || []).forEach(sh => {
          const share = analysis.profit * (Number(sh.percent||0)/100);
          csv += `${sh.name},${sh.percent}%,${share.toFixed(2)}\n`;
        });

        const blob = new Blob(["\uFEFF" + csv], { type: "text/csv;charset=utf-8;" });
        const link = document.createElement("a");
        link.href = URL.createObjectURL(blob);
        link.download = `BKP_Report_${reportRange.start}_to_${reportRange.end}.csv`;
        link.click();
      };

      // -----------------------------
      // Pages (Tabs)
      // -----------------------------
      function Dashboard() {
        return h("div", { className:"space-y-8 animate-in" }, [
          h("header", { className:"flex justify-between items-end border-l-4 border-blue-600 pl-4", key:"hd" }, [
            h("div", { key:"l" }, [
              h("h2", { className:"text-2xl font-black text-slate-800" }, "ภาพรวมธุรกิจ"),
              h("p", { className:"text-slate-400 text-sm" }, "สถานะการเงินและการขายล่าสุด")
            ]),
            h("div", { className:"no-print bg-white p-2 px-4 rounded-xl border shadow-sm text-xs font-bold text-slate-500 flex items-center gap-2", key:"r" }, [
              h(Icon, { name:"calendar", className:"w-3 h-3 text-blue-500" }),
              new Date().toLocaleDateString("th-TH")
            ])
          ]),

          h("div", { className:"grid grid-cols-1 md:grid-cols-4 gap-4", key:"cards" }, [
            h(StatCard, { label:"เงินสดรับจริง", value:analysis.paid, color:"text-green-600", icon:"banknote", sub:"เข้ากระเป๋าแล้ว", key:"c1" }),
            h(StatCard, { label:"ยอดขายรวม", value:analysis.rev, color:"text-slate-900", icon:"trending-up", sub:"รวมบิลทั้งหมด", key:"c2" }),
            h(StatCard, { label:"ลูกหนี้ค้างชำระ", value:analysis.receivable, color:"text-red-500", icon:"alert-circle", sub:"รอเก็บเงิน", key:"c3" }),
            h(StatCard, { label:"กำไรสุทธิ", value:analysis.profit, color:"text-blue-600", icon:"dollar-sign", sub:"หักต้นทุนผลิตต่อกก.", bg:"bg-blue-50/50", key:"c4" })
          ]),

          h("div", { className:"grid grid-cols-1 lg:grid-cols-3 gap-6", key:"charts" }, [
            h("div", { className:"lg:col-span-2 glass-card p-6 rounded-3xl shadow-sm h-[350px]", key:"ch1" }, [
              h("h3", { className:"font-bold text-slate-800 mb-4 flex items-center gap-2" }, [
                h(Icon, { name:"bar-chart-2", className:"w-4 h-4" }),
                "แนวโน้มยอดขาย (10 รายการล่าสุด)"
              ]),
              h(SalesChart, { labels: latest10.labels, values: latest10.values })
            ]),

            h("div", { className:"bg-[#0f172a] p-8 rounded-3xl text-white relative overflow-hidden flex flex-col justify-center shadow-lg", key:"ch2" }, [
              h("p", { className:"text-blue-400 font-bold text-xs uppercase mb-2" }, "พยากรณ์รายรับ (30 วัน)"),
              h("h4", { className:"text-4xl font-black mb-4" }, "฿" + Number(forecast30||0).toLocaleString(undefined,{maximumFractionDigits:0})),
              h("p", { className:"text-slate-400 text-xs" }, "คำนวณจากยอดขายในช่วงรายงานปัจจุบัน")
            ])
          ])
        ]);
      }

      function Report() {
        const rows = Object.entries(analysis.prodMap);

        return h("div", { className:"space-y-6 animate-in" }, [
          h("div", { className:"glass-card p-6 rounded-3xl no-print flex gap-4 shadow-sm items-end", key:"filters" }, [
            h("div", { className:"grid grid-cols-2 gap-4 flex-1" }, [
              h("div", {}, [
                h("label", { className:"text-xs font-bold text-slate-500" }, "เริ่มวันที่"),
                h("input", {
                  type:"date",
                  value: reportRange.start,
                  onChange: (e) => setReportRange({ ...reportRange, start: e.target.value }),
                  className:"input-premium"
                })
              ]),
              h("div", {}, [
                h("label", { className:"text-xs font-bold text-slate-500" }, "ถึงวันที่"),
                h("input", {
                  type:"date",
                  value: reportRange.end,
                  onChange: (e) => setReportRange({ ...reportRange, end: e.target.value }),
                  className:"input-premium"
                })
              ])
            ]),
            h("div", { className:"flex gap-2" }, [
              h("button", { onClick: exportCSV, className:"bg-green-600 text-white px-4 py-3 rounded-xl font-bold flex items-center gap-2 hover:bg-green-700 text-sm" },
                [h(Icon,{name:"download",className:"w-4 h-4"}), "CSV"]
              ),
              h("button", { onClick: () => window.print(), className:"bg-slate-900 text-white px-4 py-3 rounded-xl font-bold flex items-center gap-2 hover:scale-105 text-sm" },
                [h(Icon,{name:"printer",className:"w-4 h-4"}), "พิมพ์"]
              )
            ])
          ]),

          h("div", { className:"bg-white p-10 rounded-3xl shadow-lg min-h-[800px] print:shadow-none print:border-none", key:"paper" }, [
            h("div", { className:"flex justify-between items-start mb-10 border-b-4 border-blue-600 pb-8" }, [
              h("div", {}, [
                h("h1", { className:"text-3xl font-black text-slate-900" }, "รายงานผลประกอบการ"),
                h("p", { className:"text-blue-600 font-bold" }, "ครัวกลาง BKP Partnership"),
                h("p", { className:"text-xs text-slate-500 mt-1" }, `ช่วงวันที่: ${reportRange.start} ถึง ${reportRange.end}`)
              ]),
              h("div", { className:"text-right" }, [
                h("p", { className:"text-xs font-bold text-slate-400" }, "กำไรสุทธิปันผล"),
                h("h2", { className:"text-4xl font-black text-slate-900" }, "฿" + fmtMoney(analysis.profit))
              ])
            ]),

            h("table", { className:"w-full text-left text-sm mb-12" }, [
              h("thead", {}, h("tr", { className:"bg-slate-50 border-y-2 border-slate-200 text-slate-500" }, [
                h("th", { className:"p-4" }, "รายการสินค้า"),
                h("th", { className:"p-4 text-center" }, "จำนวน (กก.)"),
                h("th", { className:"p-4 text-right" }, "ยอดขาย"),
                h("th", { className:"p-4 text-right text-blue-600" }, "กำไร")
              ])),
              h("tbody", {}, rows.map(([pid, val]) => {
                const p = products.find(x => x.id === pid);
                return h("tr", { key: pid, className:"border-b" }, [
                  h("td", { className:"p-4 font-bold" }, p ? p.name : pid),
                  h("td", { className:"p-4 text-center" }, Number(val.qty||0).toLocaleString()),
                  h("td", { className:"p-4 text-right" }, "฿" + fmtMoney(val.rev)),
                  h("td", { className:"p-4 text-right font-bold text-green-600" }, "฿" + fmtMoney(val.profit))
                ]);
              }))
            ]),

            h("h3", { className:"font-bold text-slate-800 mb-6 border-l-4 border-blue-600 pl-3" }, "ส่วนแบ่งกำไรผู้ถือหุ้น"),
            h("div", { className:"grid grid-cols-1 md:grid-cols-3 gap-4 mb-20 text-center" },
              (shareholders || []).map((sh) => {
                const amt = analysis.profit * (Number(sh.percent||0)/100);
                return h("div", { key: sh.id, className:"p-6 border rounded-2xl bg-slate-50" }, [
                  h("p", { className:"text-sm font-bold text-slate-500 mb-2" }, `${sh.name} (${sh.percent}%)`),
                  h("p", { className:"text-2xl font-black", style:{ color: sh.color } }, "฿" + amt.toLocaleString(undefined,{minimumFractionDigits:2, maximumFractionDigits:2}))
                ]);
              })
            )
          ])
        ]);
      }

      function Settlement() {
        return h("div", { className:"max-w-4xl mx-auto space-y-6 animate-in" }, [
          h("h2", { className:"text-2xl font-black text-slate-800" }, "สรุปยอดโอนค่าแรง (Settlement)"),
          h("div", { className:"glass-card p-8 rounded-3xl shadow-lg" }, [
            h("div", { className:"grid grid-cols-1 lg:grid-cols-2 gap-8" }, [
              h("div", { className:"bg-blue-600 p-8 rounded-3xl text-white shadow-lg text-center flex flex-col justify-center" }, [
                h("p", { className:"text-blue-100 text-sm font-bold mb-2" }, "น้ำหนักผลิตรวม (Kg)"),
                h("h2", { className:"text-6xl font-black mb-6" }, Number(analysis.kg||0).toLocaleString()),
                h("div", { className:"pt-6 border-t border-white/20" }, [
                  h("p", { className:"text-sm mb-1" }, "ยอดโอนจ่ายรวม"),
                  h("h4", { className:"text-3xl font-black" }, "฿" + fmtMoney((Number(analysis.kg||0) * opRate)))
                ])
              ]),
              h("div", { className:"space-y-3" },
                Object.entries(opCosts || {}).map(([k,v]) => h("div", { key:k, className:"flex justify-between p-4 bg-white border rounded-2xl shadow-sm" }, [
                  h("div", {}, [
                    h("p", { className:"font-bold text-sm uppercase" }, k),
                    h("p", { className:"text-xs text-slate-400" }, `${Number(analysis.kg||0).toLocaleString()} Kg x ${Number(v||0)}`)
                  ]),
                  h("p", { className:"font-black text-lg" }, "฿" + fmtMoney(Number(analysis.kg||0) * Number(v||0)))
                ]))
              )
            ])
          ])
        ]);
      }

      function Watchdog() {
        return h("div", { className:"space-y-6 animate-in" }, [
          h("h2", { className:"text-2xl font-black text-slate-800 border-l-4 border-red-500 pl-3" }, "Margin Watchdog"),
          h("div", { className:"grid grid-cols-1 md:grid-cols-3 gap-6" },
            (products || []).map(p => {
              const price = Number(p.price||0);
              const cost = Number(p.rmCost||0) + opRate;
              const margin = price > 0 ? ((price - cost)/price)*100 : 0;
              const isLow = margin < 15;
              return h("div", {
                key:p.id,
                className: `p-6 rounded-3xl border-2 transition-all ${isLow ? "bg-red-50 border-red-500" : "bg-white border-slate-100"}`
              }, [
                h("div", { className:"flex justify-between items-start mb-4" }, [
                  h("h4", { className:"font-bold text-lg" }, p.name),
                  isLow ? h(Icon, { name:"alert-triangle", className:"text-red-600 w-6 h-6" }) : null
                ]),
                h("p", { className:`text-4xl font-black ${isLow ? "text-red-600":"text-slate-900"}` }, margin.toFixed(1) + "%"),
                h("p", { className:"text-xs font-bold text-slate-400 mt-2" }, `กำไรต่อกก. ≈ ฿${fmtMoney(price - cost)} (รวมทุนแฝง/กก. = ฿${fmtMoney(opRate)})`)
              ]);
            })
          )
        ]);
      }

      function RecordSale() {
        const [date, setDate] = useState(toDateISO(new Date()));
        const [cust, setCust] = useState("");
        const [items, setItems] = useState(() => {
          const obj = {};
          (products || []).forEach(p => obj[p.id] = 0);
          return obj;
        });

        useEffect(() => {
          // if products changed, re-sync item keys without losing existing values
          setItems(prev => {
            const next = { ...prev };
            (products || []).forEach(p => { if (next[p.id] === undefined) next[p.id] = 0; });
            Object.keys(next).forEach(k => { if (!(products || []).some(p => p.id === k)) delete next[k]; });
            return next;
          });
        }, [products]);

        const total = useMemo(() => {
          let t = 0;
          for (const p of (products || [])) {
            const q = Number(items[p.id] || 0);
            t += q * Number(p.price || 0);
          }
          return t;
        }, [items, products]);

        const save = () => {
          if (!cust.trim()) return alert("กรุณากรอกชื่อลูกค้า");
          if (total <= 0) return alert("กรุณาใส่จำนวนสินค้าอย่างน้อย 1 รายการ");

          // compact items
          const compact = {};
          for (const k of Object.keys(items)) {
            const q = Number(items[k] || 0);
            if (q > 0) compact[k] = q;
          }

          const inv = {
            id: uid(),
            date,
            customerName: cust.trim(),
            items: compact,
            total,
            status: "Unpaid",
            paidAmount: 0
          };

          setInvoices([inv, ...(invoices || [])]);
          setActiveTab("dashboard");
        };

        return h("div", { className:"max-w-xl mx-auto space-y-6 animate-in" }, [
          h("h2", { className:"text-2xl font-black text-slate-800 border-l-4 border-blue-600 pl-4" }, "ออกใบแจ้งหนี้ (Sale)"),
          h("div", { className:"glass-card p-8 rounded-3xl shadow-xl space-y-6" }, [
            h("div", { className:"grid grid-cols-2 gap-4" }, [
              h("div", {}, [
                h("label", { className:"text-xs font-bold text-slate-400 ml-2" }, "วันที่"),
                h("input", { type:"date", value: date, onChange: e=>setDate(e.target.value), className:"input-premium" })
              ]),
              h("div", {}, [
                h("label", { className:"text-xs font-bold text-slate-400 ml-2" }, "ลูกค้า"),
                h("input", { value: cust, onChange: e=>setCust(e.target.value), className:"input-premium", placeholder:"ชื่อลูกค้า..." })
              ])
            ]),

            h("div", { className:"space-y-3 max-h-[300px] overflow-y-auto no-scrollbar" },
              (products || []).map(p => h("div", {
                key:p.id,
                className:"flex items-center gap-4 p-4 bg-white rounded-2xl border hover:border-blue-500 transition-all"
              }, [
                h("div", { className:"flex-1 font-bold" }, [
                  p.name,
                  h("span", { className:"text-xs text-slate-400 ml-2" }, `@${p.price}`)
                ]),
                h("div", { className:"w-28 relative" }, [
                  h("input", {
                    type:"number",
                    min:"0",
                    step:"0.01",
                    value: items[p.id] || 0,
                    onChange: e => setItems({ ...items, [p.id]: e.target.value }),
                    className:"w-full p-2 bg-slate-50 rounded-xl text-right font-bold outline-none"
                  }),
                  h("span", { className:"absolute right-2 top-1.5 text-xs text-slate-400" }, "Kg")
                ])
              ]))
            ),

            h("div", { className:"flex items-center justify-between bg-slate-50 border rounded-2xl p-4" }, [
              h("div", { className:"text-xs font-bold text-slate-500" }, "รวมยอดบิล"),
              h("div", { className:"text-xl font-black text-slate-900" }, "฿" + fmtMoney(total))
            ]),

            h("button", {
              onClick: save,
              className:"w-full bg-blue-600 text-white font-black py-4 rounded-2xl shadow-lg hover:scale-105 transition-all text-lg"
            }, "บันทึกบิล")
          ])
        ]);
      }

      function History() {
        const receiveMoney = (invId) => {
          const inv = (invoices || []).find(x => x.id === invId);
          if (!inv) return;

          const amtStr = prompt("ยอดรับชำระ:");
          if (!amtStr) return;
          const amt = Number(amtStr);
          if (Number.isNaN(amt) || amt <= 0) return alert("ยอดไม่ถูกต้อง");

          setInvoices((invoices || []).map(i => {
            if (i.id !== invId) return i;
            const newPaid = Number(i.paidAmount || 0) + amt;
            const status =
              newPaid >= Number(i.total || 0) ? "Paid" :
              newPaid > 0 ? "Partial" : "Unpaid";
            return { ...i, paidAmount: newPaid, status };
          }));
        };

        return h("div", { className:"space-y-6 animate-in" }, [
          h("h2", { className:"text-2xl font-black text-slate-800" }, "ประวัติและลูกหนี้ (History)"),
          h("div", { className:"space-y-3" },
            (invoices || []).map(inv => {
              const status = inv.status || "Unpaid";
              const isPaid = status === "Paid";
              const badge =
                isPaid ? "bg-green-100 text-green-700" :
                status === "Partial" ? "bg-amber-100 text-amber-700" :
                "bg-red-100 text-red-700";

              return h("div", { key: inv.id, className:"bg-white p-5 rounded-3xl border flex items-center justify-between shadow-sm" }, [
                h("div", { className:"flex gap-4 items-center" }, [
                  h("div", { className:"bg-slate-100 p-3 rounded-2xl text-center min-w-[70px] font-black text-slate-600" }, [
                    h("p", { className:"text-[10px] uppercase" }, new Date(inv.date).toLocaleDateString("th-TH",{month:"short"})),
                    h("p", { className:"text-2xl leading-none" }, new Date(inv.date).getDate())
                  ]),
                  h("div", {}, [
                    h("h4", { className:"font-bold text-lg text-slate-800" }, inv.customerName || "-"),
                    h("span", { className:`text-[10px] px-2 py-1 rounded-md font-bold ${badge}` },
                      isPaid ? "จ่ายแล้ว" : status === "Partial" ? "จ่ายบางส่วน" : "ค้างชำระ"
                    ),
                    h("p", { className:"text-xs text-slate-400 mt-1" },
                      `รับแล้ว ฿${fmtMoney(inv.paidAmount)} / ทั้งหมด ฿${fmtMoney(inv.total)}`
                    )
                  ])
                ]),
                h("div", { className:"text-right flex items-center gap-4" }, [
                  h("div", {}, [
                    h("p", { className:"text-xs text-slate-400 font-bold" }, "ยอดบิล"),
                    h("p", { className:"font-black text-xl" }, "฿" + fmtMoney(inv.total))
                  ]),
                  !isPaid ? h("button", {
                    onClick: () => receiveMoney(inv.id),
                    className:"bg-emerald-500 text-white px-4 py-2 rounded-xl font-bold shadow-md text-xs"
                  }, "รับเงิน") : null
                ])
              ]);
            })
          )
        ]);
      }

      function Expense() {
        const [date, setDate] = useState(toDateISO(new Date()));
        const [amt, setAmt] = useState("");
        const [note, setNote] = useState("");

        const save = () => {
          const a = Number(amt);
          if (Number.isNaN(a) || a <= 0) return alert("กรุณาใส่ยอดรายจ่ายให้ถูกต้อง");
          setExpenses([...(expenses || []), { id: uid(), date, amount: a, note: note || "" }]);
          setActiveTab("dashboard");
        };

        return h("div", { className:"max-w-xl mx-auto space-y-6 animate-in py-10" }, [
          h("div", { className:"glass-card p-8 rounded-3xl shadow-lg" }, [
            h("h2", { className:"text-xl font-black text-red-600 mb-6 flex items-center gap-2" }, [
              h(Icon, { name:"wallet" }), "บันทึกรายจ่าย"
            ]),
            h("div", { className:"grid grid-cols-2 gap-4 mb-4" }, [
              h("div", {}, [
                h("label", { className:"text-xs font-bold text-slate-500" }, "วันที่"),
                h("input", { type:"date", value: date, onChange:e=>setDate(e.target.value), className:"input-premium" })
              ]),
              h("div", {}, [
                h("label", { className:"text-xs font-bold text-slate-500" }, "ยอดเงิน"),
                h("input", { type:"number", value: amt, onChange:e=>setAmt(e.target.value), className:"input-premium text-red-600 font-black text-xl", placeholder:"0.00" })
              ])
            ]),
            h("textarea", { value: note, onChange:e=>setNote(e.target.value), className:"input-premium h-24 mb-4", placeholder:"รายละเอียดค่าใช้จ่าย..." }),
            h("button", { onClick: save, className:"w-full bg-red-600 text-white font-black py-4 rounded-2xl shadow-lg hover:bg-red-700 transition-all" }, "บันทึก")
          ])
        ]);
      }

      function Settings() {
        const totalPercent = (shareholders || []).reduce((s,h) => s + (Number(h.percent)||0), 0);

        const updateProd = (idx, patch) => {
          const next = (products || []).slice();
          next[idx] = { ...next[idx], ...patch };
          setProducts(next);
        };

        const updateShare = (idx, patch) => {
          const next = (shareholders || []).slice();
          next[idx] = { ...next[idx], ...patch };
          setShareholders(next);
        };

        return h("div", { className:"space-y-10 animate-in max-w-4xl mx-auto pb-20" }, [
          h("section", { key:"p" }, [
            h("h3", { className:"text-lg font-black text-slate-800 mb-4 border-l-4 border-blue-600 pl-3" }, "ตั้งค่าสินค้า (Products)"),
            h("div", { className:"space-y-3" },
              (products || []).map((p, idx) => h("div", { key:p.id, className:"bg-white p-4 rounded-2xl border flex items-center gap-4 shadow-sm" }, [
                h("div", { className:"w-10 h-10 rounded-xl flex items-center justify-center text-white font-bold", style:{ backgroundColor: p.color } }, p.id.replace("p","")),
                h("div", { className:"flex-1 font-bold text-slate-700" }, p.name),
                h("div", { className:"flex gap-2" }, [
                  h("div", { className:"w-28" }, [
                    h("label", { className:"text-[9px] font-bold text-slate-400 block text-center" }, "ทุน RM"),
                    h("input", {
                      type:"number",
                      value: p.rmCost,
                      onChange: e => updateProd(idx, { rmCost: Number(e.target.value||0) }),
                      className:"w-full p-2 bg-slate-50 rounded-xl font-bold text-center"
                    })
                  ]),
                  h("div", { className:"w-28" }, [
                    h("label", { className:"text-[9px] font-bold text-slate-400 block text-center" }, "ราคาขาย"),
                    h("input", {
                      type:"number",
                      value: p.price,
                      onChange: e => updateProd(idx, { price: Number(e.target.value||0) }),
                      className:"w-full p-2 bg-slate-50 rounded-xl font-bold text-center text-blue-600"
                    })
                  ])
                ])
              ]))
            )
          ]),

          h("section", { key:"s" }, [
            h("div", { className:"flex justify-between items-center mb-4 border-l-4 border-emerald-500 pl-3" }, [
              h("h3", { className:"text-lg font-black text-slate-800" }, "ผู้ถือหุ้น (Shareholders)"),
              h("button", {
                onClick: () => setShareholders([...(shareholders||[]), { id: uid(), name:"เพิ่มใหม่", percent: 0, color:"#94a3b8" }]),
                className:"bg-slate-900 text-white px-3 py-1 rounded-lg text-xs font-bold"
              }, "+ เพิ่ม")
            ]),

            h("div", { className:"space-y-3" },
              (shareholders || []).map((sh, idx) => h("div", { key: sh.id, className:"bg-white p-4 rounded-2xl border flex items-center gap-4 shadow-sm" }, [
                h("div", { className:"w-8 h-8 rounded-full", style:{ backgroundColor: sh.color } }),
                h("div", { className:"flex-1 font-bold" },
                  h("input", {
                    value: sh.name,
                    onChange: e => updateShare(idx, { name: e.target.value }),
                    className:"bg-transparent border-none outline-none w-full"
                  })
                ),
                h("div", { className:"w-24" },
                  h("input", {
                    type:"number",
                    value: sh.percent,
                    onChange: e => updateShare(idx, { percent: Number(e.target.value||0) }),
                    className:"w-full p-2 bg-slate-50 rounded-xl font-bold text-center text-emerald-600"
                  })
                ),
                h("button", {
                  onClick: () => setShareholders((shareholders||[]).filter((_,i)=>i!==idx)),
                  className:"text-red-400"
                }, h(Icon, { name:"trash-2", className:"w-5 h-5" }))
              ]))
            ),

            h("div", {
              className: `text-center text-xs font-bold mt-2 ${totalPercent===100 ? "text-green-600" : "text-red-600"}`
            }, `รวมเปอร์เซ็นต์: ${totalPercent}% (ต้องครบ 100)`)
          ])
        ]);
      }

      // -----------------------------
      // Layout
      // -----------------------------
      return h("div", { className:"flex flex-col md:flex-row min-h-screen" }, [
        // Sidebar
        h("nav", { className:"w-full md:w-72 bg-[#0f172a] p-6 flex flex-col no-print shrink-0 border-r border-white/5 shadow-2xl" }, [
          h("div", { className:"flex items-center gap-4 mb-10 px-2" }, [
            h("div", { className:"bg-blue-600 p-3 rounded-2xl text-white shadow-xl shadow-blue-500/20" }, h(Icon, { name:"cooking-pot", className:"w-6 h-6" })),
            h("div", {}, [
              h("h1", { className:"text-white font-bold text-xl tracking-tight" }, "BKP SYSTEM"),
              h("span", { className:"text-blue-400 text-[10px] font-bold" }, "ครัวกลางมืออาชีพ")
            ])
          ]),

          h("div", { className:"flex-1 space-y-1 overflow-y-auto no-scrollbar" }, [
            h(NavItem, { active: activeTab==="dashboard", onClick:()=>setActiveTab("dashboard"), icon:"layout-dashboard", label:"หน้าหลัก (Dashboard)", key:"n1" }),
            h(NavItem, { active: activeTab==="report", onClick:()=>setActiveTab("report"), icon:"file-text", label:"รายงานผู้ถือหุ้น", key:"n2" }),
            h(NavItem, { active: activeTab==="settlement", onClick:()=>setActiveTab("settlement"), icon:"calculator", label:"ยอดโอนค่าแรงผลิต", key:"n3" }),
            h(NavItem, { active: activeTab==="watchdog", onClick:()=>setActiveTab("watchdog"), icon:"shield-alert", label:"เฝ้าระวังกำไร", key:"n4" }),

            h("div", { className:"pt-6 pb-2 px-4 text-[10px] text-slate-500 font-bold uppercase tracking-widest" }, "การทำงาน"),
            h(NavItem, { active: activeTab==="record", onClick:()=>setActiveTab("record"), icon:"shopping-cart", label:"ออกบิลใหม่", key:"n5" }),
            h(NavItem, { active: activeTab==="history", onClick:()=>setActiveTab("history"), icon:"history", label:"ประวัติลูกหนี้", key:"n6" }),
            h(NavItem, { active: activeTab==="expense", onClick:()=>setActiveTab("expense"), icon:"wallet", label:"บันทึกรายจ่าย", key:"n7" }),

            h("div", { className:"pt-6 pb-2 px-4 text-[10px] text-slate-500 font-bold uppercase tracking-widest" }, "ตั้งค่า"),
            h(NavItem, { active: activeTab==="settings", onClick:()=>setActiveTab("settings"), icon:"settings", label:"จัดการหุ้น & สินค้า", key:"n8" })
          ])
        ]),

        // Main
        h("main", { className:"flex-1 p-4 md:p-8 overflow-y-auto" }, [
          activeTab==="dashboard" ? h(Dashboard) :
          activeTab==="report" ? h(Report) :
          activeTab==="settlement" ? h(Settlement) :
          activeTab==="watchdog" ? h(Watchdog) :
          activeTab==="record" ? h(RecordSale) :
          activeTab==="history" ? h(History) :
          activeTab==="expense" ? h(Expense) :
          activeTab==="settings" ? h(Settings) :
          h("div", { className:"p-6 bg-white rounded-3xl" }, "ไม่พบหน้า")
        ])
      ]);
    }

    // Mount
    const root = ReactDOM.createRoot(document.getElementById("root"));
    root.render(h(App));

    // If still on loader after 12s, show hint
    setTimeout(() => {
      // if root still contains loader text
      const t = document.body.innerText || "";
      if (t.includes("กำลังโหลดระบบ BKP")) {
        showFatal("App ยังไม่เริ่ม render (อาจโหลด CDN ไม่ครบ หรือโดนบล็อก). ลอง Cmd+Shift+R และดู Console.");
      }
    }, 12000);

  } catch (err) {
    showFatal(err);
  }
})();
</script>
</body>
</html>
