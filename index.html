<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>BKP ERP v3 PRO | Premium (Single File + Auto-Migration)</title>

  <!-- Premium UI -->
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;600;700;800&display=swap" rel="stylesheet">

  <style>
    :root{
      --bg0:#070B16;
      --bg1:#0B1226;
      --card:rgba(255,255,255,.08);
      --card2:rgba(255,255,255,.10);
      --stroke:rgba(255,255,255,.14);
      --muted:rgba(255,255,255,.65);
      --muted2:rgba(255,255,255,.45);
      --good:#22c55e;
      --warn:#f59e0b;
      --bad:#ef4444;
      --pri:#3b82f6;
      --pri2:#60a5fa;
    }
    html,body{height:100%}
    body{
      font-family:'Sarabun',system-ui,-apple-system,Segoe UI,Roboto,Arial;
      background: radial-gradient(1200px 600px at 10% 10%, rgba(59,130,246,.25), transparent 60%),
                  radial-gradient(900px 500px at 90% 30%, rgba(168,85,247,.18), transparent 60%),
                  radial-gradient(900px 500px at 60% 90%, rgba(34,197,94,.12), transparent 55%),
                  linear-gradient(180deg, var(--bg0), var(--bg1));
      color:#e5e7eb;
    }
    .glass{background:var(--card); border:1px solid var(--stroke); backdrop-filter: blur(16px);}
    .glass2{background:var(--card2); border:1px solid var(--stroke); backdrop-filter: blur(16px);}
    .soft-shadow{box-shadow: 0 20px 60px rgba(0,0,0,.35);}
    .btn{
      display:inline-flex; align-items:center; justify-content:center; gap:.5rem;
      border-radius: .85rem; padding: .7rem 1rem; font-weight: 800;
      transition:.15s transform, .15s opacity, .15s background;
      user-select:none;
    }
    .btn:active{transform:scale(.98)}
    .btn-primary{background:linear-gradient(135deg, rgba(59,130,246,1), rgba(96,165,250,1)); color:#0b1226;}
    .btn-dark{background:rgba(255,255,255,.10); border:1px solid rgba(255,255,255,.14);}
    .btn-danger{background:rgba(239,68,68,.18); border:1px solid rgba(239,68,68,.35); color:#fecaca;}
    .btn-good{background:rgba(34,197,94,.18); border:1px solid rgba(34,197,94,.35); color:#bbf7d0;}
    .btn-warn{background:rgba(245,158,11,.18); border:1px solid rgba(245,158,11,.35); color:#fde68a;}
    .input{
      width:100%; border-radius: .85rem; padding:.75rem .9rem; font-weight:700;
      background:rgba(255,255,255,.08); border:1px solid rgba(255,255,255,.14);
      outline:none;
    }
    .input:focus{border-color: rgba(96,165,250,.75); box-shadow:0 0 0 3px rgba(59,130,246,.18)}
    .muted{color:var(--muted)}
    .muted2{color:var(--muted2)}
    .chip{
      display:inline-flex; align-items:center; gap:.4rem;
      padding:.25rem .55rem; border-radius:999px;
      border:1px solid rgba(255,255,255,.14);
      background:rgba(255,255,255,.08);
      font-size:.75rem; font-weight:800;
    }
    .chip-good{border-color:rgba(34,197,94,.35); background:rgba(34,197,94,.12); color:#bbf7d0;}
    .chip-bad{border-color:rgba(239,68,68,.35); background:rgba(239,68,68,.12); color:#fecaca;}
    .chip-warn{border-color:rgba(245,158,11,.35); background:rgba(245,158,11,.12); color:#fde68a;}
    .table{
      width:100%;
      border-collapse:separate;
      border-spacing:0;
      overflow:hidden;
      border-radius: 1.2rem;
      border:1px solid rgba(255,255,255,.12);
      background:rgba(255,255,255,.05);
    }
    .table th{
      text-align:left;
      font-size:.75rem;
      letter-spacing:.06em;
      text-transform:uppercase;
      color:rgba(255,255,255,.7);
      background:rgba(255,255,255,.06);
      padding:.85rem .9rem;
      border-bottom:1px solid rgba(255,255,255,.10);
      white-space:nowrap;
    }
    .table td{
      padding:.8rem .9rem;
      border-bottom:1px solid rgba(255,255,255,.06);
      vertical-align:top;
    }
    .table tr:last-child td{border-bottom:none}
    .no-scrollbar::-webkit-scrollbar{display:none}
    .no-scrollbar{scrollbar-width:none}
    .sidebar-item{
      width:100%;
      display:flex; gap:.75rem; align-items:center;
      padding:.8rem .9rem;
      border-radius:1rem;
      color:rgba(255,255,255,.75);
      font-weight:900;
      transition:.15s background, .15s transform;
    }
    .sidebar-item:hover{background:rgba(255,255,255,.06)}
    .sidebar-item.active{
      background:linear-gradient(135deg, rgba(59,130,246,.22), rgba(168,85,247,.14));
      border:1px solid rgba(96,165,250,.35);
      color:white;
    }
    .mono{font-variant-numeric: tabular-nums;}
    .modal-backdrop{
      position:fixed; inset:0; background:rgba(0,0,0,.55);
      display:flex; align-items:center; justify-content:center;
      z-index:50;
      padding:16px;
    }
    .modal{width:min(920px, 100%); border-radius:1.5rem;}
    .kpi{
      border-radius:1.5rem;
      padding:1.1rem;
      border:1px solid rgba(255,255,255,.12);
      background:rgba(255,255,255,.06);
    }
    .kpi .label{font-size:.7rem; letter-spacing:.12em; text-transform:uppercase; color:rgba(255,255,255,.65); font-weight:900}
    .kpi .value{font-size:1.6rem; font-weight:900}
    .kpi .sub{font-size:.75rem; color:rgba(255,255,255,.55); font-weight:800}
    @media print{
      .no-print{display:none !important;}
      body{background:#fff; color:#111827;}
      .glass,.glass2,.kpi,.table{background:#fff !important; border-color:#e5e7eb !important; color:#111827 !important;}
      .muted,.muted2{color:#6b7280 !important;}
      .table th{background:#f3f4f6 !important; color:#111827 !important;}
      .table td{border-color:#e5e7eb !important;}
      a{color:#111827 !important; text-decoration:none !important;}
    }
  </style>
</head>

<body>
  <div id="root" class="min-h-screen"></div>

  <script>
  /********************************************************************
   * BKP ERP v3 PRO (Premium) - Single File
   * - Auto-migration from v1 (unknown keys) + import from older v3 keys
   * - Does NOT clear old data
   * - CRUD: Customers, Products, Sales+Receipts, PO, Expenses+Vouchers,
   *         Shareholders+Capital, Profit Periods+Allocation+Pending
   * - Range-based reports + print-to-PDF (browser print) for all docs
   ********************************************************************/

  /***********************
   * 0) Constants & Utils
   ***********************/
  const APP_KEY = "BKP_ERP_PRO_V3_DB";
  const OLD_KEYS = [
    "BKP_ERP_V3_DB",         // earlier assistant sample
    "BKP_ERP_DB_PRO_V3",     // possible intermediate
    "bkp_prods_th","bkp_costs_th","bkp_shares_th","bkp_invs_th","bkp_exps_th" // v2-style split keys
  ];

  const todayISO = () => new Date().toISOString().split("T")[0];
  const uid = () => (Date.now().toString(36) + Math.random().toString(36).slice(2,9)).toUpperCase();
  const n = (x) => (Number.isFinite(+x) ? +x : 0);
  const money = (x) => "‡∏ø" + (n(x)).toLocaleString("th-TH", {maximumFractionDigits:2});
  const shortMoney = (x) => "‡∏ø" + (n(x)).toLocaleString("th-TH", {maximumFractionDigits:0});
  const clamp = (x, a, b) => Math.max(a, Math.min(b, x));
  const safeParse = (s) => { try{ return JSON.parse(s); }catch{ return null; } };
  const isObj = (v) => v && typeof v === "object" && !Array.isArray(v);
  const isISODate = (d) => /^\d{4}-\d{2}-\d{2}$/.test(String(d||""));
  const inRange = (d, start, end) => {
    const t = new Date(d).getTime();
    const a = new Date(start).getTime();
    const b = new Date(end).getTime();
    return t >= a && t <= b;
  };

  function downloadJSON(filename, obj){
    const blob = new Blob([JSON.stringify(obj, null, 2)], {type:"application/json"});
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = filename;
    a.click();
  }

  function sum(arr, fn=(x)=>x){ return arr.reduce((s,x)=>s+n(fn(x)),0); }

  function deepClone(o){ return JSON.parse(JSON.stringify(o)); }

  /*************************************
   * 1) Schema (v3 PRO) - robust & safe
   *************************************/
  const EMPTY_DB = {
    meta:{
      schema: 3,
      edition: "PRO",
      createdAt: new Date().toISOString(),
      migratedAt: null,
      migratedFrom: [],
      lastOpenAt: null,
    },
    settings:{
      businessName: "‡∏Ñ‡∏£‡∏±‡∏ß‡∏Å‡∏•‡∏≤‡∏á BKP Partnership",
      address: "",
      phone: "",
      taxId: "",
      currency: "THB"
    },

    customers: [
      // {id, name, phone, note, active, createdAt}
    ],
    products: [
      // {id, name, sku, unit, active, price, cost:{rm, hidden, op, other}, note, createdAt}
    ],
    sales: [
      // {id, date, customerId, items:[{productId, qty, unit, priceAt, costAt}], total, paid, status, note, createdAt, updatedAt}
    ],
    purchaseOrders: [
      // {id, date, supplierName, note, items:[{name, qty, unit, price}], total, paid, status, createdAt, updatedAt}
    ],
    expenses: [
      // {id, date, category, amount, note, createdAt, updatedAt}
    ],
    shareholders: [
      // {id, name, active, investedAmount, note, createdAt, updatedAt}
    ],
    profitPeriods: [
      // {id, start, end, revenue, expense, profit, calculatedAt, allocations:[{id, shareholderId, percentAtCalc, amount, status, receivedAt, note}]}
    ],
    audit: [
      // {id, at, type, message}
    ]
  };

  /*************************************
   * 2) Migration Engine (V1/V2/V3 older)
   *************************************/
  function writeAudit(db, type, message){
    db.audit.unshift({id:uid(), at:new Date().toISOString(), type, message});
    db.audit = db.audit.slice(0, 200);
  }

  function normalizeCustomerName(s){
    return String(s||"").trim().replace(/\s+/g, " ");
  }

  function ensureCustomer(db, name){
    const nm = normalizeCustomerName(name);
    if(!nm) return null;
    let c = db.customers.find(x => x.active !== false && normalizeCustomerName(x.name) === nm);
    if(!c){
      c = {id:uid(), name:nm, phone:"", note:"", active:true, createdAt:new Date().toISOString()};
      db.customers.push(c);
    }
    return c;
  }

  function ensureProduct(db, name, priceGuess=0, rmGuess=0){
    const nm = String(name||"").trim();
    if(!nm) return null;
    let p = db.products.find(x => x.active !== false && String(x.name).trim() === nm);
    if(!p){
      p = {
        id:uid(),
        name:nm,
        sku:"",
        unit:"‡∏Å‡∏Å.",
        active:true,
        price:n(priceGuess),
        cost:{rm:n(rmGuess), hidden:0, op:0, other:0},
        note:"(‡∏¢‡πâ‡∏≤‡∏¢‡πÄ‡∏Ç‡πâ‡∏≤‡∏à‡∏≤‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏î‡∏¥‡∏°)",
        createdAt:new Date().toISOString()
      };
      db.products.push(p);
    }
    return p;
  }

  // Heuristic: scan localStorage for arrays/objects that might contain v1 data
  function scanLocalStorageCandidates(){
    const candidates = [];
    for(let i=0;i<localStorage.length;i++){
      const key = localStorage.key(i);
      const raw = localStorage.getItem(key);
      const parsed = safeParse(raw);
      if(parsed == null) continue;
      candidates.push({key, parsed});
    }
    return candidates;
  }

  // Import from older split keys (v2 style)
  function importFromSplitKeys(db){
    const prods = safeParse(localStorage.getItem("bkp_prods_th"));
    const shares = safeParse(localStorage.getItem("bkp_shares_th"));
    const invs = safeParse(localStorage.getItem("bkp_invs_th"));
    const exps = safeParse(localStorage.getItem("bkp_exps_th"));
    const costs = safeParse(localStorage.getItem("bkp_costs_th"));

    let touched = false;

    // Products
    if(Array.isArray(prods) && prods.length){
      prods.forEach(p=>{
        const np = ensureProduct(db, p.name, p.price, p.rmCost);
        if(np){
          // bring richer costs if available
          if(isObj(np.cost)){
            np.cost.rm = n(p.rmCost ?? np.cost.rm);
          }else{
            np.cost = {rm:n(p.rmCost), hidden:0, op:0, other:0};
          }
          np.price = n(p.price ?? np.price);
          np.note = np.note || "";
          touched = true;
        }
      });
    }

    // Shareholders
    if(Array.isArray(shares) && shares.length){
      shares.forEach(s=>{
        const name = String(s.name||"").trim();
        if(!name) return;
        let sh = db.shareholders.find(x=>x.active!==false && x.name===name);
        if(!sh){
          sh = {id:uid(), name, active:true, investedAmount:0, note:"(‡∏¢‡πâ‡∏≤‡∏¢‡∏à‡∏≤‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏î‡∏¥‡∏°)", createdAt:new Date().toISOString(), updatedAt:null};
          db.shareholders.push(sh);
          touched = true;
        }
        // we don't know investedAmount in v2, keep 0
      });
    }

    // Expenses
    if(Array.isArray(exps) && exps.length){
      exps.forEach(e=>{
        if(!e) return;
        const date = isISODate(e.date) ? e.date : todayISO();
        db.expenses.push({
          id:uid(),
          date,
          category: "‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢",
          amount: n(e.amount),
          note: String(e.note||"").trim(),
          createdAt:new Date().toISOString(),
          updatedAt:null
        });
        touched = true;
      });
    }

    // Invoices (sales)
    if(Array.isArray(invs) && invs.length){
      invs.forEach(inv=>{
        const date = isISODate(inv.date) ? inv.date : todayISO();
        const cust = ensureCustomer(db, inv.customerName || inv.customer || "");
        const items = [];
        if(isObj(inv.items)){
          Object.entries(inv.items).forEach(([pid, qty])=>{
            // match by product id from v2 if possible
            const v2p = Array.isArray(prods) ? prods.find(x=>x.id===pid) : null;
            const prod = v2p ? ensureProduct(db, v2p.name, v2p.price, v2p.rmCost) : null;
            if(prod){
              const costAt = n(prod.cost.rm + prod.cost.hidden + prod.cost.op + prod.cost.other);
              items.push({
                productId: prod.id,
                qty: n(qty),
                unit: prod.unit || "‡∏Å‡∏Å.",
                priceAt: n(prod.price),
                costAt
              });
            }
          });
        }
        const total = n(inv.total || sum(items, it=>it.qty*it.priceAt));
        const paid = n(inv.paidAmount || 0);
        const status = paid>=total ? "‡∏£‡∏±‡∏ö‡∏Ñ‡∏£‡∏ö" : (paid>0 ? "‡∏£‡∏±‡∏ö‡∏ö‡∏≤‡∏á‡∏™‡πà‡∏ß‡∏ô" : "‡∏Ñ‡πâ‡∏≤‡∏á‡∏£‡∏±‡∏ö");
        db.sales.push({
          id:uid(),
          date,
          customerId: cust ? cust.id : null,
          items,
          total,
          paid,
          status,
          note:"",
          createdAt:new Date().toISOString(),
          updatedAt:null
        });
        touched = true;
      });
    }

    // Costs (op costs) -> convert into expense presets note
    if(isObj(costs)){
      db.settings._opCostsLegacy = costs;
      touched = true;
    }

    return touched;
  }

  // Import from unknown v1-ish collections by heuristic fields
  function importHeuristicV1(db){
    const candidates = scanLocalStorageCandidates();
    let touched = false;

    function tryArray(arr){
      if(!Array.isArray(arr) || !arr.length) return;
      for(const item of arr){
        if(!isObj(item)) continue;

        // Customer-like
        if(item.customerName || item.customer || (item.phone && item.name) || item.customer_id){
          const nm = item.customerName || item.customer || item.name;
          if(nm){
            ensureCustomer(db, nm);
            touched = true;
          }
        }

        // Product-like
        if((item.rmCost!=null && item.price!=null) || (item.cost!=null && item.price!=null && item.name)){
          const nm = item.productName || item.product || item.name;
          if(nm){
            ensureProduct(db, nm, item.price, item.rmCost ?? item.cost ?? 0);
            touched = true;
          }
        }

        // Sale-like
        if((item.total!=null || item.amountTotal!=null) && (item.customerName || item.customer)){
          const date = isISODate(item.date) ? item.date : todayISO();
          const cust = ensureCustomer(db, item.customerName || item.customer);
          const total = n(item.total ?? item.amountTotal ?? 0);
          const paid = n(item.paidAmount ?? item.paid ?? 0);
          const status = paid>=total ? "‡∏£‡∏±‡∏ö‡∏Ñ‡∏£‡∏ö" : (paid>0 ? "‡∏£‡∏±‡∏ö‡∏ö‡∏≤‡∏á‡∏™‡πà‡∏ß‡∏ô" : "‡∏Ñ‡πâ‡∏≤‡∏á‡∏£‡∏±‡∏ö");
          db.sales.push({
            id:uid(),
            date,
            customerId: cust ? cust.id : null,
            items: [],
            total,
            paid,
            status,
            note: String(item.note||"").trim(),
            createdAt:new Date().toISOString(),
            updatedAt:null
          });
          touched = true;
        }

        // Expense-like
        if(item.amount!=null && (item.note || item.category || item.desc) && item.total==null){
          const date = isISODate(item.date) ? item.date : todayISO();
          db.expenses.push({
            id:uid(),
            date,
            category: String(item.category||"‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢").trim(),
            amount: n(item.amount),
            note: String(item.note||item.desc||"").trim(),
            createdAt:new Date().toISOString(),
            updatedAt:null
          });
          touched = true;
        }

        // PO-like (supplier/total)
        if((item.supplierName || item.supplier) && (item.total!=null || item.amount!=null) && !item.customerName){
          const date = isISODate(item.date) ? item.date : todayISO();
          db.purchaseOrders.push({
            id:uid(),
            date,
            supplierName: String(item.supplierName||item.supplier).trim(),
            note: String(item.note||"").trim(),
            items: [],
            total: n(item.total ?? item.amount ?? 0),
            paid: n(item.paid ?? 0),
            status: n(item.paid ?? 0) >= n(item.total ?? item.amount ?? 0) ? "‡∏à‡πà‡∏≤‡∏¢‡∏Ñ‡∏£‡∏ö" : (n(item.paid ?? 0)>0 ? "‡∏à‡πà‡∏≤‡∏¢‡∏ö‡∏≤‡∏á‡∏™‡πà‡∏ß‡∏ô" : "‡∏Ñ‡πâ‡∏≤‡∏á‡∏à‡πà‡∏≤‡∏¢"),
            createdAt:new Date().toISOString(),
            updatedAt:null
          });
          touched = true;
        }
      }
    }

    for(const c of candidates){
      const p = c.parsed;
      if(Array.isArray(p)) tryArray(p);
      else if(isObj(p)){
        Object.values(p).forEach(v=>{
          if(Array.isArray(v)) tryArray(v);
        });
      }
    }

    return touched;
  }

  function loadDB(){
    // 1) current key
    const cur = safeParse(localStorage.getItem(APP_KEY));
    if(cur && cur.meta && cur.meta.schema === 3){
      cur.meta.lastOpenAt = new Date().toISOString();
      localStorage.setItem(APP_KEY, JSON.stringify(cur));
      return cur;
    }

    // 2) old keys direct import
    for(const k of OLD_KEYS){
      const old = safeParse(localStorage.getItem(k));
      if(old && old.meta && old.meta.schema === 3){
        // copy to new key
        old.meta.lastOpenAt = new Date().toISOString();
        old.meta.migratedAt = old.meta.migratedAt || new Date().toISOString();
        old.meta.migratedFrom = Array.from(new Set([...(old.meta.migratedFrom||[]), k]));
        localStorage.setItem(APP_KEY, JSON.stringify(old));
        return old;
      }
    }

    // 3) create new + migration
    const db = deepClone(EMPTY_DB);
    db.meta.migratedAt = new Date().toISOString();
    db.meta.migratedFrom = [];

    // 3.1 import from split keys if exist
    let touched = importFromSplitKeys(db);
    if(touched) db.meta.migratedFrom.push("v2-split-keys");

    // 3.2 heuristic v1 scan
    const touched2 = importHeuristicV1(db);
    if(touched2) db.meta.migratedFrom.push("v1-heuristic-scan");

    // Deduplicate customers/products by name
    const custMap = new Map();
    db.customers = db.customers.filter(c=>{
      const key = normalizeCustomerName(c.name);
      if(!key) return false;
      if(custMap.has(key)) return false;
      custMap.set(key, true);
      return true;
    });

    const prodMap = new Map();
    db.products = db.products.filter(p=>{
      const key = String(p.name||"").trim();
      if(!key) return false;
      if(prodMap.has(key)) return false;
      prodMap.set(key, true);
      // ensure cost object
      if(!isObj(p.cost)) p.cost = {rm:0, hidden:0, op:0, other:0};
      p.price = n(p.price);
      p.cost.rm = n(p.cost.rm); p.cost.hidden = n(p.cost.hidden); p.cost.op = n(p.cost.op); p.cost.other = n(p.cost.other);
      if(!p.unit) p.unit = "‡∏Å‡∏Å.";
      if(p.active == null) p.active = true;
      return true;
    });

    writeAudit(db, "MIGRATE", "‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• v3 PRO ‡πÅ‡∏•‡∏∞‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏î‡∏¥‡∏°‡πÇ‡∏î‡∏¢‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥");
    localStorage.setItem(APP_KEY, JSON.stringify(db));
    return db;
  }

  let DB = loadDB();

  function saveDB(){
    DB.meta.lastOpenAt = new Date().toISOString();
    localStorage.setItem(APP_KEY, JSON.stringify(DB));
  }

  /*************************************
   * 3) Business Calculations
   *************************************/
  function productCost(p){
    if(!p) return 0;
    const c = p.cost || {rm:0, hidden:0, op:0, other:0};
    return n(c.rm) + n(c.hidden) + n(c.op) + n(c.other);
  }

  function saleRecalc(sale){
    const total = sum(sale.items||[], it=> n(it.qty) * n(it.priceAt));
    sale.total = n(total);
    const paid = n(sale.paid);
    sale.status = paid >= sale.total ? "‡∏£‡∏±‡∏ö‡∏Ñ‡∏£‡∏ö" : (paid>0 ? "‡∏£‡∏±‡∏ö‡∏ö‡∏≤‡∏á‡∏™‡πà‡∏ß‡∏ô" : "‡∏Ñ‡πâ‡∏≤‡∏á‡∏£‡∏±‡∏ö");
    sale.updatedAt = new Date().toISOString();
  }

  function poRecalc(po){
    const total = sum(po.items||[], it=> n(it.qty) * n(it.price));
    po.total = n(total);
    const paid = n(po.paid);
    po.status = paid >= po.total ? "‡∏à‡πà‡∏≤‡∏¢‡∏Ñ‡∏£‡∏ö" : (paid>0 ? "‡∏à‡πà‡∏≤‡∏¢‡∏ö‡∏≤‡∏á‡∏™‡πà‡∏ß‡∏ô" : "‡∏Ñ‡πâ‡∏≤‡∏á‡∏à‡πà‡∏≤‡∏¢");
    po.updatedAt = new Date().toISOString();
  }

  function calcProfit(start, end){
    const sales = DB.sales.filter(s=> isISODate(s.date) && inRange(s.date, start, end));
    const expenses = DB.expenses.filter(e=> isISODate(e.date) && inRange(e.date, start, end));
    const revenue = sum(sales, s=>s.total);
    const expense = sum(expenses, e=>e.amount);
    // Optional: COGS from sales items (if present) - can be used for margin analytics
    const cogs = sum(sales, s=> sum(s.items||[], it=> n(it.qty)*n(it.costAt)));
    const gross = revenue - cogs;
    const profit = revenue - expense; // Simplified net (as your v1/v2 style)
    return {revenue, expense, profit, cogs, gross, salesCount:sales.length, expCount:expenses.length};
  }

  function shareholderTotals(){
    const active = DB.shareholders.filter(s=>s.active!==false);
    const totalInvest = sum(active, s=>s.investedAmount);
    return {active, totalInvest};
  }

  function computeSharePercents(){
    const {active, totalInvest} = shareholderTotals();
    const rows = active.map(s=>{
      const pct = totalInvest>0 ? (n(s.investedAmount)/totalInvest)*100 : 0;
      return {...s, percent: pct};
    });
    return {rows, totalInvest};
  }

  /*************************************
   * 4) UI Core (render, navigation, components)
   *************************************/
  const root = document.getElementById("root");

  const state = {
    tab: "dashboard",
    range: {
      start: new Date(new Date().getFullYear(), new Date().getMonth(), 1).toISOString().split("T")[0],
      end: todayISO()
    },
    modal: null, // {title, bodyHtml, onSubmit}
    toast: null,
    search: {
      customer: "",
      product: "",
      po: "",
      sale: "",
      expense: "",
      shareholder: ""
    }
  };

  function toast(msg, type="info"){
    state.toast = {msg, type, at: Date.now()};
    render();
    setTimeout(()=>{ if(state.toast && Date.now()-state.toast.at>1800){ state.toast=null; render(); } }, 1900);
  }

  function setTab(t){ state.tab = t; render(); }

  function openModal(title, bodyHtml, onSubmit, submitText="‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å"){
    state.modal = {title, bodyHtml, onSubmit, submitText};
    render();
  }
  function closeModal(){ state.modal=null; render(); }

  function htmlesc(s){
    return String(s??"").replace(/[&<>"']/g, (m)=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;" }[m]));
  }

  function badge(status){
    if(status==="‡∏£‡∏±‡∏ö‡∏Ñ‡∏£‡∏ö"||status==="‡∏à‡πà‡∏≤‡∏¢‡∏Ñ‡∏£‡∏ö") return `<span class="chip chip-good">‚úÖ ${status}</span>`;
    if(status==="‡∏Ñ‡πâ‡∏≤‡∏á‡∏£‡∏±‡∏ö"||status==="‡∏Ñ‡πâ‡∏≤‡∏á‡∏à‡πà‡∏≤‡∏¢") return `<span class="chip chip-bad">‚õî ${status}</span>`;
    return `<span class="chip chip-warn">üü† ${status}</span>`;
  }

  function kpi(label, value, sub, accent="pri"){
    const ring = accent==="good" ? "rgba(34,197,94,.35)" : accent==="bad" ? "rgba(239,68,68,.35)" : "rgba(59,130,246,.35)";
    const glow = accent==="good" ? "rgba(34,197,94,.20)" : accent==="bad" ? "rgba(239,68,68,.20)" : "rgba(59,130,246,.20)";
    return `
      <div class="kpi soft-shadow" style="border-color:${ring}; box-shadow: 0 20px 70px rgba(0,0,0,.25), 0 0 0 1px ${glow} inset;">
        <div class="label">${htmlesc(label)}</div>
        <div class="value mono mt-2">${htmlesc(value)}</div>
        <div class="sub mt-1">${htmlesc(sub||"")}</div>
      </div>
    `;
  }

  function pageHeader(title, subtitle, actionsHtml=""){
    return `
      <div class="flex flex-col md:flex-row md:items-end md:justify-between gap-3">
        <div class="pl-4 border-l-4" style="border-color: rgba(96,165,250,.75);">
          <div class="text-2xl md:text-3xl font-black">${htmlesc(title)}</div>
          <div class="muted text-sm font-bold mt-1">${htmlesc(subtitle||"")}</div>
        </div>
        <div class="flex gap-2 flex-wrap no-print">${actionsHtml||""}</div>
      </div>
    `;
  }

  function topBar(){
    const {start,end} = state.range;
    return `
      <div class="glass2 rounded-2xl p-4 md:p-5 soft-shadow">
        <div class="flex flex-col lg:flex-row lg:items-center lg:justify-between gap-3">
          <div class="flex items-center gap-3">
            <div class="w-11 h-11 rounded-2xl flex items-center justify-center font-black"
                 style="background:linear-gradient(135deg, rgba(59,130,246,.35), rgba(168,85,247,.22)); border:1px solid rgba(96,165,250,.35);">
              BKP
            </div>
            <div>
              <div class="text-lg font-black">BKP ERP v3 PRO</div>
              <div class="text-xs font-bold muted2">Premium ¬∑ Single File ¬∑ Auto-Migration ¬∑ Print-to-PDF</div>
            </div>
          </div>

          <div class="flex flex-wrap gap-2 items-end no-print">
            <div>
              <div class="text-[11px] font-black muted2 mb-1">‡∏ä‡πà‡∏ß‡∏á‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô</div>
              <div class="flex gap-2">
                <input class="input" style="width:180px" type="date" id="rng-start" value="${htmlesc(start)}">
                <input class="input" style="width:180px" type="date" id="rng-end" value="${htmlesc(end)}">
              </div>
            </div>
            <button class="btn btn-dark" onclick="applyRange()">‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏ä‡πà‡∏ß‡∏á</button>
            <button class="btn btn-dark" onclick="backupData()">‡∏™‡∏≥‡∏£‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
            <button class="btn btn-primary" onclick="printCurrent()">‡∏û‡∏¥‡∏°‡∏û‡πå‡∏´‡∏ô‡πâ‡∏≤‡∏ô‡∏µ‡πâ (PDF)</button>
          </div>
        </div>
      </div>
    `;
  }

  function sidebar(){
    const items = [
      {id:"dashboard", label:"‡πÅ‡∏î‡∏ä‡∏ö‡∏≠‡∏£‡πå‡∏î", icon:"üìä"},
      {id:"sales", label:"‡∏Ç‡∏≤‡∏¢ / ‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à", icon:"üßæ"},
      {id:"po", label:"‡πÉ‡∏ö‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠ (PO)", icon:"üìë"},
      {id:"expenses", label:"‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢ / ‡πÉ‡∏ö‡πÄ‡∏ö‡∏¥‡∏Å", icon:"üí∏"},
      {id:"customers", label:"‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤", icon:"üë•"},
      {id:"products", label:"‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ & ‡∏ï‡πâ‡∏ô‡∏ó‡∏∏‡∏ô", icon:"üì¶"},
      {id:"shareholders", label:"‡∏ú‡∏π‡πâ‡∏ñ‡∏∑‡∏≠‡∏´‡∏∏‡πâ‡∏ô & ‡∏Å‡∏≥‡πÑ‡∏£", icon:"ü§ù"},
      {id:"reports", label:"‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏£‡∏ß‡∏°", icon:"üìà"},
      {id:"settings", label:"‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤", icon:"‚öôÔ∏è"},
    ];
    const rows = items.map(it=>{
      const active = it.id===state.tab ? "active" : "";
      return `<button class="sidebar-item ${active}" onclick="setTab('${it.id}')">
        <span class="text-xl">${it.icon}</span>
        <span class="text-sm">${htmlesc(it.label)}</span>
      </button>`;
    }).join("");

    return `
      <div class="glass rounded-3xl p-4 md:p-5 soft-shadow h-full">
        <div class="flex items-center justify-between mb-4">
          <div>
            <div class="text-sm font-black muted2 uppercase tracking-widest">‡πÄ‡∏°‡∏ô‡∏π‡∏£‡∏∞‡∏ö‡∏ö</div>
            <div class="text-lg font-black mt-1">${htmlesc(DB.settings.businessName || "‡∏Ñ‡∏£‡∏±‡∏ß‡∏Å‡∏•‡∏≤‡∏á BKP")}</div>
          </div>
          <div class="chip">üóÇÔ∏è <span class="mono">${DB.meta.schema}</span></div>
        </div>
        <div class="space-y-1 overflow-y-auto no-scrollbar" style="max-height: calc(100vh - 210px);">
          ${rows}
        </div>
        <div class="mt-4 pt-4 border-t" style="border-color:rgba(255,255,255,.10)">
          <div class="text-xs font-bold muted2">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</div>
          <div class="text-xs font-black mt-2">
            <div>‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤: <span class="mono">${DB.customers.filter(x=>x.active!==false).length}</span></div>
            <div>‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤: <span class="mono">${DB.products.filter(x=>x.active!==false).length}</span></div>
            <div>‡∏ö‡∏¥‡∏•‡∏Ç‡∏≤‡∏¢: <span class="mono">${DB.sales.length}</span></div>
            <div>PO: <span class="mono">${DB.purchaseOrders.length}</span></div>
          </div>
          <div class="text-[11px] muted2 font-bold mt-3">
            ‡∏¢‡πâ‡∏≤‡∏¢‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•: <span class="mono">${(DB.meta.migratedFrom||[]).join(", ") || "‚Äî"}</span>
          </div>
        </div>
      </div>
    `;
  }

  function layout(content){
    const toastHtml = state.toast ? `
      <div class="fixed bottom-5 right-5 z-50">
        <div class="glass2 rounded-2xl px-4 py-3 soft-shadow">
          <div class="text-sm font-black">${htmlesc(state.toast.msg)}</div>
        </div>
      </div>` : "";

    const modalHtml = state.modal ? `
      <div class="modal-backdrop no-print" onclick="if(event.target===this) closeModal()">
        <div class="modal glass2 soft-shadow p-5 md:p-6">
          <div class="flex items-start justify-between gap-4">
            <div>
              <div class="text-xl font-black">${htmlesc(state.modal.title)}</div>
              <div class="text-xs font-bold muted2 mt-1">‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö ‡πÅ‡∏•‡πâ‡∏ß‡∏Å‡∏î ‚Äú${htmlesc(state.modal.submitText)}‚Äù</div>
            </div>
            <button class="btn btn-dark" onclick="closeModal()">‡∏õ‡∏¥‡∏î</button>
          </div>
          <div class="mt-4">${state.modal.bodyHtml}</div>
          <div class="mt-5 flex gap-2 justify-end">
            <button class="btn btn-dark" onclick="closeModal()">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
            <button class="btn btn-primary" onclick="submitModal()">${htmlesc(state.modal.submitText)}</button>
          </div>
        </div>
      </div>` : "";

    return `
      <div class="p-4 md:p-6">
        <div class="max-w-[1400px] mx-auto">
          ${topBar()}
          <div class="mt-4 grid grid-cols-1 lg:grid-cols-[360px_1fr] gap-4">
            <div class="no-print">${sidebar()}</div>
            <div>${content}</div>
          </div>
        </div>
      </div>
      ${toastHtml}
      ${modalHtml}
    `;
  }

  function submitModal(){
    if(!state.modal || typeof state.modal.onSubmit!=="function") return;
    try{
      state.modal.onSubmit();
      closeModal();
    }catch(err){
      console.error(err);
      toast("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: " + (err?.message||"‡πÑ‡∏°‡πà‡∏ó‡∏£‡∏≤‡∏ö‡∏™‡∏≤‡πÄ‡∏´‡∏ï‡∏∏"));
    }
  }

  /*************************************
   * 5) Pages
   *************************************/
  function pageDashboard(){
    const {start,end} = state.range;
    const p = calcProfit(start, end);

    const receivable = sum(DB.sales.filter(s=>isISODate(s.date) && inRange(s.date,start,end)), s=> Math.max(0, n(s.total)-n(s.paid)));
    const payablePO = sum(DB.purchaseOrders.filter(po=>isISODate(po.date) && inRange(po.date,start,end)), po=> Math.max(0, n(po.total)-n(po.paid)));

    // Customer behavior
    const custAgg = new Map();
    for(const s of DB.sales){
      if(!isISODate(s.date) || !inRange(s.date,start,end)) continue;
      const id = s.customerId || "UNKNOWN";
      if(!custAgg.has(id)) custAgg.set(id, {id, rev:0, bills:0, due:0, last:s.date});
      const row = custAgg.get(id);
      row.rev += n(s.total);
      row.bills += 1;
      row.due += Math.max(0, n(s.total)-n(s.paid));
      if(new Date(s.date) > new Date(row.last)) row.last = s.date;
    }
    const topCustomers = Array.from(custAgg.values())
      .sort((a,b)=>b.rev-a.rev).slice(0,6)
      .map(r=>{
        const c = DB.customers.find(x=>x.id===r.id);
        const name = c ? c.name : "(‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤)";
        return `<tr>
          <td class="font-black">${htmlesc(name)}</td>
          <td class="mono font-black">${money(r.rev)}</td>
          <td class="mono">${r.bills}</td>
          <td>${r.due>0 ? `<span class="chip chip-bad">‡∏Ñ‡πâ‡∏≤‡∏á ${money(r.due)}</span>` : `<span class="chip chip-good">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ñ‡πâ‡∏≤‡∏á</span>`}</td>
          <td class="mono muted2 font-black">${htmlesc(r.last)}</td>
        </tr>`;
      }).join("") || `<tr><td colspan="5" class="muted font-bold">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô‡∏ä‡πà‡∏ß‡∏á‡∏ô‡∏µ‡πâ</td></tr>`;

    // Low margin products (based on current structure)
    const lowMargin = DB.products.filter(p=>p.active!==false).map(p=>{
      const cost = productCost(p);
      const margin = p.price>0 ? ((p.price-cost)/p.price)*100 : 0;
      return {id:p.id, name:p.name, margin, profitPer:(p.price-cost), price:p.price, cost};
    }).sort((a,b)=>a.margin-b.margin).slice(0,6);

    const lowRows = lowMargin.map(x=>{
      const low = x.margin < 15;
      return `<tr>
        <td class="font-black">${htmlesc(x.name)}</td>
        <td class="mono font-black">${money(x.price)}</td>
        <td class="mono">${money(x.cost)}</td>
        <td>${low ? `<span class="chip chip-bad">‡∏ï‡πà‡∏≥ ${x.margin.toFixed(1)}%</span>` : `<span class="chip chip-good">${x.margin.toFixed(1)}%</span>`}</td>
      </tr>`;
    }).join("") || `<tr><td colspan="4" class="muted font-bold">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</td></tr>`;

    const content = `
      <div class="glass rounded-3xl p-5 md:p-7 soft-shadow">
        ${pageHeader("‡πÅ‡∏î‡∏ä‡∏ö‡∏≠‡∏£‡πå‡∏î‡∏ú‡∏π‡πâ‡∏ö‡∏£‡∏¥‡∏´‡∏≤‡∏£", "‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ‚Äì‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢‚Äì‡∏•‡∏π‡∏Å‡∏´‡∏ô‡∏µ‡πâ‚Äì‡∏û‡∏§‡∏ï‡∏¥‡∏Å‡∏£‡∏£‡∏°‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤ (‡∏ï‡∏≤‡∏°‡∏ä‡πà‡∏ß‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å)",
          `<button class="btn btn-dark" onclick="openQuickSale()">+ ‡∏≠‡∏≠‡∏Å‡∏ö‡∏¥‡∏•</button>
           <button class="btn btn-dark" onclick="openQuickPO()">+ ‡∏ó‡∏≥ PO</button>
           <button class="btn btn-dark" onclick="openQuickExpense()">+ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢</button>`
        )}
        <div class="mt-6 grid grid-cols-1 md:grid-cols-2 xl:grid-cols-4 gap-4">
          ${kpi("‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢‡∏£‡∏ß‡∏°", shortMoney(p.revenue), "‡∏£‡∏ß‡∏°‡∏ö‡∏¥‡∏•‡∏Ç‡∏≤‡∏¢‡πÉ‡∏ô‡∏ä‡πà‡∏ß‡∏á", "pri")}
          ${kpi("‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢‡∏£‡∏ß‡∏°", shortMoney(p.expense), "‡∏£‡∏ß‡∏°‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢‡πÉ‡∏ô‡∏ä‡πà‡∏ß‡∏á", "warn")}
          ${kpi("‡∏•‡∏π‡∏Å‡∏´‡∏ô‡∏µ‡πâ‡∏Ñ‡πâ‡∏≤‡∏á‡∏£‡∏±‡∏ö", shortMoney(receivable), "‡∏£‡∏ß‡∏°‡∏¢‡∏≠‡∏î‡∏Ñ‡πâ‡∏≤‡∏á‡∏£‡∏±‡∏ö‡∏à‡∏≤‡∏Å‡∏ö‡∏¥‡∏•", receivable>0?"bad":"good")}
          ${kpi("PO ‡∏Ñ‡πâ‡∏≤‡∏á‡∏à‡πà‡∏≤‡∏¢", shortMoney(payablePO), "‡∏£‡∏ß‡∏°‡∏¢‡∏≠‡∏î‡∏Ñ‡πâ‡∏≤‡∏á‡∏à‡πà‡∏≤‡∏¢‡∏à‡∏≤‡∏Å PO", payablePO>0?"warn":"good")}
        </div>

        <div class="mt-6 grid grid-cols-1 xl:grid-cols-2 gap-4">
          <div class="glass2 rounded-3xl p-5">
            <div class="flex items-end justify-between gap-3">
              <div>
                <div class="text-lg font-black">Top ‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡πÉ‡∏ô‡∏ä‡πà‡∏ß‡∏á</div>
                <div class="text-xs font-bold muted2">‡∏¢‡∏≠‡∏î‡∏ã‡∏∑‡πâ‡∏≠ ¬∑ ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ö‡∏¥‡∏• ¬∑ ‡∏Ñ‡πâ‡∏≤‡∏á‡∏£‡∏±‡∏ö ¬∑ ‡∏ã‡∏∑‡πâ‡∏≠‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</div>
              </div>
              <button class="btn btn-dark" onclick="setTab('customers')">‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</button>
            </div>
            <div class="mt-4 overflow-x-auto">
              <table class="table">
                <thead><tr><th>‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</th><th>‡∏¢‡∏≠‡∏î‡∏ã‡∏∑‡πâ‡∏≠</th><th>‡∏ö‡∏¥‡∏•</th><th>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th><th>‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</th></tr></thead>
                <tbody>${topCustomers}</tbody>
              </table>
            </div>
          </div>

          <div class="glass2 rounded-3xl p-5">
            <div class="flex items-end justify-between gap-3">
              <div>
                <div class="text-lg font-black">Margin Watchdog</div>
                <div class="text-xs font-bold muted2">‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏Å‡∏≥‡πÑ‡∏£‡∏ï‡πà‡∏≥ (‡∏ï‡∏≤‡∏°‡∏ï‡πâ‡∏ô‡∏ó‡∏∏‡∏ô/‡∏£‡∏≤‡∏Ñ‡∏≤‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô)</div>
              </div>
              <button class="btn btn-dark" onclick="setTab('products')">‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</button>
            </div>
            <div class="mt-4 overflow-x-auto">
              <table class="table">
                <thead><tr><th>‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</th><th>‡∏£‡∏≤‡∏Ñ‡∏≤</th><th>‡∏ï‡πâ‡∏ô‡∏ó‡∏∏‡∏ô‡∏£‡∏ß‡∏°</th><th>Margin</th></tr></thead>
                <tbody>${lowRows}</tbody>
              </table>
            </div>
          </div>
        </div>

        <div class="mt-6 glass2 rounded-3xl p-5">
          <div class="flex items-end justify-between gap-3">
            <div>
              <div class="text-lg font-black">‡∏™‡∏£‡∏∏‡∏õ‡∏Å‡∏≥‡πÑ‡∏£ (‡πÅ‡∏ö‡∏ö‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏à‡∏£‡∏¥‡∏á)</div>
              <div class="text-xs font-bold muted2">‡∏Å‡∏≥‡πÑ‡∏£‡∏™‡∏∏‡∏ó‡∏ò‡∏¥ (‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ - ‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢) ‡∏ï‡∏≤‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</div>
            </div>
            <div class="text-right">
              <div class="text-xs font-black muted2">‡∏Å‡∏≥‡πÑ‡∏£‡∏™‡∏∏‡∏ó‡∏ò‡∏¥</div>
              <div class="text-3xl font-black mono">${money(p.profit)}</div>
            </div>
          </div>
          <div class="mt-3 text-xs font-bold muted2">
            * ‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏: ‡∏£‡∏∞‡∏ö‡∏ö‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö ‚Äú‡∏ï‡πâ‡∏ô‡∏ó‡∏∏‡∏ô‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ (COGS)‚Äù ‡∏à‡∏≤‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÉ‡∏ô‡∏ö‡∏¥‡∏• ‡∏´‡∏≤‡∏Å‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏õ‡πá‡∏ô‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÉ‡∏ô‡∏ö‡∏¥‡∏• (‡∏à‡∏∞‡πÉ‡∏ä‡πâ‡πÉ‡∏ô‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏Ç‡∏±‡πâ‡∏ô‡∏™‡∏π‡∏á)
          </div>
        </div>
      </div>
    `;
    return content;
  }

  /********** Customers **********/
  function pageCustomers(){
    const q = state.search.customer.trim().toLowerCase();
    const rows = DB.customers
      .filter(c=>c.active!==false)
      .filter(c=> !q || (c.name||"").toLowerCase().includes(q) || (c.phone||"").toLowerCase().includes(q))
      .sort((a,b)=>(a.name||"").localeCompare(b.name||""))
      .map(c=>{
        const bills = DB.sales.filter(s=>s.customerId===c.id);
        const rev = sum(bills, s=>s.total);
        const due = sum(bills, s=>Math.max(0, n(s.total)-n(s.paid)));
        return `<tr>
          <td>
            <div class="font-black">${htmlesc(c.name)}</div>
            <div class="text-xs font-bold muted2">${htmlesc(c.phone||"‚Äî")} ¬∑ ${htmlesc(c.note||"")}</div>
          </td>
          <td class="mono font-black">${money(rev)}</td>
          <td class="mono">${bills.length}</td>
          <td>${due>0 ? `<span class="chip chip-bad">‡∏Ñ‡πâ‡∏≤‡∏á ${money(due)}</span>` : `<span class="chip chip-good">‡∏õ‡∏Å‡∏ï‡∏¥</span>`}</td>
          <td class="no-print">
            <div class="flex gap-2 flex-wrap">
              <button class="btn btn-dark" onclick="editCustomer('${c.id}')">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button>
              <button class="btn btn-danger" onclick="deactivateCustomer('${c.id}')">‡∏•‡∏ö/‡∏õ‡∏¥‡∏î</button>
            </div>
          </td>
        </tr>`;
      }).join("") || `<tr><td colspan="5" class="muted font-bold">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</td></tr>`;

    const content = `
      <div class="glass rounded-3xl p-5 md:p-7 soft-shadow">
        ${pageHeader("‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤", "‡πÄ‡∏û‡∏¥‡πà‡∏°/‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç/‡∏õ‡∏¥‡∏î‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤ ¬∑ ‡∏î‡∏π‡∏¢‡∏≠‡∏î‡∏ã‡∏∑‡πâ‡∏≠‡πÅ‡∏•‡∏∞‡∏•‡∏π‡∏Å‡∏´‡∏ô‡∏µ‡πâ",
          `<button class="btn btn-primary" onclick="addCustomer()">+ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</button>
           <button class="btn btn-dark" onclick="exportCustomers()">‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤ (JSON)</button>`
        )}
        <div class="mt-5 grid grid-cols-1 md:grid-cols-3 gap-3 no-print">
          <div class="md:col-span-2">
            <div class="text-xs font-black muted2 mb-2">‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ (‡∏ä‡∏∑‡πà‡∏≠/‡πÄ‡∏ö‡∏≠‡∏£‡πå)</div>
            <input class="input" placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤..." value="${htmlesc(state.search.customer)}"
              oninput="state.search.customer=this.value; render()">
          </div>
          <div class="">
            <div class="text-xs font-black muted2 mb-2">‡∏£‡∏ß‡∏°‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤ (Active)</div>
            <div class="glass2 rounded-2xl p-4 font-black mono">${DB.customers.filter(x=>x.active!==false).length}</div>
          </div>
        </div>

        <div class="mt-5 overflow-x-auto">
          <table class="table">
            <thead><tr>
              <th>‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</th><th>‡∏¢‡∏≠‡∏î‡∏ã‡∏∑‡πâ‡∏≠‡∏™‡∏∞‡∏™‡∏°</th><th>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ö‡∏¥‡∏•</th><th>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th><th class="no-print">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>
            </tr></thead>
            <tbody>${rows}</tbody>
          </table>
        </div>
      </div>
    `;
    return content;
  }

  function addCustomer(){
    openModal("‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤", `
      <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
        <div><div class="text-xs font-black muted2 mb-1">‡∏ä‡∏∑‡πà‡∏≠‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤ *</div><input id="m_c_name" class="input" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏£‡πâ‡∏≤‡∏ô A / ‡∏Ñ‡∏∏‡∏ì B"></div>
        <div><div class="text-xs font-black muted2 mb-1">‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£</div><input id="m_c_phone" class="input" placeholder="08x-xxx-xxxx"></div>
        <div class="md:col-span-2"><div class="text-xs font-black muted2 mb-1">‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏</div><input id="m_c_note" class="input" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏™‡πà‡∏á‡∏Ç‡∏≠‡∏á‡∏ó‡∏∏‡∏Å‡∏ß‡∏±‡∏ô‡∏®‡∏∏‡∏Å‡∏£‡πå"></div>
      </div>
    `, ()=>{
      const name = normalizeCustomerName(document.getElementById("m_c_name").value);
      if(!name) throw new Error("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏‡∏ä‡∏∑‡πà‡∏≠‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤");
      const phone = (document.getElementById("m_c_phone").value||"").trim();
      const note = (document.getElementById("m_c_note").value||"").trim();
      if(DB.customers.some(c=>c.active!==false && normalizeCustomerName(c.name)===name)){
        throw new Error("‡∏ä‡∏∑‡πà‡∏≠‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏ô‡∏µ‡πâ‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß");
      }
      DB.customers.push({id:uid(), name, phone, note, active:true, createdAt:new Date().toISOString()});
      saveDB(); toast("‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢"); render();
    }, "‡πÄ‡∏û‡∏¥‡πà‡∏°");
  }

  function editCustomer(id){
    const c = DB.customers.find(x=>x.id===id);
    if(!c) return;
    openModal("‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤", `
      <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
        <div><div class="text-xs font-black muted2 mb-1">‡∏ä‡∏∑‡πà‡∏≠‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤ *</div>
          <input id="m_c_name" class="input" value="${htmlesc(c.name)}"></div>
        <div><div class="text-xs font-black muted2 mb-1">‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£</div>
          <input id="m_c_phone" class="input" value="${htmlesc(c.phone||"")}"></div>
        <div class="md:col-span-2"><div class="text-xs font-black muted2 mb-1">‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏</div>
          <input id="m_c_note" class="input" value="${htmlesc(c.note||"")}"></div>
      </div>
    `, ()=>{
      const name = normalizeCustomerName(document.getElementById("m_c_name").value);
      if(!name) throw new Error("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏‡∏ä‡∏∑‡πà‡∏≠‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤");
      if(DB.customers.some(x=>x.id!==id && x.active!==false && normalizeCustomerName(x.name)===name)){
        throw new Error("‡∏ä‡∏∑‡πà‡∏≠‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏ô‡∏µ‡πâ‡∏ã‡πâ‡∏≥‡∏Å‡∏±‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏≠‡∏∑‡πà‡∏ô");
      }
      c.name = name;
      c.phone = (document.getElementById("m_c_phone").value||"").trim();
      c.note = (document.getElementById("m_c_note").value||"").trim();
      c.updatedAt = new Date().toISOString();
      saveDB(); toast("‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢"); render();
    }, "‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å");
  }

  function deactivateCustomer(id){
    const c = DB.customers.find(x=>x.id===id);
    if(!c) return;
    if(!confirm("‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏õ‡∏¥‡∏î‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏ô‡∏µ‡πâ‡πÉ‡∏ä‡πà‡πÑ‡∏´‡∏°?\n(‡∏ö‡∏¥‡∏•‡πÄ‡∏Å‡πà‡∏≤‡∏à‡∏∞‡∏¢‡∏±‡∏á‡∏≠‡∏¢‡∏π‡πà ‡πÅ‡∏ï‡πà‡∏à‡∏∞‡πÑ‡∏°‡πà‡πÅ‡∏™‡∏î‡∏á‡πÉ‡∏ô‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏•‡∏∑‡∏≠‡∏Å)")) return;
    c.active = false;
    c.updatedAt = new Date().toISOString();
    saveDB(); toast("‡∏õ‡∏¥‡∏î‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡πÅ‡∏•‡πâ‡∏ß"); render();
  }

  function exportCustomers(){
    downloadJSON("BKP_Customers.json", DB.customers);
    toast("‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡πÅ‡∏•‡πâ‡∏ß");
  }

  /********** Products **********/
  function pageProducts(){
    const q = state.search.product.trim().toLowerCase();
    const rows = DB.products
      .filter(p=>p.active!==false)
      .filter(p=> !q || (p.name||"").toLowerCase().includes(q) || (p.sku||"").toLowerCase().includes(q))
      .sort((a,b)=>(a.name||"").localeCompare(b.name||""))
      .map(p=>{
        const cost = productCost(p);
        const margin = p.price>0 ? ((p.price-cost)/p.price)*100 : 0;
        const warn = margin < 15;
        return `<tr>
          <td>
            <div class="font-black">${htmlesc(p.name)}</div>
            <div class="text-xs font-bold muted2">SKU: ${htmlesc(p.sku||"‚Äî")} ¬∑ ‡∏´‡∏ô‡πà‡∏ß‡∏¢: ${htmlesc(p.unit||"‡∏Å‡∏Å.")}</div>
          </td>
          <td class="mono font-black">${money(p.price)}</td>
          <td class="mono">${money(cost)}</td>
          <td>${warn ? `<span class="chip chip-bad">‡∏ï‡πà‡∏≥ ${margin.toFixed(1)}%</span>` : `<span class="chip chip-good">${margin.toFixed(1)}%</span>`}</td>
          <td class="mono font-black">${money(p.price-cost)}</td>
          <td class="no-print">
            <div class="flex gap-2 flex-wrap">
              <button class="btn btn-dark" onclick="editProduct('${p.id}')">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button>
              <button class="btn btn-danger" onclick="deactivateProduct('${p.id}')">‡∏•‡∏ö/‡∏õ‡∏¥‡∏î</button>
            </div>
          </td>
        </tr>`;
      }).join("") || `<tr><td colspan="6" class="muted font-bold">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</td></tr>`;

    const content = `
      <div class="glass rounded-3xl p-5 md:p-7 soft-shadow">
        ${pageHeader("‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ & ‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ï‡πâ‡∏ô‡∏ó‡∏∏‡∏ô", "‡∏õ‡∏£‡∏±‡∏ö‡∏£‡∏≤‡∏Ñ‡∏≤/‡∏ó‡∏∏‡∏ô‡πÑ‡∏î‡πâ‡πÅ‡∏ö‡∏ö‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î ¬∑ ‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏Å‡∏≥‡πÑ‡∏£‡∏ï‡πà‡∏≥",
          `<button class="btn btn-primary" onclick="addProduct()">+ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</button>
           <button class="btn btn-dark" onclick="exportProducts()">‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ (JSON)</button>`
        )}
        <div class="mt-5 grid grid-cols-1 md:grid-cols-3 gap-3 no-print">
          <div class="md:col-span-2">
            <div class="text-xs font-black muted2 mb-2">‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ (‡∏ä‡∏∑‡πà‡∏≠/sku)</div>
            <input class="input" placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤..." value="${htmlesc(state.search.product)}"
              oninput="state.search.product=this.value; render()">
          </div>
          <div>
            <div class="text-xs font-black muted2 mb-2">‡∏£‡∏ß‡∏°‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ (Active)</div>
            <div class="glass2 rounded-2xl p-4 font-black mono">${DB.products.filter(x=>x.active!==false).length}</div>
          </div>
        </div>

        <div class="mt-5 overflow-x-auto">
          <table class="table">
            <thead><tr>
              <th>‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</th><th>‡∏£‡∏≤‡∏Ñ‡∏≤</th><th>‡∏ï‡πâ‡∏ô‡∏ó‡∏∏‡∏ô‡∏£‡∏ß‡∏°</th><th>Margin</th><th>‡∏Å‡∏≥‡πÑ‡∏£/‡∏´‡∏ô‡πà‡∏ß‡∏¢</th><th class="no-print">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>
            </tr></thead>
            <tbody>${rows}</tbody>
          </table>
        </div>

        <div class="mt-5 glass2 rounded-3xl p-5">
          <div class="text-lg font-black">‡πÅ‡∏ô‡∏ß‡∏ó‡∏≤‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ï‡πâ‡∏ô‡∏ó‡∏∏‡∏ô (‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥)</div>
          <div class="text-sm font-bold muted2 mt-1">
            ‡∏ó‡∏∏‡∏ô‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡∏î‡∏¥‡∏ö = RM ¬∑ ‡∏ó‡∏∏‡∏ô‡πÅ‡∏ù‡∏á = ‡∏Ñ‡πà‡∏≤‡πÑ‡∏ü/‡πÅ‡∏û‡πá‡∏Ñ/‡∏™‡∏π‡∏ç‡πÄ‡∏™‡∏µ‡∏¢ ¬∑ ‡∏ó‡∏∏‡∏ô‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£ = ‡∏Ñ‡πà‡∏≤‡πÅ‡∏£‡∏á/‡∏ö‡∏±‡∏ç‡∏ä‡∏µ/‡∏à‡∏±‡∏î‡∏™‡πà‡∏á ¬∑ ‡∏ó‡∏∏‡∏ô‡∏≠‡∏∑‡πà‡∏ô = ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏Å‡∏¥‡∏à
          </div>
        </div>
      </div>
    `;
    return content;
  }

  function addProduct(){
    openModal("‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤", `
      <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
        <div><div class="text-xs font-black muted2 mb-1">‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ *</div><input id="m_p_name" class="input" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏ô‡πâ‡∏≥‡∏¢‡∏≥‡∏õ‡∏•‡∏≤‡∏£‡πâ‡∏≤"></div>
        <div><div class="text-xs font-black muted2 mb-1">SKU</div><input id="m_p_sku" class="input" placeholder="‡∏£‡∏´‡∏±‡∏™‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ (‡πÑ‡∏°‡πà‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö)"></div>
        <div><div class="text-xs font-black muted2 mb-1">‡∏´‡∏ô‡πà‡∏ß‡∏¢</div><input id="m_p_unit" class="input" value="‡∏Å‡∏Å."></div>
        <div><div class="text-xs font-black muted2 mb-1">‡∏£‡∏≤‡∏Ñ‡∏≤‡∏Ç‡∏≤‡∏¢/‡∏´‡∏ô‡πà‡∏ß‡∏¢ *</div><input id="m_p_price" class="input" type="number" value="0"></div>
        <div class="md:col-span-2"><div class="text-xs font-black muted2 mb-1">‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏</div><input id="m_p_note" class="input" placeholder=""></div>

        <div class="md:col-span-2 mt-2">
          <div class="text-sm font-black">‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ï‡πâ‡∏ô‡∏ó‡∏∏‡∏ô</div>
          <div class="grid grid-cols-1 md:grid-cols-4 gap-2 mt-2">
            <div><div class="text-[11px] font-black muted2 mb-1">‡∏ó‡∏∏‡∏ô‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡∏î‡∏¥‡∏ö (RM)</div><input id="m_c_rm" class="input" type="number" value="0"></div>
            <div><div class="text-[11px] font-black muted2 mb-1">‡∏ó‡∏∏‡∏ô‡πÅ‡∏ù‡∏á</div><input id="m_c_hidden" class="input" type="number" value="0"></div>
            <div><div class="text-[11px] font-black muted2 mb-1">‡∏ó‡∏∏‡∏ô‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£</div><input id="m_c_op" class="input" type="number" value="0"></div>
            <div><div class="text-[11px] font-black muted2 mb-1">‡∏ó‡∏∏‡∏ô‡∏≠‡∏∑‡πà‡∏ô</div><input id="m_c_other" class="input" type="number" value="0"></div>
          </div>
        </div>
      </div>
    `, ()=>{
      const name = String(document.getElementById("m_p_name").value||"").trim();
      if(!name) throw new Error("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤");
      if(DB.products.some(p=>p.active!==false && String(p.name).trim()===name)){
        throw new Error("‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ô‡∏µ‡πâ‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß");
      }
      const p = {
        id:uid(),
        name,
        sku:(document.getElementById("m_p_sku").value||"").trim(),
        unit:(document.getElementById("m_p_unit").value||"").trim() || "‡∏Å‡∏Å.",
        active:true,
        price:n(document.getElementById("m_p_price").value),
        cost:{
          rm:n(document.getElementById("m_c_rm").value),
          hidden:n(document.getElementById("m_c_hidden").value),
          op:n(document.getElementById("m_c_op").value),
          other:n(document.getElementById("m_c_other").value),
        },
        note:(document.getElementById("m_p_note").value||"").trim(),
        createdAt:new Date().toISOString(),
        updatedAt:null
      };
      DB.products.push(p);
      saveDB(); toast("‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢"); render();
    }, "‡πÄ‡∏û‡∏¥‡πà‡∏°");
  }

  function editProduct(id){
    const p = DB.products.find(x=>x.id===id);
    if(!p) return;
    openModal("‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ & ‡∏ï‡πâ‡∏ô‡∏ó‡∏∏‡∏ô", `
      <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
        <div><div class="text-xs font-black muted2 mb-1">‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ *</div><input id="m_p_name" class="input" value="${htmlesc(p.name)}"></div>
        <div><div class="text-xs font-black muted2 mb-1">SKU</div><input id="m_p_sku" class="input" value="${htmlesc(p.sku||"")}"></div>
        <div><div class="text-xs font-black muted2 mb-1">‡∏´‡∏ô‡πà‡∏ß‡∏¢</div><input id="m_p_unit" class="input" value="${htmlesc(p.unit||"‡∏Å‡∏Å.")}"></div>
        <div><div class="text-xs font-black muted2 mb-1">‡∏£‡∏≤‡∏Ñ‡∏≤‡∏Ç‡∏≤‡∏¢/‡∏´‡∏ô‡πà‡∏ß‡∏¢ *</div><input id="m_p_price" class="input" type="number" value="${htmlesc(p.price)}"></div>
        <div class="md:col-span-2"><div class="text-xs font-black muted2 mb-1">‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏</div><input id="m_p_note" class="input" value="${htmlesc(p.note||"")}"></div>

        <div class="md:col-span-2 mt-2">
          <div class="text-sm font-black">‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ï‡πâ‡∏ô‡∏ó‡∏∏‡∏ô</div>
          <div class="grid grid-cols-1 md:grid-cols-4 gap-2 mt-2">
            <div><div class="text-[11px] font-black muted2 mb-1">‡∏ó‡∏∏‡∏ô‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡∏î‡∏¥‡∏ö (RM)</div><input id="m_c_rm" class="input" type="number" value="${htmlesc(p.cost?.rm ?? 0)}"></div>
            <div><div class="text-[11px] font-black muted2 mb-1">‡∏ó‡∏∏‡∏ô‡πÅ‡∏ù‡∏á</div><input id="m_c_hidden" class="input" type="number" value="${htmlesc(p.cost?.hidden ?? 0)}"></div>
            <div><div class="text-[11px] font-black muted2 mb-1">‡∏ó‡∏∏‡∏ô‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£</div><input id="m_c_op" class="input" type="number" value="${htmlesc(p.cost?.op ?? 0)}"></div>
            <div><div class="text-[11px] font-black muted2 mb-1">‡∏ó‡∏∏‡∏ô‡∏≠‡∏∑‡πà‡∏ô</div><input id="m_c_other" class="input" type="number" value="${htmlesc(p.cost?.other ?? 0)}"></div>
          </div>
          <div class="mt-3 text-xs font-bold muted2">
            * ‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡∏£‡∏≤‡∏Ñ‡∏≤‡∏´‡∏£‡∏∑‡∏≠‡∏ï‡πâ‡∏ô‡∏ó‡∏∏‡∏ô‡∏à‡∏∞‡∏°‡∏µ‡∏ú‡∏•‡∏ï‡πà‡∏≠ ‚Äú‡∏Å‡∏≤‡∏£‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô‚Äù ‡πÅ‡∏ï‡πà‡∏ö‡∏¥‡∏•‡πÄ‡∏Å‡πà‡∏≤‡∏ó‡∏µ‡πà‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏ö‡∏ö‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ (items) ‡∏à‡∏∞‡πÄ‡∏Å‡πá‡∏ö snapshot ‡∏£‡∏≤‡∏Ñ‡∏≤/‡∏ï‡πâ‡∏ô‡∏ó‡∏∏‡∏ô ‡∏ì ‡∏ï‡∏≠‡∏ô‡∏Ç‡∏≤‡∏¢‡πÑ‡∏ß‡πâ‡πÅ‡∏•‡πâ‡∏ß
          </div>
        </div>
      </div>
    `, ()=>{
      const name = String(document.getElementById("m_p_name").value||"").trim();
      if(!name) throw new Error("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤");
      if(DB.products.some(x=>x.id!==id && x.active!==false && String(x.name).trim()===name)){
        throw new Error("‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ô‡∏µ‡πâ‡∏ã‡πâ‡∏≥‡∏Å‡∏±‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏≠‡∏∑‡πà‡∏ô");
      }
      p.name = name;
      p.sku = (document.getElementById("m_p_sku").value||"").trim();
      p.unit = (document.getElementById("m_p_unit").value||"").trim() || "‡∏Å‡∏Å.";
      p.price = n(document.getElementById("m_p_price").value);
      p.note = (document.getElementById("m_p_note").value||"").trim();
      if(!isObj(p.cost)) p.cost = {rm:0, hidden:0, op:0, other:0};
      p.cost.rm = n(document.getElementById("m_c_rm").value);
      p.cost.hidden = n(document.getElementById("m_c_hidden").value);
      p.cost.op = n(document.getElementById("m_c_op").value);
      p.cost.other = n(document.getElementById("m_c_other").value);
      p.updatedAt = new Date().toISOString();
      saveDB(); toast("‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢"); render();
    }, "‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å");
  }

  function deactivateProduct(id){
    const p = DB.products.find(x=>x.id===id);
    if(!p) return;
    if(!confirm("‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏õ‡∏¥‡∏î‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ô‡∏µ‡πâ‡πÉ‡∏ä‡πà‡πÑ‡∏´‡∏°?\n(‡∏ö‡∏¥‡∏•‡πÄ‡∏Å‡πà‡∏≤‡∏à‡∏∞‡∏¢‡∏±‡∏á‡∏≠‡∏¢‡∏π‡πà ‡πÅ‡∏ï‡πà‡∏à‡∏∞‡πÑ‡∏°‡πà‡πÅ‡∏™‡∏î‡∏á‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏≠‡∏≠‡∏Å‡∏ö‡∏¥‡∏•‡πÉ‡∏´‡∏°‡πà)")) return;
    p.active = false;
    p.updatedAt = new Date().toISOString();
    saveDB(); toast("‡∏õ‡∏¥‡∏î‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÅ‡∏•‡πâ‡∏ß"); render();
  }

  function exportProducts(){
    downloadJSON("BKP_Products.json", DB.products);
    toast("‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÅ‡∏•‡πâ‡∏ß");
  }

  /********** Sales (Invoice/Receipt) **********/
  function pageSales(){
    const q = state.search.sale.trim().toLowerCase();
    const {start,end} = state.range;

    const rows = DB.sales
      .filter(s=>isISODate(s.date))
      .filter(s=>inRange(s.date,start,end))
      .filter(s=>{
        if(!q) return true;
        const c = DB.customers.find(x=>x.id===s.customerId);
        const name = (c?.name||"").toLowerCase();
        return name.includes(q) || String(s.id).toLowerCase().includes(q) || String(s.status||"").toLowerCase().includes(q);
      })
      .sort((a,b)=> new Date(b.date)-new Date(a.date))
      .map(s=>{
        const c = DB.customers.find(x=>x.id===s.customerId);
        const due = Math.max(0, n(s.total)-n(s.paid));
        return `<tr>
          <td>
            <div class="font-black">${htmlesc(c?.name||"(‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤)")} <span class="muted2 text-xs font-black">#${htmlesc(s.id)}</span></div>
            <div class="text-xs font-bold muted2">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà ${htmlesc(s.date)} ¬∑ ${badge(s.status)}</div>
          </td>
          <td class="mono font-black">${money(s.total)}</td>
          <td class="mono">${money(s.paid)}</td>
          <td>${due>0 ? `<span class="chip chip-bad">‡∏Ñ‡πâ‡∏≤‡∏á ${money(due)}</span>` : `<span class="chip chip-good">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ñ‡πâ‡∏≤‡∏á</span>`}</td>
          <td class="no-print">
            <div class="flex gap-2 flex-wrap">
              <button class="btn btn-dark" onclick="editSale('${s.id}')">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button>
              <button class="btn btn-good" onclick="receiveMoney('${s.id}')">‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô</button>
              <button class="btn btn-dark" onclick="printDoc('sale','${s.id}')">‡∏û‡∏¥‡∏°‡∏û‡πå PDF</button>
              <button class="btn btn-danger" onclick="deleteSale('${s.id}')">‡∏•‡∏ö</button>
            </div>
          </td>
        </tr>`;
      }).join("") || `<tr><td colspan="5" class="muted font-bold">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ö‡∏¥‡∏•‡πÉ‡∏ô‡∏ä‡πà‡∏ß‡∏á‡∏ô‡∏µ‡πâ</td></tr>`;

    const content = `
      <div class="glass rounded-3xl p-5 md:p-7 soft-shadow">
        ${pageHeader("‡∏Ç‡∏≤‡∏¢ / ‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à / ‡∏•‡∏π‡∏Å‡∏´‡∏ô‡∏µ‡πâ", "‡∏≠‡∏≠‡∏Å‡∏ö‡∏¥‡∏• ¬∑ ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç ¬∑ ‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô ¬∑ ‡∏û‡∏¥‡∏°‡∏û‡πå‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£ PDF ¬∑ ‡∏Å‡∏£‡∏≠‡∏á‡∏ï‡∏≤‡∏°‡∏ä‡πà‡∏ß‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà",
          `<button class="btn btn-primary" onclick="openQuickSale()">+ ‡∏≠‡∏≠‡∏Å‡∏ö‡∏¥‡∏•‡πÉ‡∏´‡∏°‡πà</button>
           <button class="btn btn-dark" onclick="setTab('customers')">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</button>`
        )}

        <div class="mt-5 grid grid-cols-1 md:grid-cols-3 gap-3 no-print">
          <div class="md:col-span-2">
            <div class="text-xs font-black muted2 mb-2">‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ (‡∏ä‡∏∑‡πà‡∏≠‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤/‡∏£‡∏´‡∏±‡∏™‡∏ö‡∏¥‡∏•/‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞)</div>
            <input class="input" placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤..." value="${htmlesc(state.search.sale)}"
              oninput="state.search.sale=this.value; render()">
          </div>
          <div>
            <div class="text-xs font-black muted2 mb-2">‡∏¢‡∏≠‡∏î‡∏Ñ‡πâ‡∏≤‡∏á‡∏£‡∏±‡∏ö (‡πÉ‡∏ô‡∏ä‡πà‡∏ß‡∏á)</div>
            <div class="glass2 rounded-2xl p-4 font-black mono">${money(sum(DB.sales.filter(s=>isISODate(s.date)&&inRange(s.date,start,end)), s=>Math.max(0,n(s.total)-n(s.paid))))}</div>
          </div>
        </div>

        <div class="mt-5 overflow-x-auto">
          <table class="table">
            <thead><tr><th>‡∏ö‡∏¥‡∏•</th><th>‡∏¢‡∏≠‡∏î‡∏ö‡∏¥‡∏•</th><th>‡∏£‡∏±‡∏ö‡πÅ‡∏•‡πâ‡∏ß</th><th>‡∏Ñ‡πâ‡∏≤‡∏á‡∏£‡∏±‡∏ö</th><th class="no-print">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th></tr></thead>
            <tbody>${rows}</tbody>
          </table>
        </div>
      </div>
    `;
    return content;
  }

  function openQuickSale(){
    const customers = DB.customers.filter(c=>c.active!==false).sort((a,b)=>a.name.localeCompare(b.name));
    const products = DB.products.filter(p=>p.active!==false).sort((a,b)=>a.name.localeCompare(b.name));
    if(customers.length===0){
      toast("‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤: ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏Å‡πà‡∏≠‡∏ô");
      setTab("customers");
      return;
    }
    if(products.length===0){
      toast("‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤: ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏Å‡πà‡∏≠‡∏ô");
      setTab("products");
      return;
    }

    const prodRows = products.map(p=>{
      return `
        <div class="glass2 rounded-2xl p-3 flex items-center justify-between gap-3">
          <div class="min-w-0">
            <div class="font-black truncate">${htmlesc(p.name)}</div>
            <div class="text-xs font-bold muted2">‡∏£‡∏≤‡∏Ñ‡∏≤ ${money(p.price)} ¬∑ ‡∏ó‡∏∏‡∏ô‡∏£‡∏ß‡∏° ${money(productCost(p))} ¬∑ ‡∏´‡∏ô‡πà‡∏ß‡∏¢ ${htmlesc(p.unit||"‡∏Å‡∏Å.")}</div>
          </div>
          <div class="flex items-center gap-2">
            <input class="input mono" style="width:120px" type="number" min="0" step="0.01" placeholder="‡∏à‡∏≥‡∏ô‡∏ß‡∏ô" id="sale_qty_${p.id}">
            <span class="muted2 text-xs font-black">${htmlesc(p.unit||"‡∏Å‡∏Å.")}</span>
          </div>
        </div>
      `;
    }).join("");

    openModal("‡∏≠‡∏≠‡∏Å‡∏ö‡∏¥‡∏•‡∏Ç‡∏≤‡∏¢‡πÉ‡∏´‡∏°‡πà", `
      <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
        <div>
          <div class="text-xs font-black muted2 mb-1">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</div>
          <input id="sale_date" class="input" type="date" value="${htmlesc(todayISO())}">
        </div>
        <div class="md:col-span-2">
          <div class="text-xs font-black muted2 mb-1">‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</div>
          <select id="sale_customer" class="input">
            ${customers.map(c=>`<option value="${c.id}">${htmlesc(c.name)}</option>`).join("")}
          </select>
        </div>
        <div class="md:col-span-3">
          <div class="text-xs font-black muted2 mb-1">‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏</div>
          <input id="sale_note" class="input" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏™‡πà‡∏á‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏¢‡πá‡∏ô / ‡πÄ‡∏Ñ‡∏£‡∏î‡∏¥‡∏ï 7 ‡∏ß‡∏±‡∏ô">
        </div>
      </div>

      <div class="mt-4">
        <div class="text-sm font-black">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</div>
        <div class="mt-2 grid grid-cols-1 gap-2 max-h-[340px] overflow-y-auto no-scrollbar pr-1">
          ${prodRows}
        </div>
        <div class="mt-3 text-xs font-bold muted2">
          * ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å snapshot ‡∏£‡∏≤‡∏Ñ‡∏≤/‡∏ï‡πâ‡∏ô‡∏ó‡∏∏‡∏ô ‡∏ì ‡∏ï‡∏≠‡∏ô‡∏Ç‡∏≤‡∏¢ ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏Å‡πà‡∏≤‡πÄ‡∏û‡∏µ‡πâ‡∏¢‡∏ô‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏Ñ‡∏∏‡∏ì‡∏õ‡∏£‡∏±‡∏ö‡∏£‡∏≤‡∏Ñ‡∏≤‡πÉ‡∏ô‡∏≠‡∏ô‡∏≤‡∏Ñ‡∏ï
        </div>
      </div>
    `, ()=>{
      const date = document.getElementById("sale_date").value;
      const customerId = document.getElementById("sale_customer").value;
      const note = (document.getElementById("sale_note").value||"").trim();
      if(!isISODate(date)) throw new Error("‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á");
      if(!customerId) throw new Error("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤");

      const items = [];
      for(const p of products){
        const qty = n(document.getElementById("sale_qty_"+p.id).value);
        if(qty>0){
          items.push({
            productId: p.id,
            qty,
            unit: p.unit || "‡∏Å‡∏Å.",
            priceAt: n(p.price),
            costAt: n(productCost(p))
          });
        }
      }
      if(items.length===0) throw new Error("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 1 ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£");

      const sale = {
        id: uid(),
        date,
        customerId,
        items,
        total: 0,
        paid: 0,
        status: "‡∏Ñ‡πâ‡∏≤‡∏á‡∏£‡∏±‡∏ö",
        note,
        createdAt: new Date().toISOString(),
        updatedAt: null
      };
      saleRecalc(sale);
      DB.sales.unshift(sale);
      saveDB();
      toast("‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ö‡∏¥‡∏•‡∏Ç‡∏≤‡∏¢‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢");
      setTab("sales");
    }, "‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ö‡∏¥‡∏•");
  }

  function editSale(id){
    const s = DB.sales.find(x=>x.id===id);
    if(!s) return;
    const customers = DB.customers.filter(c=>c.active!==false).sort((a,b)=>a.name.localeCompare(b.name));
    const products = DB.products.filter(p=>p.active!==false).sort((a,b)=>a.name.localeCompare(b.name));

    // Build existing items map by productId
    const map = new Map((s.items||[]).map(it=>[it.productId, it]));
    const prodRows = products.map(p=>{
      const it = map.get(p.id);
      const qtyVal = it ? it.qty : 0;
      return `
        <div class="glass2 rounded-2xl p-3 flex items-center justify-between gap-3">
          <div class="min-w-0">
            <div class="font-black truncate">${htmlesc(p.name)}</div>
            <div class="text-xs font-bold muted2">‡∏£‡∏≤‡∏Ñ‡∏≤ ${money(p.price)} (‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô) ¬∑ *‡∏ö‡∏¥‡∏•‡∏ô‡∏µ‡πâ‡πÄ‡∏Å‡πá‡∏ö‡∏£‡∏≤‡∏Ñ‡∏≤‡πÄ‡∏î‡∏¥‡∏°‡πÑ‡∏ß‡πâ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å*</div>
          </div>
          <div class="flex items-center gap-2">
            <input class="input mono" style="width:120px" type="number" min="0" step="0.01" value="${htmlesc(qtyVal)}" id="sale_qty_${p.id}">
            <span class="muted2 text-xs font-black">${htmlesc(p.unit||"‡∏Å‡∏Å.")}</span>
          </div>
        </div>
      `;
    }).join("");

    openModal("‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ö‡∏¥‡∏•‡∏Ç‡∏≤‡∏¢", `
      <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
        <div>
          <div class="text-xs font-black muted2 mb-1">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</div>
          <input id="sale_date" class="input" type="date" value="${htmlesc(s.date)}">
        </div>
        <div class="md:col-span-2">
          <div class="text-xs font-black muted2 mb-1">‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</div>
          <select id="sale_customer" class="input">
            ${customers.map(c=>`<option value="${c.id}" ${c.id===s.customerId?"selected":""}>${htmlesc(c.name)}</option>`).join("")}
          </select>
        </div>
        <div class="md:col-span-3">
          <div class="text-xs font-black muted2 mb-1">‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏</div>
          <input id="sale_note" class="input" value="${htmlesc(s.note||"")}">
        </div>
      </div>

      <div class="mt-4">
        <div class="text-sm font-black">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ (‡∏õ‡∏£‡∏±‡∏ö‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÑ‡∏î‡πâ)</div>
        <div class="mt-2 grid grid-cols-1 gap-2 max-h-[340px] overflow-y-auto no-scrollbar pr-1">
          ${prodRows}
        </div>
        <div class="mt-3 grid grid-cols-1 md:grid-cols-3 gap-3">
          <div><div class="text-xs font-black muted2 mb-1">‡∏¢‡∏≠‡∏î‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô (Paid)</div><input id="sale_paid" class="input mono" type="number" value="${htmlesc(s.paid)}"></div>
          <div class="md:col-span-2 glass2 rounded-2xl p-4">
            <div class="text-xs font-black muted2">‡∏™‡∏£‡∏∏‡∏õ‡∏ö‡∏¥‡∏•</div>
            <div class="text-lg font-black mono mt-1">‡∏¢‡∏≠‡∏î‡∏ö‡∏¥‡∏•: <span id="sale_total_preview">${money(s.total)}</span> ¬∑ ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞: <span id="sale_status_preview">${htmlesc(s.status)}</span></div>
            <div class="text-xs font-bold muted2 mt-1">* ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏¢‡∏≠‡∏î‡πÉ‡∏´‡∏°‡πà‡∏à‡∏≤‡∏Å‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç (‡∏¢‡∏±‡∏á‡∏Ñ‡∏á snapshot priceAt/costAt ‡πÄ‡∏î‡∏¥‡∏°‡∏Ç‡∏≠‡∏á‡∏ö‡∏¥‡∏• ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà)</div>
          </div>
        </div>
      </div>
    `, ()=>{
      const date = document.getElementById("sale_date").value;
      const customerId = document.getElementById("sale_customer").value;
      const note = (document.getElementById("sale_note").value||"").trim();
      const paid = n(document.getElementById("sale_paid").value);
      if(!isISODate(date)) throw new Error("‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á");

      // Rebuild items: keep old priceAt/costAt for existing; for new add snapshot from current product
      const newItems = [];
      for(const p of products){
        const qty = n(document.getElementById("sale_qty_"+p.id).value);
        if(qty>0){
          const old = map.get(p.id);
          newItems.push({
            productId: p.id,
            qty,
            unit: p.unit || "‡∏Å‡∏Å.",
            priceAt: old ? n(old.priceAt) : n(p.price),
            costAt: old ? n(old.costAt) : n(productCost(p))
          });
        }
      }
      if(newItems.length===0) throw new Error("‡∏ö‡∏¥‡∏•‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 1 ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤");

      s.date = date;
      s.customerId = customerId;
      s.note = note;
      s.items = newItems;
      s.paid = paid;
      saleRecalc(s);
      saveDB();
      toast("‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ö‡∏¥‡∏•‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢");
      render();
    }, "‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å");
  }

  function receiveMoney(id){
    const s = DB.sales.find(x=>x.id===id);
    if(!s) return;
    const due = Math.max(0, n(s.total)-n(s.paid));
    const amt = prompt("‡∏£‡∏±‡∏ö‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏û‡∏¥‡πà‡∏° (‡∏ö‡∏≤‡∏ó):", due>0? String(due) : "0");
    if(amt===null) return;
    const add = n(amt);
    if(add<=0) { toast("‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏¢‡∏≠‡∏î‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô"); return; }
    s.paid = n(s.paid) + add;
    saleRecalc(s);
    saveDB();
    toast("‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢");
    render();
  }

  function deleteSale(id){
    if(!confirm("‡∏•‡∏ö‡∏ö‡∏¥‡∏•‡∏ô‡∏µ‡πâ‡πÉ‡∏ä‡πà‡πÑ‡∏´‡∏°? (‡∏ñ‡πâ‡∏≤‡∏•‡∏ö‡∏à‡∏∞‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ)")) return;
    const idx = DB.sales.findIndex(x=>x.id===id);
    if(idx>=0){
      DB.sales.splice(idx,1);
      saveDB();
      toast("‡∏•‡∏ö‡∏ö‡∏¥‡∏•‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢");
      render();
    }
  }

  /********** Purchase Orders **********/
  function pagePO(){
    const q = state.search.po.trim().toLowerCase();
    const {start,end} = state.range;

    const rows = DB.purchaseOrders
      .filter(po=>isISODate(po.date))
      .filter(po=>inRange(po.date,start,end))
      .filter(po=>{
        if(!q) return true;
        return (po.supplierName||"").toLowerCase().includes(q) || String(po.id).toLowerCase().includes(q) || (po.status||"").toLowerCase().includes(q);
      })
      .sort((a,b)=> new Date(b.date)-new Date(a.date))
      .map(po=>{
        const due = Math.max(0, n(po.total)-n(po.paid));
        return `<tr>
          <td>
            <div class="font-black">${htmlesc(po.supplierName||"(‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏‡∏ú‡∏π‡πâ‡∏Ç‡∏≤‡∏¢)")} <span class="muted2 text-xs font-black">#${htmlesc(po.id)}</span></div>
            <div class="text-xs font-bold muted2">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà ${htmlesc(po.date)} ¬∑ ${badge(po.status)}</div>
            <div class="text-xs font-bold muted2">${htmlesc(po.note||"")}</div>
          </td>
          <td class="mono font-black">${money(po.total)}</td>
          <td class="mono">${money(po.paid)}</td>
          <td>${due>0 ? `<span class="chip chip-warn">‡∏Ñ‡πâ‡∏≤‡∏á ${money(due)}</span>` : `<span class="chip chip-good">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ñ‡πâ‡∏≤‡∏á</span>`}</td>
          <td class="no-print">
            <div class="flex gap-2 flex-wrap">
              <button class="btn btn-dark" onclick="editPO('${po.id}')">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button>
              <button class="btn btn-warn" onclick="payPO('${po.id}')">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏à‡πà‡∏≤‡∏¢</button>
              <button class="btn btn-dark" onclick="printDoc('po','${po.id}')">‡∏û‡∏¥‡∏°‡∏û‡πå PDF</button>
              <button class="btn btn-danger" onclick="deletePO('${po.id}')">‡∏•‡∏ö</button>
            </div>
          </td>
        </tr>`;
      }).join("") || `<tr><td colspan="5" class="muted font-bold">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ PO ‡πÉ‡∏ô‡∏ä‡πà‡∏ß‡∏á‡∏ô‡∏µ‡πâ</td></tr>`;

    const content = `
      <div class="glass rounded-3xl p-5 md:p-7 soft-shadow">
        ${pageHeader("‡πÉ‡∏ö‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠ (PO)", "‡∏™‡∏£‡πâ‡∏≤‡∏á/‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç PO ¬∑ ‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡∏Ñ‡πâ‡∏≤‡∏á‡∏à‡πà‡∏≤‡∏¢ ¬∑ ‡∏û‡∏¥‡∏°‡∏û‡πå PDF ‡∏£‡∏≤‡∏¢‡πÉ‡∏ö ¬∑ ‡∏Å‡∏£‡∏≠‡∏á‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤",
          `<button class="btn btn-primary" onclick="openQuickPO()">+ ‡∏ó‡∏≥ PO ‡πÉ‡∏´‡∏°‡πà</button>`
        )}

        <div class="mt-5 grid grid-cols-1 md:grid-cols-3 gap-3 no-print">
          <div class="md:col-span-2">
            <div class="text-xs font-black muted2 mb-2">‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ (‡∏ú‡∏π‡πâ‡∏Ç‡∏≤‡∏¢/‡∏£‡∏´‡∏±‡∏™/‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞)</div>
            <input class="input" placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤..." value="${htmlesc(state.search.po)}"
              oninput="state.search.po=this.value; render()">
          </div>
          <div>
            <div class="text-xs font-black muted2 mb-2">‡∏¢‡∏≠‡∏î‡∏Ñ‡πâ‡∏≤‡∏á‡∏à‡πà‡∏≤‡∏¢ (‡πÉ‡∏ô‡∏ä‡πà‡∏ß‡∏á)</div>
            <div class="glass2 rounded-2xl p-4 font-black mono">${money(sum(DB.purchaseOrders.filter(po=>isISODate(po.date)&&inRange(po.date,start,end)), po=>Math.max(0,n(po.total)-n(po.paid))))}</div>
          </div>
        </div>

        <div class="mt-5 overflow-x-auto">
          <table class="table">
            <thead><tr><th>PO</th><th>‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°</th><th>‡∏à‡πà‡∏≤‡∏¢‡πÅ‡∏•‡πâ‡∏ß</th><th>‡∏Ñ‡πâ‡∏≤‡∏á‡∏à‡πà‡∏≤‡∏¢</th><th class="no-print">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th></tr></thead>
            <tbody>${rows}</tbody>
          </table>
        </div>
      </div>
    `;
    return content;
  }

  function openQuickPO(){
    openModal("‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÉ‡∏ö‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠ (PO) ‡πÉ‡∏´‡∏°‡πà", `
      <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
        <div><div class="text-xs font-black muted2 mb-1">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</div><input id="po_date" class="input" type="date" value="${htmlesc(todayISO())}"></div>
        <div><div class="text-xs font-black muted2 mb-1">‡∏ú‡∏π‡πâ‡∏Ç‡∏≤‡∏¢/‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤ *</div><input id="po_supplier" class="input" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡πÅ‡∏°‡πá‡∏Ñ‡πÇ‡∏Ñ‡∏£ / ‡∏£‡πâ‡∏≤‡∏ô‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡∏î‡∏¥‡∏ö"></div>
        <div class="md:col-span-2"><div class="text-xs font-black muted2 mb-1">‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏</div><input id="po_note" class="input" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏£‡∏≠‡∏ö‡∏™‡πà‡∏á 10:00 ‡∏ô."></div>
      </div>

      <div class="mt-4">
        <div class="text-sm font-black">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÉ‡∏ô PO</div>
        <div id="po_items" class="mt-2 space-y-2"></div>
        <div class="mt-3 flex gap-2">
          <button class="btn btn-dark" onclick="addPOItemRow()">+ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</button>
          <div class="ml-auto glass2 rounded-2xl px-4 py-3 font-black mono">‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°: <span id="po_total_preview">‡∏ø0</span></div>
        </div>
        <div class="text-xs font-bold muted2 mt-2">* ‡∏û‡∏¥‡∏°‡∏û‡πå PO ‡∏£‡∏≤‡∏¢‡πÉ‡∏ö‡πÑ‡∏î‡πâ‡∏à‡∏≤‡∏Å‡∏õ‡∏∏‡πà‡∏° ‚Äú‡∏û‡∏¥‡∏°‡∏û‡πå PDF‚Äù ‡πÉ‡∏ô‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ PO</div>
      </div>
    `, ()=>{
      const date = document.getElementById("po_date").value;
      const supplierName = (document.getElementById("po_supplier").value||"").trim();
      const note = (document.getElementById("po_note").value||"").trim();
      if(!isISODate(date)) throw new Error("‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á");
      if(!supplierName) throw new Error("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏‡∏ú‡∏π‡πâ‡∏Ç‡∏≤‡∏¢/‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤");

      const items = readPOItemsFromModal();
      if(items.length===0) throw new Error("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 1 ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£");

      const po = {
        id: uid(),
        date,
        supplierName,
        note,
        items,
        total: 0,
        paid: 0,
        status: "‡∏Ñ‡πâ‡∏≤‡∏á‡∏à‡πà‡∏≤‡∏¢",
        createdAt: new Date().toISOString(),
        updatedAt: null
      };
      poRecalc(po);
      DB.purchaseOrders.unshift(po);
      saveDB();
      toast("‡∏™‡∏£‡πâ‡∏≤‡∏á PO ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢");
      setTab("po");
    }, "‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å PO");

    // init first row
    setTimeout(()=>{
      addPOItemRow();
      addPOItemRow();
      recalcPOTotalPreview();
    }, 0);
  }

  function addPOItemRow(prefill=null){
    const wrap = document.getElementById("po_items");
    if(!wrap) return;
    const rid = uid();
    const name = prefill?.name || "";
    const qty = prefill?.qty ?? "";
    const unit = prefill?.unit || "‡∏´‡∏ô‡πà‡∏ß‡∏¢";
    const price = prefill?.price ?? "";
    const row = document.createElement("div");
    row.className = "glass2 rounded-2xl p-3 grid grid-cols-1 md:grid-cols-12 gap-2 items-end";
    row.dataset.rid = rid;
    row.innerHTML = `
      <div class="md:col-span-5">
        <div class="text-[11px] font-black muted2 mb-1">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ *</div>
        <input class="input" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏ô‡πâ‡∏≥‡∏õ‡∏•‡∏≤/‡∏ô‡πâ‡∏≥‡∏ï‡∏≤‡∏•/‡∏û‡∏£‡∏¥‡∏Å" value="${htmlesc(name)}" data-f="name" oninput="recalcPOTotalPreview()">
      </div>
      <div class="md:col-span-2">
        <div class="text-[11px] font-black muted2 mb-1">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô *</div>
        <input class="input mono" type="number" step="0.01" value="${htmlesc(qty)}" data-f="qty" oninput="recalcPOTotalPreview()">
      </div>
      <div class="md:col-span-2">
        <div class="text-[11px] font-black muted2 mb-1">‡∏´‡∏ô‡πà‡∏ß‡∏¢</div>
        <input class="input" value="${htmlesc(unit)}" data-f="unit">
      </div>
      <div class="md:col-span-2">
        <div class="text-[11px] font-black muted2 mb-1">‡∏£‡∏≤‡∏Ñ‡∏≤/‡∏´‡∏ô‡πà‡∏ß‡∏¢ *</div>
        <input class="input mono" type="number" step="0.01" value="${htmlesc(price)}" data-f="price" oninput="recalcPOTotalPreview()">
      </div>
      <div class="md:col-span-1 flex justify-end">
        <button class="btn btn-danger" style="padding:.6rem .8rem" onclick="this.closest('[data-rid]').remove(); recalcPOTotalPreview()">‡∏•‡∏ö</button>
      </div>
    `;
    wrap.appendChild(row);
  }

  function readPOItemsFromModal(){
    const wrap = document.getElementById("po_items");
    if(!wrap) return [];
    const rows = [...wrap.querySelectorAll("[data-rid]")];
    const items = [];
    for(const r of rows){
      const get = (f)=> r.querySelector(`[data-f="${f}"]`)?.value ?? "";
      const name = (get("name")||"").trim();
      const qty = n(get("qty"));
      const unit = (get("unit")||"").trim() || "‡∏´‡∏ô‡πà‡∏ß‡∏¢";
      const price = n(get("price"));
      if(name && qty>0 && price>=0){
        items.push({name, qty, unit, price});
      }
    }
    return items;
  }

  function recalcPOTotalPreview(){
    const items = readPOItemsFromModal();
    const total = sum(items, it=>it.qty*it.price);
    const el = document.getElementById("po_total_preview");
    if(el) el.textContent = money(total);
  }

  function editPO(id){
    const po = DB.purchaseOrders.find(x=>x.id===id);
    if(!po) return;
    openModal("‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç PO", `
      <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
        <div><div class="text-xs font-black muted2 mb-1">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</div><input id="po_date" class="input" type="date" value="${htmlesc(po.date)}"></div>
        <div><div class="text-xs font-black muted2 mb-1">‡∏ú‡∏π‡πâ‡∏Ç‡∏≤‡∏¢/‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤ *</div><input id="po_supplier" class="input" value="${htmlesc(po.supplierName||"")}"></div>
        <div class="md:col-span-2"><div class="text-xs font-black muted2 mb-1">‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏</div><input id="po_note" class="input" value="${htmlesc(po.note||"")}"></div>
      </div>

      <div class="mt-4">
        <div class="text-sm font-black">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</div>
        <div id="po_items" class="mt-2 space-y-2"></div>
        <div class="mt-3 flex gap-2">
          <button class="btn btn-dark" onclick="addPOItemRow()">+ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</button>
          <div class="ml-auto grid grid-cols-1 md:grid-cols-3 gap-2 items-end">
            <div>
              <div class="text-[11px] font-black muted2 mb-1">‡∏¢‡∏≠‡∏î‡∏à‡πà‡∏≤‡∏¢‡πÅ‡∏•‡πâ‡∏ß</div>
              <input id="po_paid" class="input mono" type="number" step="0.01" value="${htmlesc(po.paid)}">
            </div>
            <div class="glass2 rounded-2xl px-4 py-3 font-black mono md:col-span-2">‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°: <span id="po_total_preview">${money(po.total)}</span> ¬∑ ${badge(po.status)}</div>
          </div>
        </div>
      </div>
    `, ()=>{
      const date = document.getElementById("po_date").value;
      const supplierName = (document.getElementById("po_supplier").value||"").trim();
      const note = (document.getElementById("po_note").value||"").trim();
      const paid = n(document.getElementById("po_paid").value);
      if(!isISODate(date)) throw new Error("‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á");
      if(!supplierName) throw new Error("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏‡∏ú‡∏π‡πâ‡∏Ç‡∏≤‡∏¢/‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤");
      const items = readPOItemsFromModal();
      if(items.length===0) throw new Error("PO ‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 1 ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£");

      po.date = date;
      po.supplierName = supplierName;
      po.note = note;
      po.items = items;
      po.paid = paid;
      poRecalc(po);
      saveDB();
      toast("‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç PO ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢");
      render();
    }, "‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å");

    setTimeout(()=>{
      // prefill rows
      (po.items||[]).forEach(it=>addPOItemRow(it));
      if((po.items||[]).length===0) addPOItemRow();
      recalcPOTotalPreview();
    },0);
  }

  function payPO(id){
    const po = DB.purchaseOrders.find(x=>x.id===id);
    if(!po) return;
    const due = Math.max(0, n(po.total)-n(po.paid));
    const amt = prompt("‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏à‡πà‡∏≤‡∏¢‡πÄ‡∏û‡∏¥‡πà‡∏° (‡∏ö‡∏≤‡∏ó):", due>0? String(due) : "0");
    if(amt===null) return;
    const add = n(amt);
    if(add<=0){ toast("‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏¢‡∏≠‡∏î‡∏à‡πà‡∏≤‡∏¢"); return; }
    po.paid = n(po.paid) + add;
    poRecalc(po);
    saveDB();
    toast("‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏à‡πà‡∏≤‡∏¢ PO ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢");
    render();
  }

  function deletePO(id){
    if(!confirm("‡∏•‡∏ö PO ‡∏ô‡∏µ‡πâ‡πÉ‡∏ä‡πà‡πÑ‡∏´‡∏°? (‡∏ñ‡πâ‡∏≤‡∏•‡∏ö‡∏à‡∏∞‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ)")) return;
    const idx = DB.purchaseOrders.findIndex(x=>x.id===id);
    if(idx>=0){
      DB.purchaseOrders.splice(idx,1);
      saveDB();
      toast("‡∏•‡∏ö PO ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢");
      render();
    }
  }

  /********** Expenses & Vouchers **********/
  const EXP_CATS = ["‡∏Ñ‡πà‡∏≤‡πÅ‡∏£‡∏á","‡∏Ñ‡πà‡∏≤‡∏ö‡∏±‡∏ç‡∏ä‡∏µ","‡∏Ñ‡πà‡∏≤‡πÑ‡∏ü","‡∏Ñ‡πà‡∏≤‡∏™‡πà‡∏á","‡∏Ñ‡πà‡∏≤‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡∏î‡∏¥‡∏ö‡πÄ‡∏™‡∏£‡∏¥‡∏°","‡∏≠‡∏∑‡πà‡∏ô‡πÜ"];

  function pageExpenses(){
    const q = state.search.expense.trim().toLowerCase();
    const {start,end} = state.range;

    const list = DB.expenses
      .filter(e=>isISODate(e.date))
      .filter(e=>inRange(e.date,start,end))
      .filter(e=>{
        if(!q) return true;
        return (e.category||"").toLowerCase().includes(q) || (e.note||"").toLowerCase().includes(q) || String(e.amount).includes(q);
      })
      .sort((a,b)=> new Date(b.date)-new Date(a.date));

    const total = sum(list, e=>e.amount);

    const rows = list.map(e=>{
      return `<tr>
        <td class="mono font-black">${htmlesc(e.date)}</td>
        <td><span class="chip">${htmlesc(e.category||"")}</span></td>
        <td class="mono font-black">${money(e.amount)}</td>
        <td class="muted2 font-bold">${htmlesc(e.note||"")}</td>
        <td class="no-print">
          <div class="flex gap-2 flex-wrap">
            <button class="btn btn-dark" onclick="editExpense('${e.id}')">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button>
            <button class="btn btn-dark" onclick="printDoc('expense','${e.id}')">‡∏û‡∏¥‡∏°‡∏û‡πå PDF</button>
            <button class="btn btn-danger" onclick="deleteExpense('${e.id}')">‡∏•‡∏ö</button>
          </div>
        </td>
      </tr>`;
    }).join("") || `<tr><td colspan="5" class="muted font-bold">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢‡πÉ‡∏ô‡∏ä‡πà‡∏ß‡∏á‡∏ô‡∏µ‡πâ</td></tr>`;

    const content = `
      <div class="glass rounded-3xl p-5 md:p-7 soft-shadow">
        ${pageHeader("‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢ / ‡πÉ‡∏ö‡πÄ‡∏ö‡∏¥‡∏Å", "‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢ ¬∑ ‡πÅ‡∏¢‡∏Å‡∏´‡∏°‡∏ß‡∏î ¬∑ ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤ ¬∑ ‡∏ó‡∏≥‡πÉ‡∏ö‡πÄ‡∏ö‡∏¥‡∏Å/‡∏û‡∏¥‡∏°‡∏û‡πå PDF",
          `<button class="btn btn-primary" onclick="openQuickExpense()">+ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢</button>
           <button class="btn btn-dark" onclick="openVoucherBuilder()">‡∏ó‡∏≥‡πÉ‡∏ö‡πÄ‡∏ö‡∏¥‡∏Å‡∏ï‡∏≤‡∏°‡∏ä‡πà‡∏ß‡∏á</button>`
        )}

        <div class="mt-5 grid grid-cols-1 md:grid-cols-3 gap-3 no-print">
          <div class="md:col-span-2">
            <div class="text-xs font-black muted2 mb-2">‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ (‡∏´‡∏°‡∏ß‡∏î/‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏/‡∏¢‡∏≠‡∏î)</div>
            <input class="input" placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤..." value="${htmlesc(state.search.expense)}"
              oninput="state.search.expense=this.value; render()">
          </div>
          <div>
            <div class="text-xs font-black muted2 mb-2">‡∏£‡∏ß‡∏°‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢ (‡πÉ‡∏ô‡∏ä‡πà‡∏ß‡∏á)</div>
            <div class="glass2 rounded-2xl p-4 font-black mono">${money(total)}</div>
          </div>
        </div>

        <div class="mt-5 overflow-x-auto">
          <table class="table">
            <thead><tr><th>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</th><th>‡∏´‡∏°‡∏ß‡∏î</th><th>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô</th><th>‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î</th><th class="no-print">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th></tr></thead>
            <tbody>${rows}</tbody>
          </table>
        </div>
      </div>
    `;
    return content;
  }

  function openQuickExpense(){
    openModal("‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢", `
      <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
        <div><div class="text-xs font-black muted2 mb-1">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</div><input id="ex_date" class="input" type="date" value="${htmlesc(todayISO())}"></div>
        <div><div class="text-xs font-black muted2 mb-1">‡∏´‡∏°‡∏ß‡∏î</div>
          <select id="ex_cat" class="input">
            ${EXP_CATS.map(c=>`<option value="${htmlesc(c)}">${htmlesc(c)}</option>`).join("")}
          </select>
        </div>
        <div><div class="text-xs font-black muted2 mb-1">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô *</div><input id="ex_amt" class="input mono" type="number" step="0.01" value="0"></div>
        <div><div class="text-xs font-black muted2 mb-1">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î</div><input id="ex_note" class="input" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏Ñ‡πà‡∏≤‡πÅ‡∏£‡∏á‡∏ú‡∏•‡∏¥‡∏ï‡∏£‡∏≠‡∏ö‡πÄ‡∏î‡∏∑‡∏≠‡∏ô"></div>
      </div>
    `, ()=>{
      const date = document.getElementById("ex_date").value;
      const category = document.getElementById("ex_cat").value;
      const amount = n(document.getElementById("ex_amt").value);
      const note = (document.getElementById("ex_note").value||"").trim();
      if(!isISODate(date)) throw new Error("‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á");
      if(amount<=0) throw new Error("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô‡∏°‡∏≤‡∏Å‡∏Å‡∏ß‡πà‡∏≤ 0");
      DB.expenses.unshift({
        id:uid(), date, category, amount, note,
        createdAt:new Date().toISOString(), updatedAt:null
      });
      saveDB(); toast("‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢"); setTab("expenses");
    }, "‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å");
  }

  function editExpense(id){
    const e = DB.expenses.find(x=>x.id===id);
    if(!e) return;
    openModal("‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢", `
      <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
        <div><div class="text-xs font-black muted2 mb-1">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</div><input id="ex_date" class="input" type="date" value="${htmlesc(e.date)}"></div>
        <div><div class="text-xs font-black muted2 mb-1">‡∏´‡∏°‡∏ß‡∏î</div>
          <select id="ex_cat" class="input">
            ${EXP_CATS.map(c=>`<option value="${htmlesc(c)}" ${c===e.category?"selected":""}>${htmlesc(c)}</option>`).join("")}
          </select>
        </div>
        <div><div class="text-xs font-black muted2 mb-1">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô *</div><input id="ex_amt" class="input mono" type="number" step="0.01" value="${htmlesc(e.amount)}"></div>
        <div><div class="text-xs font-black muted2 mb-1">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î</div><input id="ex_note" class="input" value="${htmlesc(e.note||"")}"></div>
      </div>
    `, ()=>{
      const date = document.getElementById("ex_date").value;
      const category = document.getElementById("ex_cat").value;
      const amount = n(document.getElementById("ex_amt").value);
      const note = (document.getElementById("ex_note").value||"").trim();
      if(!isISODate(date)) throw new Error("‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á");
      if(amount<=0) throw new Error("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô‡∏°‡∏≤‡∏Å‡∏Å‡∏ß‡πà‡∏≤ 0");
      e.date = date; e.category = category; e.amount = amount; e.note = note;
      e.updatedAt = new Date().toISOString();
      saveDB(); toast("‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢"); render();
    }, "‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å");
  }

  function deleteExpense(id){
    if(!confirm("‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢‡∏ô‡∏µ‡πâ‡πÉ‡∏ä‡πà‡πÑ‡∏´‡∏°? (‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ)")) return;
    const idx = DB.expenses.findIndex(x=>x.id===id);
    if(idx>=0){
      DB.expenses.splice(idx,1);
      saveDB(); toast("‡∏•‡∏ö‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢"); render();
    }
  }

  function openVoucherBuilder(){
    const {start,end} = state.range;
    // build category checkboxes
    const checks = EXP_CATS.map(c=>`
      <label class="glass2 rounded-2xl p-3 flex items-center gap-3 cursor-pointer">
        <input type="checkbox" class="accent-blue-500" data-vcat="${htmlesc(c)}" checked>
        <div class="font-black">${htmlesc(c)}</div>
      </label>
    `).join("");

    openModal("‡∏ó‡∏≥‡πÉ‡∏ö‡πÄ‡∏ö‡∏¥‡∏Å‡∏ï‡∏≤‡∏°‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤ (‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏°‡∏ß‡∏î‡πÑ‡∏î‡πâ)", `
      <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
        <div><div class="text-xs font-black muted2 mb-1">‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</div><input id="v_start" class="input" type="date" value="${htmlesc(start)}"></div>
        <div><div class="text-xs font-black muted2 mb-1">‡∏ñ‡∏∂‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</div><input id="v_end" class="input" type="date" value="${htmlesc(end)}"></div>
        <div class="md:col-span-2"><div class="text-xs font-black muted2 mb-2">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏°‡∏ß‡∏î‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏ó‡∏≥‡πÉ‡∏ö‡πÄ‡∏ö‡∏¥‡∏Å</div>
          <div class="grid grid-cols-1 md:grid-cols-3 gap-2">${checks}</div>
        </div>
        <div class="md:col-span-2"><div class="text-xs font-black muted2 mb-1">‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡πÉ‡∏ö‡πÄ‡∏ö‡∏¥‡∏Å</div><input id="v_title" class="input" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡πÉ‡∏ö‡πÄ‡∏ö‡∏¥‡∏Å‡∏Ñ‡πà‡∏≤‡πÅ‡∏£‡∏á‡∏ú‡∏•‡∏¥‡∏ï‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡πÄ‡∏î‡∏∑‡∏≠‡∏ô"></div>
        <div class="md:col-span-2"><div class="text-xs font-black muted2 mb-1">‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏</div><input id="v_note" class="input" placeholder=""></div>

        <div class="md:col-span-2 glass2 rounded-3xl p-4">
          <div class="text-sm font-black">‡∏û‡∏£‡∏µ‡∏ß‡∏¥‡∏ß</div>
          <div class="text-xs font-bold muted2 mt-1">‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏Å‡∏î ‚Äú‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÉ‡∏ö‡πÄ‡∏ö‡∏¥‡∏Å‚Äù ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£ (‡∏û‡∏¥‡∏°‡∏û‡πå‡πÄ‡∏õ‡πá‡∏ô PDF ‡πÑ‡∏î‡πâ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ) ‡πÅ‡∏•‡∏∞‡πÑ‡∏°‡πà‡∏Å‡∏£‡∏∞‡∏ó‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏î‡∏¥‡∏°</div>
        </div>
      </div>
    `, ()=>{
      const s = document.getElementById("v_start").value;
      const e = document.getElementById("v_end").value;
      const title = (document.getElementById("v_title").value||"").trim() || "‡πÉ‡∏ö‡πÄ‡∏ö‡∏¥‡∏Å‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢";
      const note = (document.getElementById("v_note").value||"").trim();
      if(!isISODate(s)||!isISODate(e)) throw new Error("‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á");
      const cats = [...document.querySelectorAll("[data-vcat]")].filter(x=>x.checked).map(x=>x.dataset.vcat);
      if(cats.length===0) throw new Error("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 1 ‡∏´‡∏°‡∏ß‡∏î");

      // create virtual doc and print immediately
      const list = DB.expenses.filter(x=>x && isISODate(x.date) && inRange(x.date,s,e) && cats.includes(x.category));
      const total = sum(list, x=>x.amount);

      printHTML(buildVoucherHTML({title, note, start:s, end:e, cats, list, total}));
      toast("‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÉ‡∏ö‡πÄ‡∏ö‡∏¥‡∏Å‡πÅ‡∏•‡∏∞‡πÄ‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏û‡∏¥‡∏°‡∏û‡πå‡πÅ‡∏•‡πâ‡∏ß");
    }, "‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÉ‡∏ö‡πÄ‡∏ö‡∏¥‡∏Å");
  }

  /********** Shareholders & Profit **********/
  function pageShareholders(){
    const q = state.search.shareholder.trim().toLowerCase();
    const active = DB.shareholders.filter(s=>s.active!==false).filter(s=> !q || (s.name||"").toLowerCase().includes(q));
    const totalInvest = sum(active, s=>s.investedAmount);
    const percRows = active
      .sort((a,b)=> (b.investedAmount||0)-(a.investedAmount||0))
      .map(s=>{
        const pct = totalInvest>0 ? (n(s.investedAmount)/totalInvest)*100 : 0;
        return `<tr>
          <td>
            <div class="font-black">${htmlesc(s.name)}</div>
            <div class="text-xs font-bold muted2">${htmlesc(s.note||"")}</div>
          </td>
          <td class="mono font-black">${money(s.investedAmount)}</td>
          <td class="mono font-black">${pct.toFixed(2)}%</td>
          <td class="no-print">
            <div class="flex gap-2 flex-wrap">
              <button class="btn btn-dark" onclick="editShareholder('${s.id}')">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button>
              <button class="btn btn-danger" onclick="deactivateShareholder('${s.id}')">‡∏•‡∏ö/‡∏õ‡∏¥‡∏î</button>
            </div>
          </td>
        </tr>`;
      }).join("") || `<tr><td colspan="4" class="muted font-bold">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ú‡∏π‡πâ‡∏ñ‡∏∑‡∏≠‡∏´‡∏∏‡πâ‡∏ô</td></tr>`;

    // Profit periods
    const {start,end} = state.range;
    const prof = calcProfit(start,end);
    const allocPending = sum(DB.profitPeriods.flatMap(pp=>pp.allocations||[]).filter(a=>a.status!=="‡∏£‡∏±‡∏ö‡πÅ‡∏•‡πâ‡∏ß"), a=>a.amount);

    const periodRows = DB.profitPeriods
      .slice()
      .sort((a,b)=> new Date(b.end)-new Date(a.end))
      .map(pp=>{
        const pending = sum((pp.allocations||[]).filter(a=>a.status!=="‡∏£‡∏±‡∏ö‡πÅ‡∏•‡πâ‡∏ß"), a=>a.amount);
        return `<tr>
          <td>
            <div class="font-black">${htmlesc(pp.start)} ‡∏ñ‡∏∂‡∏á ${htmlesc(pp.end)}</div>
            <div class="text-xs font-bold muted2">‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡πÄ‡∏°‡∏∑‡πà‡∏≠ ${htmlesc(pp.calculatedAt?.split("T")[0]||"")}</div>
          </td>
          <td class="mono font-black">${money(pp.profit)}</td>
          <td>${pending>0 ? `<span class="chip chip-warn">‡∏Ñ‡πâ‡∏≤‡∏á‡∏£‡∏±‡∏ö ${money(pending)}</span>` : `<span class="chip chip-good">‡∏õ‡∏¥‡∏î‡∏á‡∏ß‡∏î‡πÅ‡∏•‡πâ‡∏ß</span>`}</td>
          <td class="no-print">
            <div class="flex gap-2 flex-wrap">
              <button class="btn btn-dark" onclick="openProfitDetail('${pp.id}')">‡∏î‡∏π/‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</button>
              <button class="btn btn-dark" onclick="printDoc('profit','${pp.id}')">‡∏û‡∏¥‡∏°‡∏û‡πå PDF</button>
              <button class="btn btn-danger" onclick="deleteProfitPeriod('${pp.id}')">‡∏•‡∏ö</button>
            </div>
          </td>
        </tr>`;
      }).join("") || `<tr><td colspan="4" class="muted font-bold">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏á‡∏ß‡∏î‡∏Å‡∏≥‡πÑ‡∏£</td></tr>`;

    const content = `
      <div class="glass rounded-3xl p-5 md:p-7 soft-shadow">
        ${pageHeader("‡∏ú‡∏π‡πâ‡∏ñ‡∏∑‡∏≠‡∏´‡∏∏‡πâ‡∏ô & ‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏™‡∏£‡∏£‡∏Å‡∏≥‡πÑ‡∏£", "‡∏•‡∏á‡∏ó‡∏∏‡∏ô‡πÄ‡∏õ‡πá‡∏ô‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô ‚Üí ‡∏£‡∏∞‡∏ö‡∏ö‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏™‡∏±‡∏î‡∏™‡πà‡∏ß‡∏ô‡∏´‡∏∏‡πâ‡∏ô‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥ ¬∑ ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏Å‡∏≥‡πÑ‡∏£‡∏ï‡∏≤‡∏°‡∏ä‡πà‡∏ß‡∏á ¬∑ ‡∏à‡∏±‡∏î‡∏™‡∏£‡∏£/‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡∏Ñ‡πâ‡∏≤‡∏á‡∏£‡∏±‡∏ö",
          `<button class="btn btn-primary" onclick="addShareholder()">+ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ú‡∏π‡πâ‡∏ñ‡∏∑‡∏≠‡∏´‡∏∏‡πâ‡∏ô</button>
           <button class="btn btn-dark" onclick="createProfitPeriodFromRange()">‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏Å‡∏≥‡πÑ‡∏£‡∏ä‡πà‡∏ß‡∏á‡∏ô‡∏µ‡πâ ‚Üí ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏á‡∏ß‡∏î</button>`
        )}

        <div class="mt-6 grid grid-cols-1 md:grid-cols-2 xl:grid-cols-4 gap-4">
          ${kpi("‡πÄ‡∏á‡∏¥‡∏ô‡∏•‡∏á‡∏ó‡∏∏‡∏ô‡∏£‡∏ß‡∏°", shortMoney(totalInvest), "‡∏£‡∏ß‡∏°‡∏ú‡∏π‡πâ‡∏ñ‡∏∑‡∏≠‡∏´‡∏∏‡πâ‡∏ô Active", "pri")}
          ${kpi("‡∏Å‡∏≥‡πÑ‡∏£‡∏ä‡πà‡∏ß‡∏á‡∏ô‡∏µ‡πâ", shortMoney(prof.profit), "‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ - ‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢ (‡∏ï‡∏≤‡∏°‡∏ä‡πà‡∏ß‡∏á)", prof.profit>=0?"good":"bad")}
          ${kpi("‡∏Ñ‡πâ‡∏≤‡∏á‡∏£‡∏±‡∏ö‡∏õ‡∏±‡∏ô‡∏ú‡∏•", shortMoney(allocPending), "‡∏£‡∏ß‡∏°‡∏ó‡∏∏‡∏Å‡∏á‡∏ß‡∏î‡∏ó‡∏µ‡πà‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏£‡∏±‡∏ö", allocPending>0?"warn":"good")}
          ${kpi("‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ú‡∏π‡πâ‡∏ñ‡∏∑‡∏≠‡∏´‡∏∏‡πâ‡∏ô", String(active.length), "Active", "pri")}
        </div>

        <div class="mt-6 glass2 rounded-3xl p-5 no-print">
          <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
            <div class="md:col-span-2">
              <div class="text-xs font-black muted2 mb-2">‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ (‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏ñ‡∏∑‡∏≠‡∏´‡∏∏‡πâ‡∏ô)</div>
              <input class="input" placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤..." value="${htmlesc(state.search.shareholder)}"
                oninput="state.search.shareholder=this.value; render()">
            </div>
            <div>
              <div class="text-xs font-black muted2 mb-2">‡∏™‡∏±‡∏î‡∏™‡πà‡∏ß‡∏ô‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥</div>
              <div class="glass2 rounded-2xl p-4 text-sm font-black">‡∏ê‡∏≤‡∏ô: ‡πÄ‡∏á‡∏¥‡∏ô‡∏•‡∏á‡∏ó‡∏∏‡∏ô‡∏£‡∏ß‡∏°</div>
            </div>
          </div>
        </div>

        <div class="mt-5 overflow-x-auto">
          <table class="table">
            <thead><tr><th>‡∏ú‡∏π‡πâ‡∏ñ‡∏∑‡∏≠‡∏´‡∏∏‡πâ‡∏ô</th><th>‡πÄ‡∏á‡∏¥‡∏ô‡∏•‡∏á‡∏ó‡∏∏‡∏ô</th><th>‡∏™‡∏±‡∏î‡∏™‡πà‡∏ß‡∏ô</th><th class="no-print">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th></tr></thead>
            <tbody>${percRows}</tbody>
          </table>
        </div>

        <div class="mt-6 glass2 rounded-3xl p-5">
          <div class="flex items-end justify-between gap-3">
            <div>
              <div class="text-lg font-black">‡∏á‡∏ß‡∏î‡∏Å‡∏≥‡πÑ‡∏£ & ‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏ö‡∏õ‡∏±‡∏ô‡∏ú‡∏•</div>
              <div class="text-xs font-bold muted2">‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏á‡∏ß‡∏î ‚Üí ‡∏à‡∏±‡∏î‡∏™‡∏£‡∏£‡∏ï‡∏≤‡∏°‡∏™‡∏±‡∏î‡∏™‡πà‡∏ß‡∏ô ‡∏ì ‡∏ß‡∏±‡∏ô‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì ‚Üí ‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡∏£‡∏±‡∏ö‡πÅ‡∏•‡πâ‡∏ß/‡∏Ñ‡πâ‡∏≤‡∏á‡∏£‡∏±‡∏ö/‡∏Ç‡πâ‡∏≤‡∏°‡∏õ‡∏µ</div>
            </div>
          </div>
          <div class="mt-4 overflow-x-auto">
            <table class="table">
              <thead><tr><th>‡∏á‡∏ß‡∏î</th><th>‡∏Å‡∏≥‡πÑ‡∏£‡∏™‡∏∏‡∏ó‡∏ò‡∏¥</th><th>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th><th class="no-print">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th></tr></thead>
              <tbody>${periodRows}</tbody>
            </table>
          </div>
        </div>
      </div>
    `;
    return content;
  }

  function addShareholder(){
    openModal("‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ú‡∏π‡πâ‡∏ñ‡∏∑‡∏≠‡∏´‡∏∏‡πâ‡∏ô", `
      <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
        <div><div class="text-xs font-black muted2 mb-1">‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏ñ‡∏∑‡∏≠‡∏´‡∏∏‡πâ‡∏ô *</div><input id="sh_name" class="input" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏ö‡∏µ / ‡∏Å‡∏•‡πâ‡∏ß‡∏¢ / ‡πÄ‡∏õ‡πâ"></div>
        <div><div class="text-xs font-black muted2 mb-1">‡πÄ‡∏á‡∏¥‡∏ô‡∏•‡∏á‡∏ó‡∏∏‡∏ô (‡∏ö‡∏≤‡∏ó) *</div><input id="sh_amt" class="input mono" type="number" step="0.01" value="0"></div>
        <div class="md:col-span-2"><div class="text-xs font-black muted2 mb-1">‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏</div><input id="sh_note" class="input" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏•‡∏á‡∏ó‡∏∏‡∏ô‡∏£‡∏≠‡∏ö‡πÅ‡∏£‡∏Å"></div>
      </div>
    `, ()=>{
      const name = (document.getElementById("sh_name").value||"").trim();
      const amt = n(document.getElementById("sh_amt").value);
      const note = (document.getElementById("sh_note").value||"").trim();
      if(!name) throw new Error("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏ñ‡∏∑‡∏≠‡∏´‡∏∏‡πâ‡∏ô");
      if(amt<=0) throw new Error("‡πÄ‡∏á‡∏¥‡∏ô‡∏•‡∏á‡∏ó‡∏∏‡∏ô‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏≤‡∏Å‡∏Å‡∏ß‡πà‡∏≤ 0");
      if(DB.shareholders.some(x=>x.active!==false && x.name===name)){
        throw new Error("‡∏°‡∏µ‡∏ú‡∏π‡πâ‡∏ñ‡∏∑‡∏≠‡∏´‡∏∏‡πâ‡∏ô‡∏ä‡∏∑‡πà‡∏≠‡∏ô‡∏µ‡πâ‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß");
      }
      DB.shareholders.push({
        id:uid(), name, active:true, investedAmount:amt, note,
        createdAt:new Date().toISOString(), updatedAt:null
      });
      saveDB(); toast("‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ú‡∏π‡πâ‡∏ñ‡∏∑‡∏≠‡∏´‡∏∏‡πâ‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢"); render();
    }, "‡πÄ‡∏û‡∏¥‡πà‡∏°");
  }

  function editShareholder(id){
    const s = DB.shareholders.find(x=>x.id===id);
    if(!s) return;
    openModal("‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ú‡∏π‡πâ‡∏ñ‡∏∑‡∏≠‡∏´‡∏∏‡πâ‡∏ô", `
      <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
        <div><div class="text-xs font-black muted2 mb-1">‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏ñ‡∏∑‡∏≠‡∏´‡∏∏‡πâ‡∏ô *</div><input id="sh_name" class="input" value="${htmlesc(s.name)}"></div>
        <div><div class="text-xs font-black muted2 mb-1">‡πÄ‡∏á‡∏¥‡∏ô‡∏•‡∏á‡∏ó‡∏∏‡∏ô (‡∏ö‡∏≤‡∏ó) *</div><input id="sh_amt" class="input mono" type="number" step="0.01" value="${htmlesc(s.investedAmount)}"></div>
        <div class="md:col-span-2"><div class="text-xs font-black muted2 mb-1">‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏</div><input id="sh_note" class="input" value="${htmlesc(s.note||"")}"></div>
      </div>
      <div class="mt-3 text-xs font-bold muted2">* ‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô‡∏•‡∏á‡∏ó‡∏∏‡∏ô‡∏à‡∏∞‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏™‡∏±‡∏î‡∏™‡πà‡∏ß‡∏ô‡∏´‡∏∏‡πâ‡∏ô ‚Äú‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô‚Äù ‡πÅ‡∏•‡∏∞‡∏à‡∏∞‡∏°‡∏µ‡∏ú‡∏•‡∏ï‡πà‡∏≠‡∏Å‡∏≤‡∏£‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏á‡∏ß‡∏î‡∏Å‡∏≥‡πÑ‡∏£‡πÉ‡∏´‡∏°‡πà‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô (‡∏á‡∏ß‡∏î‡πÄ‡∏Å‡πà‡∏≤‡∏à‡∏∞‡πÄ‡∏Å‡πá‡∏ö snapshot % ‡∏ì ‡∏ß‡∏±‡∏ô‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì)</div>
    `, ()=>{
      const name = (document.getElementById("sh_name").value||"").trim();
      const amt = n(document.getElementById("sh_amt").value);
      const note = (document.getElementById("sh_note").value||"").trim();
      if(!name) throw new Error("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏ñ‡∏∑‡∏≠‡∏´‡∏∏‡πâ‡∏ô");
      if(amt<=0) throw new Error("‡πÄ‡∏á‡∏¥‡∏ô‡∏•‡∏á‡∏ó‡∏∏‡∏ô‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏≤‡∏Å‡∏Å‡∏ß‡πà‡∏≤ 0");
      if(DB.shareholders.some(x=>x.id!==id && x.active!==false && x.name===name)){
        throw new Error("‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏ñ‡∏∑‡∏≠‡∏´‡∏∏‡πâ‡∏ô‡∏ã‡πâ‡∏≥");
      }
      s.name = name;
      s.investedAmount = amt;
      s.note = note;
      s.updatedAt = new Date().toISOString();
      saveDB(); toast("‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏ú‡∏π‡πâ‡∏ñ‡∏∑‡∏≠‡∏´‡∏∏‡πâ‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢"); render();
    }, "‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å");
  }

  function deactivateShareholder(id){
    const s = DB.shareholders.find(x=>x.id===id);
    if(!s) return;
    if(!confirm("‡∏õ‡∏¥‡∏î‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏ú‡∏π‡πâ‡∏ñ‡∏∑‡∏≠‡∏´‡∏∏‡πâ‡∏ô‡∏ô‡∏µ‡πâ‡πÉ‡∏ä‡πà‡πÑ‡∏´‡∏°?\n(‡∏á‡∏ß‡∏î‡πÄ‡∏Å‡πà‡∏≤‡∏à‡∏∞‡∏¢‡∏±‡∏á‡πÅ‡∏™‡∏î‡∏á‡πÑ‡∏î‡πâ ‡πÅ‡∏ï‡πà‡∏à‡∏∞‡πÑ‡∏°‡πà‡∏£‡∏ß‡∏°‡πÉ‡∏ô‡∏™‡∏±‡∏î‡∏™‡πà‡∏ß‡∏ô‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô)")) return;
    s.active = false;
    s.updatedAt = new Date().toISOString();
    saveDB(); toast("‡∏õ‡∏¥‡∏î‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏ú‡∏π‡πâ‡∏ñ‡∏∑‡∏≠‡∏´‡∏∏‡πâ‡∏ô‡πÅ‡∏•‡πâ‡∏ß"); render();
  }

  function createProfitPeriodFromRange(){
    const {start,end} = state.range;
    const prof = calcProfit(start,end);
    const {rows, totalInvest} = computeSharePercents();

    if(rows.length===0){
      toast("‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ú‡∏π‡πâ‡∏ñ‡∏∑‡∏≠‡∏´‡∏∏‡πâ‡∏ô: ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ú‡∏π‡πâ‡∏ñ‡∏∑‡∏≠‡∏´‡∏∏‡πâ‡∏ô‡∏Å‡πà‡∏≠‡∏ô");
      return;
    }

    const allocations = rows.map(s=>{
      const pct = totalInvest>0 ? (n(s.investedAmount)/totalInvest)*100 : 0;
      const amount = n(prof.profit) * (pct/100);
      return {
        id: uid(),
        shareholderId: s.id,
        percentAtCalc: pct,
        amount: amount,
        status: "‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏£‡∏±‡∏ö",
        receivedAt: null,
        note: ""
      };
    });

    const period = {
      id: uid(),
      start, end,
      revenue: prof.revenue,
      expense: prof.expense,
      profit: prof.profit,
      calculatedAt: new Date().toISOString(),
      allocations
    };

    DB.profitPeriods.unshift(period);
    saveDB();
    toast("‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏á‡∏ß‡∏î‡∏Å‡∏≥‡πÑ‡∏£‡πÅ‡∏•‡∏∞‡∏à‡∏±‡∏î‡∏™‡∏£‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢");
    render();
  }

  function openProfitDetail(id){
    const pp = DB.profitPeriods.find(x=>x.id===id);
    if(!pp) return;
    const allocRows = (pp.allocations||[]).map(a=>{
      const sh = DB.shareholders.find(s=>s.id===a.shareholderId) || {name:"(‡πÑ‡∏°‡πà‡∏û‡∏ö)"};
      const st = a.status || "‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏£‡∏±‡∏ö";
      const chip = st==="‡∏£‡∏±‡∏ö‡πÅ‡∏•‡πâ‡∏ß" ? "chip-good" : (st==="‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏£‡∏±‡∏ö" ? "chip-warn" : "chip-bad");
      return `
        <tr>
          <td class="font-black">${htmlesc(sh.name)}</td>
          <td class="mono">${a.percentAtCalc.toFixed(2)}%</td>
          <td class="mono font-black">${money(a.amount)}</td>
          <td><span class="chip ${chip}">${htmlesc(st)}</span></td>
          <td class="mono">${htmlesc(a.receivedAt||"‚Äî")}</td>
          <td class="no-print">
            <div class="flex gap-2 flex-wrap">
              <button class="btn btn-good" onclick="markDividendReceived('${pp.id}','${a.id}')">‡∏£‡∏±‡∏ö‡πÅ‡∏•‡πâ‡∏ß</button>
              <button class="btn btn-warn" onclick="markDividendPending('${pp.id}','${a.id}')">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏£‡∏±‡∏ö</button>
              <button class="btn btn-dark" onclick="editDividendNote('${pp.id}','${a.id}')">‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏</button>
            </div>
          </td>
        </tr>
      `;
    }).join("") || `<tr><td colspan="6" class="muted font-bold">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏™‡∏£‡∏£</td></tr>`;

    openModal("‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏á‡∏ß‡∏î‡∏Å‡∏≥‡πÑ‡∏£", `
      <div class="glass2 rounded-3xl p-5">
        <div class="flex items-end justify-between gap-3">
          <div>
            <div class="text-lg font-black">‡∏á‡∏ß‡∏î ${htmlesc(pp.start)} ‡∏ñ‡∏∂‡∏á ${htmlesc(pp.end)}</div>
            <div class="text-xs font-bold muted2">‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡πÄ‡∏°‡∏∑‡πà‡∏≠ ${htmlesc(pp.calculatedAt?.split("T")[0]||"")}</div>
          </div>
          <div class="text-right">
            <div class="text-xs font-black muted2">‡∏Å‡∏≥‡πÑ‡∏£‡∏™‡∏∏‡∏ó‡∏ò‡∏¥</div>
            <div class="text-2xl font-black mono">${money(pp.profit)}</div>
          </div>
        </div>
        <div class="mt-4 grid grid-cols-1 md:grid-cols-3 gap-3">
          <div class="glass2 rounded-2xl p-4">
            <div class="text-xs font-black muted2">‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ</div><div class="text-lg font-black mono">${money(pp.revenue)}</div>
          </div>
          <div class="glass2 rounded-2xl p-4">
            <div class="text-xs font-black muted2">‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢</div><div class="text-lg font-black mono">${money(pp.expense)}</div>
          </div>
          <div class="glass2 rounded-2xl p-4">
            <div class="text-xs font-black muted2">‡∏Å‡∏≥‡πÑ‡∏£</div><div class="text-lg font-black mono">${money(pp.profit)}</div>
          </div>
        </div>
      </div>

      <div class="mt-4 overflow-x-auto">
        <table class="table">
          <thead><tr><th>‡∏ú‡∏π‡πâ‡∏ñ‡∏∑‡∏≠‡∏´‡∏∏‡πâ‡∏ô</th><th>% ‡∏ì ‡∏ß‡∏±‡∏ô‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì</th><th>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô</th><th>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th><th>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏£‡∏±‡∏ö</th><th class="no-print">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th></tr></thead>
          <tbody>${allocRows}</tbody>
        </table>
      </div>

      <div class="mt-4 flex gap-2 justify-end no-print">
        <button class="btn btn-dark" onclick="printDoc('profit','${pp.id}')">‡∏û‡∏¥‡∏°‡∏û‡πå PDF</button>
      </div>
    `, ()=>{}, "‡∏õ‡∏¥‡∏î");
  }

  function markDividendReceived(periodId, allocId){
    const pp = DB.profitPeriods.find(x=>x.id===periodId);
    if(!pp) return;
    const a = (pp.allocations||[]).find(x=>x.id===allocId);
    if(!a) return;
    a.status = "‡∏£‡∏±‡∏ö‡πÅ‡∏•‡πâ‡∏ß";
    a.receivedAt = todayISO();
    saveDB(); toast("‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞: ‡∏£‡∏±‡∏ö‡πÅ‡∏•‡πâ‡∏ß"); render();
    // keep modal open: re-open detail
    openProfitDetail(periodId);
  }

  function markDividendPending(periodId, allocId){
    const pp = DB.profitPeriods.find(x=>x.id===periodId);
    if(!pp) return;
    const a = (pp.allocations||[]).find(x=>x.id===allocId);
    if(!a) return;
    a.status = "‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏£‡∏±‡∏ö";
    a.receivedAt = null;
    saveDB(); toast("‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞: ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏£‡∏±‡∏ö"); render();
    openProfitDetail(periodId);
  }

  function editDividendNote(periodId, allocId){
    const pp = DB.profitPeriods.find(x=>x.id===periodId);
    if(!pp) return;
    const a = (pp.allocations||[]).find(x=>x.id===allocId);
    if(!a) return;
    const note = prompt("‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ:", a.note||"");
    if(note===null) return;
    a.note = String(note||"").trim();
    saveDB(); toast("‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏‡πÅ‡∏•‡πâ‡∏ß"); render();
    openProfitDetail(periodId);
  }

  function deleteProfitPeriod(id){
    if(!confirm("‡∏•‡∏ö‡∏á‡∏ß‡∏î‡∏Å‡∏≥‡πÑ‡∏£‡∏ô‡∏µ‡πâ‡πÉ‡∏ä‡πà‡πÑ‡∏´‡∏°? (‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ)")) return;
    const idx = DB.profitPeriods.findIndex(x=>x.id===id);
    if(idx>=0){
      DB.profitPeriods.splice(idx,1);
      saveDB(); toast("‡∏•‡∏ö‡∏á‡∏ß‡∏î‡∏Å‡∏≥‡πÑ‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢"); render();
    }
  }

  /********** Reports **********/
  function pageReports(){
    const {start,end} = state.range;
    const p = calcProfit(start,end);

    const sales = DB.sales.filter(s=>isISODate(s.date)&&inRange(s.date,start,end));
    const expenses = DB.expenses.filter(e=>isISODate(e.date)&&inRange(e.date,start,end));
    const pos = DB.purchaseOrders.filter(po=>isISODate(po.date)&&inRange(po.date,start,end));

    // Product summary from sales items
    const prodMap = new Map();
    for(const s of sales){
      for(const it of (s.items||[])){
        const pid = it.productId;
        if(!pid) continue;
        if(!prodMap.has(pid)) prodMap.set(pid, {qty:0, rev:0, cogs:0});
        const row = prodMap.get(pid);
        row.qty += n(it.qty);
        row.rev += n(it.qty)*n(it.priceAt);
        row.cogs += n(it.qty)*n(it.costAt);
      }
    }
    const prodRows = Array.from(prodMap.entries()).map(([pid,v])=>{
      const p = DB.products.find(x=>x.id===pid);
      const name = p ? p.name : "(‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏û‡∏ö)";
      const profit = v.rev - v.cogs;
      return {name, ...v, profit};
    }).sort((a,b)=>b.rev-a.rev);

    const prodTable = prodRows.slice(0,50).map(r=>`
      <tr>
        <td class="font-black">${htmlesc(r.name)}</td>
        <td class="mono">${r.qty.toFixed(2)}</td>
        <td class="mono font-black">${money(r.rev)}</td>
        <td class="mono">${money(r.cogs)}</td>
        <td class="mono font-black">${money(r.profit)}</td>
      </tr>
    `).join("") || `<tr><td colspan="5" class="muted font-bold">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÉ‡∏ô‡∏ö‡∏¥‡∏• (‡∏ñ‡πâ‡∏≤‡∏ö‡∏¥‡∏•‡πÄ‡∏î‡∏¥‡∏°‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏õ‡πá‡∏ô‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡∏™‡∏£‡∏∏‡∏õ‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô)</td></tr>`;

    // Expense breakdown
    const expByCat = new Map();
    for(const e of expenses){
      const k = e.category || "‡∏≠‡∏∑‡πà‡∏ô‡πÜ";
      expByCat.set(k, (expByCat.get(k)||0) + n(e.amount));
    }
    const expRows = Array.from(expByCat.entries()).sort((a,b)=>b[1]-a[1]).map(([k,v])=>`
      <tr><td class="font-black">${htmlesc(k)}</td><td class="mono font-black">${money(v)}</td></tr>
    `).join("") || `<tr><td colspan="2" class="muted font-bold">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢</td></tr>`;

    const content = `
      <div class="glass rounded-3xl p-5 md:p-7 soft-shadow">
        ${pageHeader("‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏£‡∏ß‡∏°‡∏ï‡∏≤‡∏°‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤", "‡∏™‡∏£‡∏∏‡∏õ‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢ ¬∑ ‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢ ¬∑ PO ¬∑ ‡∏™‡∏£‡∏∏‡∏õ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÉ‡∏ô‡∏ö‡∏¥‡∏•) ¬∑ ‡∏û‡∏¥‡∏°‡∏û‡πå‡πÄ‡∏õ‡πá‡∏ô PDF",
          `<button class="btn btn-primary" onclick="printDoc('report','range')">‡∏û‡∏¥‡∏°‡∏û‡πå‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô PDF</button>`
        )}

        <div class="mt-6 grid grid-cols-1 md:grid-cols-2 xl:grid-cols-4 gap-4">
          ${kpi("‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢‡∏£‡∏ß‡∏°", shortMoney(p.revenue), `‡∏ö‡∏¥‡∏• ${sales.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£`, "pri")}
          ${kpi("‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢‡∏£‡∏ß‡∏°", shortMoney(p.expense), `‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ ${expenses.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£`, "warn")}
          ${kpi("PO ‡∏£‡∏ß‡∏°", shortMoney(sum(pos, x=>x.total)), `PO ${pos.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£`, "pri")}
          ${kpi("‡∏Å‡∏≥‡πÑ‡∏£‡∏™‡∏∏‡∏ó‡∏ò‡∏¥", shortMoney(p.profit), "‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ - ‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢", p.profit>=0?"good":"bad")}
        </div>

        <div class="mt-6 grid grid-cols-1 xl:grid-cols-2 gap-4">
          <div class="glass2 rounded-3xl p-5">
            <div class="text-lg font-black">‡∏™‡∏£‡∏∏‡∏õ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ (Top)</div>
            <div class="text-xs font-bold muted2 mt-1">‡πÅ‡∏™‡∏î‡∏á‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ö‡∏¥‡∏•‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ (items)</div>
            <div class="mt-4 overflow-x-auto">
              <table class="table">
                <thead><tr><th>‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</th><th>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô</th><th>‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢</th><th>COGS</th><th>‡∏Å‡∏≥‡πÑ‡∏£‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡πâ‡∏ô</th></tr></thead>
                <tbody>${prodTable}</tbody>
              </table>
            </div>
          </div>

          <div class="glass2 rounded-3xl p-5">
            <div class="text-lg font-black">‡∏™‡∏£‡∏∏‡∏õ‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢‡∏ï‡∏≤‡∏°‡∏´‡∏°‡∏ß‡∏î</div>
            <div class="mt-4 overflow-x-auto">
              <table class="table">
                <thead><tr><th>‡∏´‡∏°‡∏ß‡∏î</th><th>‡∏£‡∏ß‡∏°</th></tr></thead>
                <tbody>${expRows}</tbody>
              </table>
            </div>

            <div class="mt-4 glass2 rounded-2xl p-4">
              <div class="text-xs font-black muted2">‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏</div>
              <div class="text-sm font-bold muted2 mt-1">
                ‡∏´‡∏≤‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£ ‚Äú‡πÉ‡∏ö‡πÄ‡∏ö‡∏¥‡∏Å‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏´‡∏°‡∏ß‡∏î + ‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤‚Äù ‡πÉ‡∏´‡πâ‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤ ‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢/‡πÉ‡∏ö‡πÄ‡∏ö‡∏¥‡∏Å ‚Üí ‡∏ó‡∏≥‡πÉ‡∏ö‡πÄ‡∏ö‡∏¥‡∏Å‡∏ï‡∏≤‡∏°‡∏ä‡πà‡∏ß‡∏á
              </div>
            </div>
          </div>
        </div>

      </div>
    `;
    return content;
  }

  /********** Settings **********/
  function pageSettings(){
    const content = `
      <div class="glass rounded-3xl p-5 md:p-7 soft-shadow">
        ${pageHeader("‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤", "‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏¥‡∏à‡∏Å‡∏≤‡∏£ ¬∑ ‡∏™‡∏≥‡∏£‡∏≠‡∏á/‡∏Å‡∏π‡πâ‡∏Ñ‡∏∑‡∏ô ¬∑ ‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏°‡∏∑‡∏≠‡∏â‡∏∏‡∏Å‡πÄ‡∏â‡∏¥‡∏ô (‡πÑ‡∏°‡πà‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥)",
          `<button class="btn btn-dark" onclick="backupData()">‡∏™‡∏≥‡∏£‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• (JSON)</button>
           <button class="btn btn-dark" onclick="restoreData()">‡∏Å‡∏π‡πâ‡∏Ñ‡∏∑‡∏ô‡∏à‡∏≤‡∏Å JSON</button>`
        )}

        <div class="mt-6 glass2 rounded-3xl p-5">
          <div class="text-lg font-black">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏¥‡∏à‡∏Å‡∏≤‡∏£ (‡πÉ‡∏ä‡πâ‡∏ö‡∏ô‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£)</div>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-3 mt-4">
            <div><div class="text-xs font-black muted2 mb-1">‡∏ä‡∏∑‡πà‡∏≠‡∏Å‡∏¥‡∏à‡∏Å‡∏≤‡∏£</div><input id="set_name" class="input" value="${htmlesc(DB.settings.businessName||"")}"></div>
            <div><div class="text-xs font-black muted2 mb-1">‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£</div><input id="set_phone" class="input" value="${htmlesc(DB.settings.phone||"")}"></div>
            <div class="md:col-span-2"><div class="text-xs font-black muted2 mb-1">‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà</div><input id="set_address" class="input" value="${htmlesc(DB.settings.address||"")}"></div>
            <div><div class="text-xs font-black muted2 mb-1">‡πÄ‡∏•‡∏Ç‡∏ú‡∏π‡πâ‡πÄ‡∏™‡∏µ‡∏¢‡∏†‡∏≤‡∏©‡∏µ</div><input id="set_tax" class="input" value="${htmlesc(DB.settings.taxId||"")}"></div>
          </div>
          <div class="mt-4 flex justify-end no-print">
            <button class="btn btn-primary" onclick="saveSettings()">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤</button>
          </div>
        </div>

        <div class="mt-6 glass2 rounded-3xl p-5">
          <div class="text-lg font-black text-red-200">‡πÇ‡∏ã‡∏ô‡∏â‡∏∏‡∏Å‡πÄ‡∏â‡∏¥‡∏ô (‡∏£‡∏∞‡∏ß‡∏±‡∏á)</div>
          <div class="text-sm font-bold muted2 mt-1">
            ‡∏õ‡∏∏‡πà‡∏°‡∏ô‡∏µ‡πâ‡∏à‡∏∞ ‚Äú‡∏•‡πâ‡∏≤‡∏á‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• v3 PRO ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô‚Äù ‡πÅ‡∏ï‡πà‡∏à‡∏∞‡πÑ‡∏°‡πà‡∏•‡∏ö key ‡πÄ‡∏Å‡πà‡∏≤ (v1/v2) ‚Äî ‡πÉ‡∏ä‡πâ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÉ‡∏´‡∏°‡πà‡∏à‡∏£‡∏¥‡∏á ‡πÜ
          </div>
          <div class="mt-4 no-print">
            <button class="btn btn-danger" onclick="resetV3()">‡∏•‡πâ‡∏≤‡∏á‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• v3 PRO</button>
          </div>
        </div>

        <div class="mt-6 glass2 rounded-3xl p-5">
          <div class="text-lg font-black">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏∞‡∏ö‡∏ö (Audit)</div>
          <div class="text-xs font-bold muted2 mt-1">‡πÄ‡∏Å‡πá‡∏ö 200 ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</div>
          <div class="mt-4 overflow-x-auto">
            <table class="table">
              <thead><tr><th>‡πÄ‡∏ß‡∏•‡∏≤</th><th>‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó</th><th>‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î</th></tr></thead>
              <tbody>
                ${(DB.audit||[]).slice(0,60).map(a=>`
                  <tr>
                    <td class="mono font-black">${htmlesc((a.at||"").replace("T"," ").slice(0,19))}</td>
                    <td><span class="chip">${htmlesc(a.type||"")}</span></td>
                    <td class="muted2 font-bold">${htmlesc(a.message||"")}</td>
                  </tr>
                `).join("") || `<tr><td colspan="3" class="muted font-bold">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</td></tr>`}
              </tbody>
            </table>
          </div>
        </div>

      </div>
    `;
    return content;
  }

  function saveSettings(){
    DB.settings.businessName = (document.getElementById("set_name").value||"").trim();
    DB.settings.phone = (document.getElementById("set_phone").value||"").trim();
    DB.settings.address = (document.getElementById("set_address").value||"").trim();
    DB.settings.taxId = (document.getElementById("set_tax").value||"").trim();
    saveDB();
    toast("‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÅ‡∏•‡πâ‡∏ß");
    render();
  }

  function resetV3(){
    if(!confirm("‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏•‡πâ‡∏≤‡∏á‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• v3 PRO?\n(‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• v1/v2 ‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡πá‡∏ô key ‡πÄ‡∏Å‡πà‡∏≤ ‡∏à‡∏∞‡∏¢‡∏±‡∏á‡∏≠‡∏¢‡∏π‡πà ‡πÅ‡∏ï‡πà v3 ‡∏ô‡∏µ‡πâ‡∏à‡∏∞‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÉ‡∏´‡∏°‡πà)")) return;
    localStorage.removeItem(APP_KEY);
    DB = deepClone(EMPTY_DB);
    DB.meta.migratedAt = new Date().toISOString();
    DB.meta.migratedFrom = ["reset"];
    saveDB();
    toast("‡∏•‡πâ‡∏≤‡∏á‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• v3 PRO ‡πÅ‡∏•‡πâ‡∏ß");
    setTab("dashboard");
  }

  function backupData(){
    downloadJSON(`BKP_ERP_PRO_V3_Backup_${todayISO()}.json`, DB);
    toast("‡∏™‡∏≥‡∏£‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏õ‡πá‡∏ô JSON ‡πÅ‡∏•‡πâ‡∏ß");
  }

  function restoreData(){
    openModal("‡∏Å‡∏π‡πâ‡∏Ñ‡∏∑‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å JSON", `
      <div class="glass2 rounded-3xl p-4">
        <div class="text-sm font-black">‡∏ß‡∏≤‡∏á JSON ‡∏ó‡∏µ‡πà‡∏™‡∏≥‡∏£‡∏≠‡∏á‡πÑ‡∏ß‡πâ</div>
        <div class="text-xs font-bold muted2 mt-1">‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡∏ï‡∏£‡∏ß‡∏à schema ‡∏Å‡πà‡∏≠‡∏ô‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</div>
        <textarea id="restore_json" class="input mono mt-3" style="height:220px" placeholder="{ ... }"></textarea>
      </div>
    `, ()=>{
      const txt = document.getElementById("restore_json").value;
      const obj = safeParse(txt);
      if(!obj || !obj.meta || obj.meta.schema!==3) throw new Error("‡πÑ‡∏ü‡∏•‡πå‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà BKP ERP v3 schema");
      // basic sanity
      if(!Array.isArray(obj.customers) || !Array.isArray(obj.products) || !Array.isArray(obj.sales)) throw new Error("‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏Ñ‡∏£‡∏ö");
      localStorage.setItem(APP_KEY, JSON.stringify(obj));
      DB = obj;
      toast("‡∏Å‡∏π‡πâ‡∏Ñ‡∏∑‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢");
      setTab("dashboard");
    }, "‡∏Å‡∏π‡πâ‡∏Ñ‡∏∑‡∏ô");
  }

  /*************************************
   * 6) Printing (PDF via Browser Print)
   *************************************/
  function printCurrent(){
    window.print();
  }

  function buildDocShell(title, body){
    const biz = DB.settings.businessName || "‡∏Ñ‡∏£‡∏±‡∏ß‡∏Å‡∏•‡∏≤‡∏á BKP Partnership";
    const addr = DB.settings.address || "";
    const phone = DB.settings.phone || "";
    const tax = DB.settings.taxId || "";
    return `
      <!doctype html>
      <html lang="th"><head>
        <meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1">
        <title>${htmlesc(title)}</title>
        <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;600;700;800&display=swap" rel="stylesheet">
        <style>
          body{font-family:'Sarabun',system-ui;margin:24px;color:#111827}
          .top{display:flex;justify-content:space-between;gap:16px;border-bottom:3px solid #2563eb;padding-bottom:12px;margin-bottom:16px}
          .biz{font-weight:900;font-size:18px}
          .muted{color:#6b7280;font-size:12px;font-weight:700}
          table{width:100%;border-collapse:collapse;margin-top:12px}
          th,td{border:1px solid #e5e7eb;padding:8px;font-size:13px}
          th{background:#f3f4f6;text-align:left}
          .right{text-align:right}
          .mono{font-variant-numeric:tabular-nums}
          .sum{margin-top:14px;display:flex;justify-content:flex-end}
          .box{border:1px solid #e5e7eb;padding:10px 12px;border-radius:10px;min-width:260px}
          .h1{font-size:20px;font-weight:900}
          .h2{font-size:14px;font-weight:900;margin-top:14px}
          .sign{margin-top:26px;display:flex;justify-content:space-between;gap:16px}
          .line{border-top:1px dashed #9ca3af;margin-top:42px}
          @media print{body{margin:0} .noprint{display:none}}
        </style>
      </head>
      <body>
        <div class="top">
          <div>
            <div class="biz">${htmlesc(biz)}</div>
            <div class="muted">${htmlesc(addr)}</div>
            <div class="muted">${phone?("‡πÇ‡∏ó‡∏£. "+htmlesc(phone)):""} ${tax?(" ¬∑ ‡πÄ‡∏•‡∏Ç‡∏ú‡∏π‡πâ‡πÄ‡∏™‡∏µ‡∏¢‡∏†‡∏≤‡∏©‡∏µ "+htmlesc(tax)):""}</div>
          </div>
          <div style="text-align:right">
            <div class="h1">${htmlesc(title)}</div>
            <div class="muted">‡∏û‡∏¥‡∏°‡∏û‡πå‡πÄ‡∏°‡∏∑‡πà‡∏≠ ${new Date().toLocaleString("th-TH")}</div>
          </div>
        </div>
        ${body}
        <script>window.onload=()=>{window.print();};</script>
      </body></html>
    `;
  }

  function printHTML(html){
    const w = window.open("", "_blank");
    if(!w){ toast("‡πÄ‡∏ö‡∏£‡∏≤‡∏ß‡πå‡πÄ‡∏ã‡∏≠‡∏£‡πå‡∏ö‡∏•‡πá‡∏≠‡∏Å‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡πà‡∏≤‡∏á‡∏õ‡πä‡∏≠‡∏õ‡∏≠‡∏±‡∏õ: ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï pop-up"); return; }
    w.document.open();
    w.document.write(html);
    w.document.close();
  }

  function printDoc(type, id){
    if(type==="sale"){
      const s = DB.sales.find(x=>x.id===id);
      if(!s) return;
      const c = DB.customers.find(x=>x.id===s.customerId);
      const items = (s.items||[]).map(it=>{
        const p = DB.products.find(x=>x.id===it.productId);
        const name = p ? p.name : "(‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏û‡∏ö)";
        const line = n(it.qty)*n(it.priceAt);
        return `<tr>
          <td>${htmlesc(name)}</td>
          <td class="right mono">${n(it.qty).toFixed(2)} ${htmlesc(it.unit||"")}</td>
          <td class="right mono">${money(it.priceAt)}</td>
          <td class="right mono">${money(line)}</td>
        </tr>`;
      }).join("") || `<tr><td colspan="4" class="muted">‡∏ö‡∏¥‡∏•‡∏ô‡∏µ‡πâ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ (‡∏≠‡∏≤‡∏à‡πÄ‡∏õ‡πá‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏Å‡πà‡∏≤‡∏ó‡∏µ‡πà‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô)</td></tr>`;

      const due = Math.max(0, n(s.total)-n(s.paid));
      const body = `
        <div class="muted">‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡∏ö‡∏¥‡∏•: <span class="mono">${htmlesc(s.id)}</span> ¬∑ ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà: <span class="mono">${htmlesc(s.date)}</span></div>
        <div class="muted">‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤: <b>${htmlesc(c?.name||"(‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤)")}</b></div>
        ${s.note?`<div class="muted">‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏: ${htmlesc(s.note)}</div>`:""}
        <table>
          <thead><tr><th>‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</th><th class="right">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô</th><th class="right">‡∏£‡∏≤‡∏Ñ‡∏≤/‡∏´‡∏ô‡πà‡∏ß‡∏¢</th><th class="right">‡∏£‡∏ß‡∏°</th></tr></thead>
          <tbody>${items}</tbody>
        </table>
        <div class="sum">
          <div class="box">
            <div class="muted">‡∏¢‡∏≠‡∏î‡∏ö‡∏¥‡∏•</div><div class="mono" style="font-weight:900;font-size:18px">${money(s.total)}</div>
            <div class="muted" style="margin-top:8px">‡∏£‡∏±‡∏ö‡πÅ‡∏•‡πâ‡∏ß</div><div class="mono" style="font-weight:900">${money(s.paid)}</div>
            <div class="muted" style="margin-top:8px">‡∏Ñ‡πâ‡∏≤‡∏á‡∏£‡∏±‡∏ö</div><div class="mono" style="font-weight:900">${money(due)}</div>
          </div>
        </div>
        <div class="sign">
          <div style="flex:1">
            <div class="line"></div>
            <div class="muted" style="text-align:center">‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô</div>
          </div>
          <div style="flex:1">
            <div class="line"></div>
            <div class="muted" style="text-align:center">‡∏ú‡∏π‡πâ‡∏à‡πà‡∏≤‡∏¢‡πÄ‡∏á‡∏¥‡∏ô</div>
          </div>
        </div>
      `;
      printHTML(buildDocShell("‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô / ‡πÉ‡∏ö‡∏Ç‡∏≤‡∏¢", body));
      return;
    }

    if(type==="po"){
      const po = DB.purchaseOrders.find(x=>x.id===id);
      if(!po) return;
      const items = (po.items||[]).map(it=>{
        const line = n(it.qty)*n(it.price);
        return `<tr>
          <td>${htmlesc(it.name)}</td>
          <td class="right mono">${n(it.qty).toFixed(2)} ${htmlesc(it.unit||"")}</td>
          <td class="right mono">${money(it.price)}</td>
          <td class="right mono">${money(line)}</td>
        </tr>`;
      }).join("");

      const due = Math.max(0, n(po.total)-n(po.paid));
      const body = `
        <div class="muted">‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà PO: <span class="mono">${htmlesc(po.id)}</span> ¬∑ ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà: <span class="mono">${htmlesc(po.date)}</span></div>
        <div class="muted">‡∏ú‡∏π‡πâ‡∏Ç‡∏≤‡∏¢/‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤: <b>${htmlesc(po.supplierName||"(‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏)")}</b></div>
        ${po.note?`<div class="muted">‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏: ${htmlesc(po.note)}</div>`:""}
        <table>
          <thead><tr><th>‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</th><th class="right">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô</th><th class="right">‡∏£‡∏≤‡∏Ñ‡∏≤/‡∏´‡∏ô‡πà‡∏ß‡∏¢</th><th class="right">‡∏£‡∏ß‡∏°</th></tr></thead>
          <tbody>${items || `<tr><td colspan="4" class="muted">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</td></tr>`}</tbody>
        </table>
        <div class="sum">
          <div class="box">
            <div class="muted">‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°</div><div class="mono" style="font-weight:900;font-size:18px">${money(po.total)}</div>
            <div class="muted" style="margin-top:8px">‡∏à‡πà‡∏≤‡∏¢‡πÅ‡∏•‡πâ‡∏ß</div><div class="mono" style="font-weight:900">${money(po.paid)}</div>
            <div class="muted" style="margin-top:8px">‡∏Ñ‡πâ‡∏≤‡∏á‡∏à‡πà‡∏≤‡∏¢</div><div class="mono" style="font-weight:900">${money(due)}</div>
          </div>
        </div>
        <div class="sign">
          <div style="flex:1">
            <div class="line"></div>
            <div class="muted" style="text-align:center">‡∏ú‡∏π‡πâ‡∏à‡∏±‡∏î‡∏ó‡∏≥</div>
          </div>
          <div style="flex:1">
            <div class="line"></div>
            <div class="muted" style="text-align:center">‡∏ú‡∏π‡πâ‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥</div>
          </div>
        </div>
      `;
      printHTML(buildDocShell("‡πÉ‡∏ö‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠ (PO)", body));
      return;
    }

    if(type==="expense"){
      const e = DB.expenses.find(x=>x.id===id);
      if(!e) return;
      const body = `
        <div class="muted">‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£: <span class="mono">${htmlesc(e.id)}</span> ¬∑ ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà: <span class="mono">${htmlesc(e.date)}</span></div>
        <div class="muted">‡∏´‡∏°‡∏ß‡∏î: <b>${htmlesc(e.category||"")}</b></div>
        ${e.note?`<div class="muted">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î: ${htmlesc(e.note)}</div>`:""}
        <div class="sum">
          <div class="box">
            <div class="muted">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô</div><div class="mono" style="font-weight:900;font-size:18px">${money(e.amount)}</div>
          </div>
        </div>
        <div class="sign">
          <div style="flex:1">
            <div class="line"></div>
            <div class="muted" style="text-align:center">‡∏ú‡∏π‡πâ‡πÄ‡∏ö‡∏¥‡∏Å</div>
          </div>
          <div style="flex:1">
            <div class="line"></div>
            <div class="muted" style="text-align:center">‡∏ú‡∏π‡πâ‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥</div>
          </div>
        </div>
      `;
      printHTML(buildDocShell("‡πÉ‡∏ö‡πÄ‡∏ö‡∏¥‡∏Å/‡πÉ‡∏ö‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏à‡πà‡∏≤‡∏¢", body));
      return;
    }

    if(type==="profit"){
      const pp = DB.profitPeriods.find(x=>x.id===id);
      if(!pp) return;
      const rows = (pp.allocations||[]).map(a=>{
        const sh = DB.shareholders.find(s=>s.id===a.shareholderId) || {name:"(‡πÑ‡∏°‡πà‡∏û‡∏ö)"};
        return `<tr>
          <td>${htmlesc(sh.name)}</td>
          <td class="right mono">${a.percentAtCalc.toFixed(2)}%</td>
          <td class="right mono">${money(a.amount)}</td>
          <td class="right">${htmlesc(a.status||"")}</td>
          <td class="right mono">${htmlesc(a.receivedAt||"‚Äî")}</td>
        </tr>`;
      }).join("") || `<tr><td colspan="5" class="muted">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</td></tr>`;

      const body = `
        <div class="muted">‡∏á‡∏ß‡∏î: <b>${htmlesc(pp.start)} ‡∏ñ‡∏∂‡∏á ${htmlesc(pp.end)}</b> ¬∑ ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡πÄ‡∏°‡∏∑‡πà‡∏≠ ${htmlesc(pp.calculatedAt?.split("T")[0]||"")}</div>
        <table>
          <thead><tr><th>‡∏ú‡∏π‡πâ‡∏ñ‡∏∑‡∏≠‡∏´‡∏∏‡πâ‡∏ô</th><th class="right">% ‡∏ì ‡∏ß‡∏±‡∏ô‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì</th><th class="right">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô</th><th class="right">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th><th class="right">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏£‡∏±‡∏ö</th></tr></thead>
          <tbody>${rows}</tbody>
        </table>
        <div class="sum">
          <div class="box">
            <div class="muted">‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ</div><div class="mono" style="font-weight:900">${money(pp.revenue)}</div>
            <div class="muted" style="margin-top:8px">‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢</div><div class="mono" style="font-weight:900">${money(pp.expense)}</div>
            <div class="muted" style="margin-top:8px">‡∏Å‡∏≥‡πÑ‡∏£‡∏™‡∏∏‡∏ó‡∏ò‡∏¥</div><div class="mono" style="font-weight:900;font-size:18px">${money(pp.profit)}</div>
          </div>
        </div>
      `;
      printHTML(buildDocShell("‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏Å‡∏≥‡πÑ‡∏£ & ‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏™‡∏£‡∏£‡∏ú‡∏π‡πâ‡∏ñ‡∏∑‡∏≠‡∏´‡∏∏‡πâ‡∏ô", body));
      return;
    }

    if(type==="report" && id==="range"){
      const {start,end} = state.range;
      const p = calcProfit(start,end);
      const body = `
        <div class="muted">‡∏ä‡πà‡∏ß‡∏á‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô: <b>${htmlesc(start)} ‡∏ñ‡∏∂‡∏á ${htmlesc(end)}</b></div>
        <div class="sum">
          <div class="box">
            <div class="muted">‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢‡∏£‡∏ß‡∏°</div><div class="mono" style="font-weight:900">${money(p.revenue)}</div>
            <div class="muted" style="margin-top:8px">‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢‡∏£‡∏ß‡∏°</div><div class="mono" style="font-weight:900">${money(p.expense)}</div>
            <div class="muted" style="margin-top:8px">‡∏Å‡∏≥‡πÑ‡∏£‡∏™‡∏∏‡∏ó‡∏ò‡∏¥</div><div class="mono" style="font-weight:900;font-size:18px">${money(p.profit)}</div>
          </div>
        </div>
      `;
      printHTML(buildDocShell("‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏£‡∏ß‡∏°‡∏ï‡∏≤‡∏°‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤", body));
      return;
    }
  }

  function buildVoucherHTML({title, note, start, end, cats, list, total}){
    const rows = list.sort((a,b)=>new Date(a.date)-new Date(b.date)).map(e=>`
      <tr>
        <td class="mono">${htmlesc(e.date)}</td>
        <td>${htmlesc(e.category)}</td>
        <td>${htmlesc(e.note||"")}</td>
        <td class="right mono">${money(e.amount)}</td>
      </tr>
    `).join("") || `<tr><td colspan="4" class="muted">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÉ‡∏ô‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å</td></tr>`;

    const body = `
      <div class="muted">‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠: <b>${htmlesc(title)}</b></div>
      <div class="muted">‡∏ä‡πà‡∏ß‡∏á: ${htmlesc(start)} ‡∏ñ‡∏∂‡∏á ${htmlesc(end)} ¬∑ ‡∏´‡∏°‡∏ß‡∏î: ${htmlesc(cats.join(", "))}</div>
      ${note?`<div class="muted">‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏: ${htmlesc(note)}</div>`:""}
      <table>
        <thead><tr><th>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</th><th>‡∏´‡∏°‡∏ß‡∏î</th><th>‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î</th><th class="right">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô</th></tr></thead>
        <tbody>${rows}</tbody>
      </table>
      <div class="sum">
        <div class="box">
          <div class="muted">‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏™‡∏¥‡πâ‡∏ô</div><div class="mono" style="font-weight:900;font-size:18px">${money(total)}</div>
        </div>
      </div>
      <div class="sign">
        <div style="flex:1">
          <div class="line"></div>
          <div class="muted" style="text-align:center">‡∏ú‡∏π‡πâ‡πÄ‡∏ö‡∏¥‡∏Å</div>
        </div>
        <div style="flex:1">
          <div class="line"></div>
          <div class="muted" style="text-align:center">‡∏ú‡∏π‡πâ‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥</div>
        </div>
      </div>
    `;
    return buildDocShell("‡πÉ‡∏ö‡πÄ‡∏ö‡∏¥‡∏Å‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢", body);
  }

  /*************************************
   * 7) Global actions / glue
   *************************************/
  function applyRange(){
    const s = document.getElementById("rng-start")?.value;
    const e = document.getElementById("rng-end")?.value;
    if(!isISODate(s)||!isISODate(e)){
      toast("‡∏ä‡πà‡∏ß‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á");
      return;
    }
    state.range.start = s;
    state.range.end = e;
    toast("‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏ä‡πà‡∏ß‡∏á‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡πÅ‡∏•‡πâ‡∏ß");
    render();
  }

  // Quick actions used in dashboard
  function openQuickExpense(){ window.openQuickExpense = openQuickExpense; openQuickExpense(); }
  function openQuickPO(){ window.openQuickPO = openQuickPO; openQuickPO(); }

  /*************************************
   * 8) Render router
   *************************************/
  function render(){
    // expose for inline handlers
    window.state = state;
    window.setTab = setTab;

    window.applyRange = applyRange;
    window.backupData = backupData;
    window.restoreData = restoreData;
    window.saveSettings = saveSettings;
    window.resetV3 = resetV3;

    window.addCustomer = addCustomer;
    window.editCustomer = editCustomer;
    window.deactivateCustomer = deactivateCustomer;
    window.exportCustomers = exportCustomers;

    window.addProduct = addProduct;
    window.editProduct = editProduct;
    window.deactivateProduct = deactivateProduct;
    window.exportProducts = exportProducts;

    window.openQuickSale = openQuickSale;
    window.editSale = editSale;
    window.receiveMoney = receiveMoney;
    window.deleteSale = deleteSale;

    window.openQuickPO = openQuickPO;
    window.addPOItemRow = addPOItemRow;
    window.recalcPOTotalPreview = recalcPOTotalPreview;
    window.editPO = editPO;
    window.payPO = payPO;
    window.deletePO = deletePO;

    window.openQuickExpense = openQuickExpense;
    window.editExpense = editExpense;
    window.deleteExpense = deleteExpense;
    window.openVoucherBuilder = openVoucherBuilder;

    window.addShareholder = addShareholder;
    window.editShareholder = editShareholder;
    window.deactivateShareholder = deactivateShareholder;
    window.createProfitPeriodFromRange = createProfitPeriodFromRange;
    window.openProfitDetail = openProfitDetail;
    window.markDividendReceived = markDividendReceived;
    window.markDividendPending = markDividendPending;
    window.editDividendNote = editDividendNote;
    window.deleteProfitPeriod = deleteProfitPeriod;

    window.printDoc = printDoc;
    window.printCurrent = printCurrent;
    window.printHTML = printHTML;

    window.closeModal = closeModal;
    window.submitModal = submitModal;

    // page router
    let content = "";
    if(state.tab==="dashboard") content = pageDashboard();
    else if(state.tab==="customers") content = pageCustomers();
    else if(state.tab==="products") content = pageProducts();
    else if(state.tab==="sales") content = pageSales();
    else if(state.tab==="po") content = pagePO();
    else if(state.tab==="expenses") content = pageExpenses();
    else if(state.tab==="shareholders") content = pageShareholders();
    else if(state.tab==="reports") content = pageReports();
    else if(state.tab==="settings") content = pageSettings();
    else content = pageDashboard();

    root.innerHTML = layout(content);
  }

  // first render
  render();
  toast("‡∏£‡∏∞‡∏ö‡∏ö‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô ¬∑ ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏î‡∏¥‡∏°‡∏ñ‡∏π‡∏Å‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥‡πÅ‡∏•‡πâ‡∏ß");
  </script>
</body>
</html>
