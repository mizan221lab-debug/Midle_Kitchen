<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>BKP ERP v3-A | Core + Migration</title>
  <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;600;700;800&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg:#f1f5f9; --card:#ffffff; --ink:#0f172a; --muted:#64748b; --line:#e2e8f0;
      --pri:#2563eb; --pri2:#1d4ed8; --ok:#16a34a; --warn:#dc2626; --slate:#0f172a;
      --soft:#f8fafc;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;font-family:"Sarabun",system-ui;background:var(--bg);color:var(--ink)}
    a{color:inherit}
    .app{display:flex;min-height:100vh}
    .sidebar{width:280px;background:var(--slate);color:#fff;padding:18px 14px;position:sticky;top:0;height:100vh;overflow:auto}
    .brand{display:flex;gap:10px;align-items:center;margin-bottom:14px;padding:8px 10px;border:1px solid rgba(255,255,255,.08);border-radius:14px}
    .brand .logo{width:40px;height:40px;border-radius:14px;background:var(--pri);display:flex;align-items:center;justify-content:center;font-weight:900}
    .brand h1{font-size:16px;margin:0}
    .brand small{display:block;color:rgba(255,255,255,.65);font-weight:700;letter-spacing:.2px}
    .navgrp{margin-top:12px}
    .navttl{padding:10px 12px;color:rgba(255,255,255,.45);font-weight:900;font-size:11px;letter-spacing:.12em;text-transform:uppercase}
    .nav button{width:100%;text-align:left;border:none;background:transparent;color:rgba(255,255,255,.78);padding:10px 12px;border-radius:12px;cursor:pointer;display:flex;gap:10px;align-items:center;font-weight:800}
    .nav button:hover{background:rgba(255,255,255,.06);color:#fff}
    .nav button.active{background:var(--pri);color:#fff;box-shadow:0 10px 25px rgba(37,99,235,.25)}
    .nav .dot{width:10px;height:10px;border-radius:999px;background:rgba(255,255,255,.25)}
    .nav button.active .dot{background:#fff}
    .main{flex:1;padding:18px;overflow:auto}
    .topbar{display:flex;align-items:flex-end;justify-content:space-between;gap:12px;margin-bottom:16px}
    .topbar h2{margin:0;font-size:22px;font-weight:900}
    .topbar .sub{color:var(--muted);font-weight:800;font-size:12px}
    .topbar .right{display:flex;gap:8px;flex-wrap:wrap}
    .btn{border:none;border-radius:12px;padding:10px 12px;font-weight:900;cursor:pointer}
    .btn.pri{background:var(--pri);color:#fff}
    .btn.pri:hover{background:var(--pri2)}
    .btn.ghost{background:#fff;border:1px solid var(--line)}
    .btn.ghost:hover{background:var(--soft)}
    .btn.danger{background:#fee2e2;color:#991b1b;border:1px solid #fecaca}
    .btn.ok{background:#dcfce7;color:#166534;border:1px solid #bbf7d0}
    .grid{display:grid;gap:12px}
    .g4{grid-template-columns:repeat(4,minmax(0,1fr))}
    .g3{grid-template-columns:repeat(3,minmax(0,1fr))}
    .g2{grid-template-columns:repeat(2,minmax(0,1fr))}
    @media (max-width:1200px){.g4{grid-template-columns:repeat(2,minmax(0,1fr))}}
    @media (max-width:760px){
      .sidebar{display:none}
      .main{padding:12px}
      .g4,.g3,.g2{grid-template-columns:1fr}
    }
    .card{background:var(--card);border:1px solid var(--line);border-radius:18px;padding:14px}
    .card.hi{border-left:6px solid var(--pri)}
    .stat{display:flex;justify-content:space-between;gap:10px;align-items:flex-start}
    .stat .k{font-size:11px;font-weight:900;color:var(--muted);letter-spacing:.12em;text-transform:uppercase}
    .stat .v{font-size:22px;font-weight:1000;margin-top:6px}
    .stat .s{font-size:11px;font-weight:800;color:#94a3b8}
    .chip{display:inline-flex;gap:6px;align-items:center;padding:4px 8px;border-radius:999px;font-weight:900;font-size:11px;border:1px solid var(--line);background:var(--soft);color:var(--ink)}
    .chip.ok{background:#dcfce7;border-color:#bbf7d0;color:#166534}
    .chip.wait{background:#fee2e2;border-color:#fecaca;color:#991b1b}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:end}
    label{display:block;font-weight:900;color:var(--muted);font-size:12px;margin:0 0 6px 2px}
    input,select,textarea{width:100%;padding:10px 12px;border-radius:12px;border:1px solid var(--line);background:#fff;font-weight:800;outline:none}
    textarea{min-height:90px;resize:vertical}
    input:focus,select:focus,textarea:focus{border-color:#93c5fd;box-shadow:0 0 0 3px rgba(147,197,253,.35)}
    table{width:100%;border-collapse:separate;border-spacing:0;border:1px solid var(--line);border-radius:14px;overflow:hidden}
    th,td{padding:10px 10px;border-bottom:1px solid var(--line);font-size:13px}
    th{background:var(--soft);text-align:left;color:#475569;font-weight:1000}
    tr:last-child td{border-bottom:none}
    .tdr{text-align:right}
    .muted{color:var(--muted)}
    .hr{height:1px;background:var(--line);margin:12px 0}
    .hint{font-size:12px;font-weight:800;color:#64748b;line-height:1.5}
    .warnbox{background:#fff7ed;border:1px solid #fed7aa;color:#9a3412;padding:10px 12px;border-radius:14px;font-weight:900}
    .okbox{background:#ecfeff;border:1px solid #a5f3fc;color:#155e75;padding:10px 12px;border-radius:14px;font-weight:900}
    .pillbar{display:flex;gap:8px;flex-wrap:wrap}
    .pill{background:#fff;border:1px solid var(--line);border-radius:999px;padding:8px 10px;font-weight:1000;cursor:pointer}
    .pill.active{background:var(--pri);color:#fff;border-color:var(--pri)}
    .no-print{}
    @media print{
      .no-print{display:none !important}
      body{background:#fff;-webkit-print-color-adjust:exact;print-color-adjust:exact}
      .main{padding:0}
      .card{border:none;border-radius:0}
      table{border:1px solid #cbd5e1}
      th{background:#f1f5f9 !important}
    }
  </style>
</head>
<body>
<div class="app">
  <aside class="sidebar no-print">
    <div class="brand">
      <div class="logo">BKP</div>
      <div>
        <h1>ระบบบริหารครัวกลาง</h1>
        <small>v3-A Core + Migration</small>
      </div>
    </div>
    <div class="navgrp">
      <div class="navttl">ภาพรวม</div>
      <div class="nav" id="nav"></div>
    </div>
    <div class="navgrp">
      <div class="navttl">เครื่องมือข้อมูล</div>
      <div class="card" style="background:rgba(255,255,255,.05);border-color:rgba(255,255,255,.08)">
        <div class="hint" style="color:rgba(255,255,255,.75)">
          ✅ ระบบจะดึงข้อมูลเวอร์ชัน 1 อัตโนมัติครั้งแรก<br>
          ✅ ข้อมูลเดิมจะไม่ถูกลบ<br>
          ⚠️ ถ้าต้องย้ายเครื่อง: ใช้ “ส่งออกข้อมูล”
        </div>
        <div class="hr" style="background:rgba(255,255,255,.12)"></div>
        <button class="btn ghost" style="width:100%" onclick="Actions.exportDB()">ส่งออกข้อมูล (JSON)</button>
        <div style="height:8px"></div>
        <button class="btn ghost" style="width:100%" onclick="Actions.importDB()">นำเข้าข้อมูล (JSON)</button>
      </div>
    </div>
  </aside>

  <main class="main">
    <div class="topbar no-print">
      <div>
        <h2 id="title">กำลังโหลดระบบ…</h2>
        <div class="sub" id="subtitle">โปรดรอสักครู่</div>
      </div>
      <div class="right">
        <button class="btn ghost" onclick="Actions.print()">พิมพ์ / PDF</button>
        <button class="btn ok" onclick="Actions.backupHint()">วิธีสำรองเร็ว</button>
      </div>
    </div>
    <div id="root"></div>
  </main>
</div>

<script>
/* =========================================================
   BKP ERP v3-A Core + Migration
   - เป้าหมาย: ใช้งานได้ทันที, ข้อมูล v1 ไม่หาย, ฟังก์ชัน core ครบ
   - หมายเหตุ: เอกสาร PDF ใช้ window.print() (มาตรฐานสุด + รองรับทุกเครื่อง)
========================================================= */

/* ---------- 0) Helpers ---------- */
const $$ = (sel, el=document) => el.querySelector(sel);
const $$$ = (sel, el=document) => Array.from(el.querySelectorAll(sel));
const fmtMoney = (n) => "฿" + (Number(n)||0).toLocaleString(undefined,{maximumFractionDigits:2});
const fmtInt = (n) => (Number(n)||0).toLocaleString();
const iso = (d=new Date()) => new Date(d).toISOString().split("T")[0];
const uid = () => Date.now().toString(36) + Math.random().toString(36).slice(2,8);
const safeJSON = (v) => { try{ return JSON.parse(v) }catch{ return null } };
const isObj = (x) => x && typeof x === "object" && !Array.isArray(x);

/* ---------- 1) Storage Keys (รองรับ v1 ที่คาดเดาไม่ได้) ---------- */
const V3_KEY = "BKP_ERP_V3A_DB";
const MIG_FLAG = "BKP_ERP_V3A_MIGRATED_ONCE";

/* ---------- 2) Schema v3-A ---------- */
const EMPTY = {
  meta:{
    schema:"v3-A",
    createdAt: new Date().toISOString(),
    migratedFromV1:false,
    migrationNotes:[],
  },
  customers:[],     // {id,name,phone?,note?,createdAt}
  products:[],      // {id,name,price, cost:{rm,hidden,op,other}, active, createdAt}
  sales:[],         // {id,date,customerId,items:[{productId,qty,priceAtSale,costAtSale}], total, paid, status}
  expenses:[],      // {id,date,category,amount,note}
  po:[],            // {id,date,supplier,items:[{name,qty,unit,price}], total, paidAmount, status, note}
  settings:{
    expenseCategories:["ค่าแรง","ค่าทำบัญชี","ค่าไฟ","ค่าส่ง","ค่าวัตถุดิบ","อื่นๆ"]
  }
};

/* ---------- 3) Load v3 ---------- */
function loadV3(){
  const raw = safeJSON(localStorage.getItem(V3_KEY));
  if(raw && raw.meta?.schema==="v3-A") return raw;
  return structuredClone(EMPTY);
}
let DB = loadV3();
function save(){ localStorage.setItem(V3_KEY, JSON.stringify(DB)); }

/* ---------- 4) MIGRATION from v1 (auto-detect, no delete) ---------- */
function normalizeNumber(x){
  const n = Number(x);
  return Number.isFinite(n) ? n : 0;
}
function guessDate(x){
  if(!x) return iso();
  const d = new Date(x);
  return isNaN(d.getTime()) ? iso() : iso(d);
}
function ensureCustomerByName(name){
  if(!name) return null;
  const nm = String(name).trim();
  if(!nm) return null;
  let c = DB.customers.find(x => x.name === nm);
  if(!c){
    c = {id:uid(), name:nm, createdAt:new Date().toISOString()};
    DB.customers.push(c);
  }
  return c;
}
function ensureProductByNameMaybe(pname, priceHint=null, rmCostHint=null){
  const nm = (pname?String(pname).trim():"");
  if(!nm) return null;
  let p = DB.products.find(x => x.name === nm);
  if(!p){
    const price = normalizeNumber(priceHint);
    const rm = normalizeNumber(rmCostHint);
    p = {
      id:uid(),
      name:nm,
      price: price || 0,
      cost:{rm: rm||0, hidden:0, op:0, other:0},
      active:true,
      createdAt:new Date().toISOString()
    };
    DB.products.push(p);
  }
  return p;
}

function scoreArray(arr){
  // ให้คะแนนว่า array นี้ "น่าจะเป็นข้อมูลธุรกิจ" แค่ไหน
  // เราดู key ที่พบบ่อยใน object แต่ละตัว
  if(!Array.isArray(arr) || arr.length<1) return 0;
  let score=0;
  for(const it of arr.slice(0, Math.min(30,arr.length))){
    if(!isObj(it)) continue;
    const keys = Object.keys(it).map(k=>k.toLowerCase());
    const has = (k) => keys.includes(k);
    if(keys.includes("customername")||has("customer")||has("cust")||has("ลูกค้า")) score += 3;
    if(has("total")||has("amount")||has("ยอด")||has("price")||has("rmcost")||has("cost")) score += 2;
    if(has("date")||has("วันที่")) score += 1;
    if(has("items")||has("product")||has("สินค้า")||has("qty")) score += 2;
  }
  return score;
}

function collectCandidateArraysFromLocalStorage(){
  const arrays=[];
  for(let i=0;i<localStorage.length;i++){
    const key = localStorage.key(i);
    if(key===V3_KEY || key===MIG_FLAG) continue;
    const val = localStorage.getItem(key);
    const parsed = safeJSON(val);
    if(!parsed) continue;

    if(Array.isArray(parsed)){
      arrays.push({key,arr:parsed,score:scoreArray(parsed)});
      continue;
    }
    if(isObj(parsed)){
      for(const [k,v] of Object.entries(parsed)){
        if(Array.isArray(v)){
          arrays.push({key:`${key}.${k}`, arr:v, score:scoreArray(v)});
        }
      }
    }
  }
  arrays.sort((a,b)=>b.score-a.score);
  return arrays;
}

function migrateV1Once(){
  const done = localStorage.getItem(MIG_FLAG);
  if(done) return; // กัน migrate ซ้ำ
  const candidates = collectCandidateArraysFromLocalStorage();

  const notes=[];
  let imported= {customers:0, products:0, sales:0, expenses:0};
  const before = {
    customers: DB.customers.length,
    products: DB.products.length,
    sales: DB.sales.length,
    expenses: DB.expenses.length
  };

  // heuristic mapping: เราพยายามอ่านได้หลายรูปแบบ รวมทั้งรูปแบบจากโค้ด v1 ที่คุณเคยส่ง
  for(const c of candidates){
    const arr=c.arr;
    if(!Array.isArray(arr) || arr.length<1 || c.score<3) continue;

    for(const it of arr){
      if(!isObj(it)) continue;
      const keys = Object.keys(it);
      const lowerKeys = keys.map(k=>k.toLowerCase());
      const get = (...names) => {
        for(const n of names){
          const idx = lowerKeys.indexOf(String(n).toLowerCase());
          if(idx>=0) return it[keys[idx]];
        }
        return undefined;
      };

      // --- Customer detection ---
      // กรณีเป็น object ลูกค้าล้วน (name/phone/note)
      const nameCandidate = get("customerName","customer","cust","name","ชื่อลูกค้า","ลูกค้า","ชื่อ");
      const maybePhone = get("phone","tel","มือถือ","เบอร์");
      const maybeNote = get("note","remark","รายละเอียด","หมายเหตุ");
      if(nameCandidate && (typeof nameCandidate==="string" || typeof nameCandidate==="number")){
        // ถ้า object มีเฉพาะข้อมูลคล้ายลูกค้า -> import เป็น customer
        if(lowerKeys.includes("phone") || lowerKeys.includes("tel") || lowerKeys.includes("note") || lowerKeys.includes("remark") || lowerKeys.includes("มือถือ") || lowerKeys.includes("เบอร์")){
          const nm=String(nameCandidate).trim();
          const exists = DB.customers.find(x=>x.name===nm);
          if(!exists){
            DB.customers.push({id:uid(),name:nm,phone:maybePhone?String(maybePhone):"",note:maybeNote?String(maybeNote):"",createdAt:new Date().toISOString()});
          }
        }
      }

      // --- Product detection ---
      // v1 อาจเก็บ products: {id,name,rmCost,price,...}
      const prodName = get("product","productName","name","สินค้า");
      const price = get("price","salePrice","ราคาขาย");
      const rmCost = get("rmCost","rm","cost","ทุน","ต้นทุน","ทุนวัตถุดิบ");
      if(prodName && (price!==undefined || rmCost!==undefined) && (lowerKeys.includes("price") || lowerKeys.includes("rmcost") || lowerKeys.includes("rm") || lowerKeys.includes("cost") || lowerKeys.includes("ทุน") || lowerKeys.includes("ต้นทุน"))){
        ensureProductByNameMaybe(prodName, price, rmCost);
      }

      // --- Expense detection ---
      // v1 expenses: {id,date,amount,note} หรือ {date,amount,note}
      const amt = get("amount","amt","value","ยอด","จำนวนเงิน");
      const expDate = get("date","วันที่");
      const note = get("note","รายละเอียด","remark");
      const cat = get("category","type","หมวด","รายการ");
      if(amt!==undefined && !get("total","ยอดบิล") && (lowerKeys.includes("amount")||lowerKeys.includes("amt")||lowerKeys.includes("ยอด")||lowerKeys.includes("จำนวนเงิน"))){
        // ถ้า object ดูเป็นรายจ่าย
        const amount = normalizeNumber(amt);
        if(amount>0 && (note || cat || lowerKeys.includes("note") || lowerKeys.includes("remark") || lowerKeys.includes("category") || lowerKeys.includes("type"))){
          DB.expenses.push({
            id:uid(),
            date:guessDate(expDate),
            category: (cat?String(cat):"อื่นๆ"),
            amount,
            note: note?String(note):""
          });
        }
      }

      // --- Sales detection (ใบขาย) ---
      // v1 invoices: {id,date,total,items,customerName,status,paidAmount}
      const total = get("total","ยอดรวม","ยอดบิล");
      const paidAmount = get("paidAmount","paid","รับเงิน","รับชำระ");
      const items = get("items","products","รายการ");
      const custName2 = get("customerName","customer","ชื่อลูกค้า","ลูกค้า");

      const looksLikeSale = (total!==undefined && custName2!==undefined) || (isObj(items) && total!==undefined);
      if(looksLikeSale){
        const t = normalizeNumber(total);
        if(t>0){
          const cust = ensureCustomerByName(custName2||"ลูกค้าทั่วไป");
          // แปลง items จาก object {pid:qty} แบบ v1 หรือ array
          let newItems=[];
          if(isObj(items)){
            for(const [pid,qty] of Object.entries(items)){
              // pid อาจเป็น id เดิม (p1,p2...) → เราจะหาใน product list v1 ที่ migrate แล้ว ถ้าไม่เจอ สร้าง placeholder
              let p = DB.products.find(x=>x.id===pid);
              if(!p){
                // ถ้าใน v1 pid เป็นรหัสและไม่มีชื่อ เราสร้างชื่อ placeholder
                p = {id:pid, name:`สินค้า(${pid})`, price:0, cost:{rm:0,hidden:0,op:0,other:0}, active:true, createdAt:new Date().toISOString()};
                // กันชน id ซ้ำ
                if(!DB.products.find(x=>x.id===pid)) DB.products.push(p);
              }
              const q = normalizeNumber(qty);
              if(q>0){
                const priceAt = normalizeNumber(p.price);
                const costAt = normalizeNumber(p.cost?.rm)+normalizeNumber(p.cost?.hidden)+normalizeNumber(p.cost?.op)+normalizeNumber(p.cost?.other);
                newItems.push({productId:p.id, qty:q, priceAtSale:priceAt, costAtSale:costAt});
              }
            }
          }else if(Array.isArray(items)){
            for(const it2 of items){
              if(!isObj(it2)) continue;
              const nm = it2.name || it2.product || it2.productName;
              const q = normalizeNumber(it2.qty||it2.quantity||it2.amount||1);
              const pr = normalizeNumber(it2.price||it2.unitPrice||0);
              const rm = normalizeNumber(it2.rmCost||it2.cost||0);
              const p = ensureProductByNameMaybe(nm||"สินค้า", pr, rm);
              if(p && q>0){
                const costAt = normalizeNumber(p.cost.rm)+normalizeNumber(p.cost.hidden)+normalizeNumber(p.cost.op)+normalizeNumber(p.cost.other);
                newItems.push({productId:p.id, qty:q, priceAtSale: pr||p.price, costAtSale: costAt});
              }
            }
          }

          const paid = normalizeNumber(paidAmount);
          const status = paid>=t ? "รับครบ" : (paid>0 ? "รับบางส่วน" : "ค้างรับ");
          DB.sales.push({
            id:uid(),
            date: guessDate(get("date","วันที่")),
            customerId: cust?cust.id:null,
            items:newItems,
            total:t,
            paid,
            status
          });
        }
      }
    }

    notes.push(`นำเข้าจาก ${c.key} (score=${c.score})`);
  }

  // de-dup basic: customers by name
  DB.customers = DB.customers.filter((c,idx,arr)=>idx===arr.findIndex(x=>x.name===c.name));

  const after = {
    customers: DB.customers.length,
    products: DB.products.length,
    sales: DB.sales.length,
    expenses: DB.expenses.length
  };
  imported.customers = after.customers - before.customers;
  imported.products  = after.products  - before.products;
  imported.sales     = after.sales     - before.sales;
  imported.expenses  = after.expenses  - before.expenses;

  DB.meta.migratedFromV1 = true;
  DB.meta.migrationNotes = [
    ...DB.meta.migrationNotes,
    `MIGRATE@${new Date().toISOString()} customers+${imported.customers}, products+${imported.products}, sales+${imported.sales}, expenses+${imported.expenses}`,
    ...notes.slice(0,8)
  ];

  save();
  localStorage.setItem(MIG_FLAG, "1");
}

/* ---------- 5) Core Calculations ---------- */
function productCost(p){
  if(!p) return 0;
  const c = p.cost||{};
  return normalizeNumber(c.rm)+normalizeNumber(c.hidden)+normalizeNumber(c.op)+normalizeNumber(c.other);
}
function saleGrossProfit(sale){
  let gp=0;
  for(const it of (sale.items||[])){
    const pr = normalizeNumber(it.priceAtSale);
    const cost = normalizeNumber(it.costAtSale);
    gp += normalizeNumber(it.qty) * (pr - cost);
  }
  // ถ้าไม่มี items ให้ใช้ total เป็น revenue (profit จะใช้ expense แทนในระดับรวม)
  return gp;
}
function inRange(dateISO, startISO, endISO){
  const d = new Date(dateISO).getTime();
  const s = new Date(startISO).getTime();
  const e = new Date(endISO).getTime();
  return d>=s && d<=e;
}
function sumSales(start,end){
  const xs = DB.sales.filter(x=>inRange(x.date,start,end));
  return {
    list: xs,
    revenue: xs.reduce((a,b)=>a+normalizeNumber(b.total),0),
    paid: xs.reduce((a,b)=>a+normalizeNumber(b.paid),0),
    receivable: xs.reduce((a,b)=>a+(normalizeNumber(b.total)-normalizeNumber(b.paid)),0),
    grossProfit: xs.reduce((a,b)=>a+saleGrossProfit(b),0),
  };
}
function sumExpenses(start,end){
  const xs = DB.expenses.filter(x=>inRange(x.date,start,end));
  const total = xs.reduce((a,b)=>a+normalizeNumber(b.amount),0);
  return {list:xs,total};
}

/* ---------- 6) UI Framework (Vanilla Render) ---------- */
const Pages = {};
let STATE = {
  page:"dash",
  range:{ start: iso(new Date(new Date().getFullYear(), new Date().getMonth(), 1)), end: iso() },
  filters:{ expenseCat:"ทั้งหมด" }
};

const NAV_ITEMS = [
  {id:"dash", label:"แดชบอร์ด", group:"ภาพรวม"},
  {id:"customers", label:"ลูกค้า", group:"ภาพรวม"},
  {id:"products", label:"สินค้า & ต้นทุน", group:"ภาพรวม"},
  {id:"sales", label:"ขาย / รับเงิน", group:"ภาพรวม"},
  {id:"expenses", label:"ค่าใช้จ่าย / ใบเบิก", group:"ภาพรวม"},
  {id:"reports", label:"รายงานช่วงเวลา", group:"ภาพรวม"},
];

function renderNav(){
  const nav = $$("#nav");
  nav.innerHTML = NAV_ITEMS.map(it=>`
    <button class="${STATE.page===it.id?'active':''}" onclick="Actions.go('${it.id}')">
      <span class="dot"></span><span>${it.label}</span>
    </button>
  `).join("");
}

function setHeader(title, subtitle){
  $$("#title").textContent = title;
  $$("#subtitle").textContent = subtitle;
}

function render(){
  renderNav();
  const root = $$("#root");
  root.innerHTML = "";
  const fn = Pages[STATE.page] || Pages.dash;
  root.appendChild(fn());
}

/* ---------- 7) Actions ---------- */
const Actions = {
  go(p){ STATE.page=p; render(); },
  print(){ window.print(); },
  backupHint(){
    alert("สำรองข้อมูลแบบเร็ว:\n\n1) เปิด Console\n2) พิมพ์: copy(localStorage)\n3) วางเก็บไว้ในไฟล์ .txt\n\nหรือใช้ปุ่ม 'ส่งออกข้อมูล (JSON)' ในเมนูซ้าย");
  },
  exportDB(){
    const blob = new Blob([JSON.stringify(DB,null,2)], {type:"application/json;charset=utf-8"});
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = `BKP_ERP_v3A_backup_${iso()}.json`;
    a.click();
  },
  importDB(){
    const inp = document.createElement("input");
    inp.type="file"; inp.accept="application/json";
    inp.onchange = async () => {
      const f = inp.files?.[0];
      if(!f) return;
      const text = await f.text();
      const obj = safeJSON(text);
      if(!obj || obj.meta?.schema!=="v3-A"){
        alert("ไฟล์ไม่ถูกต้อง (ต้องเป็น backup ของ v3-A)");
        return;
      }
      DB = obj;
      save();
      alert("นำเข้าข้อมูลสำเร็จ");
      render();
    };
    inp.click();
  },
  addCustomer(payload){
    const name = (payload.name||"").trim();
    if(!name) return alert("กรุณากรอกชื่อลูกค้า");
    if(DB.customers.find(c=>c.name===name)) return alert("มีชื่อลูกค้านี้แล้ว");
    DB.customers.unshift({id:uid(),name,phone:(payload.phone||"").trim(),note:(payload.note||"").trim(),createdAt:new Date().toISOString()});
    save(); render();
  },
  addProduct(payload){
    const name=(payload.name||"").trim();
    if(!name) return alert("กรุณากรอกชื่อสินค้า");
    const price=normalizeNumber(payload.price);
    const rm=normalizeNumber(payload.rm);
    const hidden=normalizeNumber(payload.hidden);
    const op=normalizeNumber(payload.op);
    const other=normalizeNumber(payload.other);
    DB.products.unshift({
      id:uid(), name, price,
      cost:{rm,hidden,op,other},
      active:true,
      createdAt:new Date().toISOString()
    });
    save(); render();
  },
  toggleProduct(id){
    const p=DB.products.find(x=>x.id===id);
    if(!p) return;
    p.active = !p.active;
    save(); render();
  },
  addSale(payload){
    const date=payload.date||iso();
    const customerId=payload.customerId||null;
    if(!customerId) return alert("กรุณาเลือกลูกค้า");
    const items=payload.items||[];
    if(items.length<1) return alert("กรุณาเลือกสินค้าอย่างน้อย 1 รายการ");
    let total=0;
    const mapped=[];
    for(const it of items){
      const p=DB.products.find(x=>x.id===it.productId);
      if(!p) continue;
      const qty=normalizeNumber(it.qty);
      if(qty<=0) continue;
      const priceAt = normalizeNumber(it.priceAtSale ?? p.price);
      const costAt = productCost(p);
      mapped.push({productId:p.id, qty, priceAtSale:priceAt, costAtSale:costAt});
      total += qty * priceAt;
    }
    if(mapped.length<1 || total<=0) return alert("รายการขายไม่สมบูรณ์");
    DB.sales.unshift({
      id:uid(), date, customerId,
      items:mapped,
      total, paid:0,
      status:"ค้างรับ"
    });
    save(); render();
  },
  receivePayment(saleId){
    const s=DB.sales.find(x=>x.id===saleId);
    if(!s) return;
    const remain = normalizeNumber(s.total)-normalizeNumber(s.paid);
    const amtStr = prompt(`ยอดรับชำระ (ค้าง ${fmtMoney(remain)}):`);
    if(amtStr===null) return;
    const amt = normalizeNumber(amtStr);
    if(amt<=0) return alert("ยอดไม่ถูกต้อง");
    s.paid = normalizeNumber(s.paid)+amt;
    if(s.paid>=s.total) { s.paid=s.total; s.status="รับครบ"; }
    else s.status="รับบางส่วน";
    save(); render();
  },
  addExpense(payload){
    const date=payload.date||iso();
    const category=(payload.category||"อื่นๆ").trim()||"อื่นๆ";
    const amount=normalizeNumber(payload.amount);
    const note=(payload.note||"").trim();
    if(amount<=0) return alert("กรุณาระบุจำนวนเงิน");
    DB.expenses.unshift({id:uid(),date,category,amount,note});
    save(); render();
  },
  setRange(start,end){
    STATE.range={start,end};
    render();
  }
};

/* ---------- 8) Pages ---------- */
Pages.dash = () => {
  setHeader("แดชบอร์ด", "ภาพรวมยอดขาย-รับเงิน-ค่าใช้จ่าย (ปรับช่วงเวลาได้ที่หน้า ‘รายงานช่วงเวลา’)");
  const start=STATE.range.start, end=STATE.range.end;
  const s = sumSales(start,end);
  const e = sumExpenses(start,end);
  const net = s.revenue - e.total;

  // customer behavior (top)
  const custMap = {};
  for(const sale of s.list){
    const cid = sale.customerId || "unknown";
    custMap[cid] = custMap[cid] || {revenue:0,count:0,receivable:0};
    custMap[cid].revenue += normalizeNumber(sale.total);
    custMap[cid].count += 1;
    custMap[cid].receivable += (normalizeNumber(sale.total)-normalizeNumber(sale.paid));
  }
  const topCustomers = Object.entries(custMap)
    .map(([cid,v])=>{
      const c = DB.customers.find(x=>x.id===cid);
      return {cid, name:c?c.name:"(ไม่ระบุลูกค้า)", ...v};
    })
    .sort((a,b)=>b.revenue-a.revenue)
    .slice(0,8);

  const wrap = document.createElement("div");
  wrap.className = "grid";
  wrap.innerHTML = `
    <div class="grid g4">
      <div class="card hi"><div class="stat">
        <div><div class="k">ยอดขายรวม</div><div class="v">${fmtMoney(s.revenue)}</div><div class="s">ช่วง ${start} ถึง ${end}</div></div>
        <div class="chip">รายได้</div>
      </div></div>
      <div class="card"><div class="stat">
        <div><div class="k">รับเงินแล้ว</div><div class="v">${fmtMoney(s.paid)}</div><div class="s">เข้ากระเป๋าแล้ว</div></div>
        <div class="chip ok">Cash In</div>
      </div></div>
      <div class="card"><div class="stat">
        <div><div class="k">ลูกหนี้ค้างรับ</div><div class="v">${fmtMoney(s.receivable)}</div><div class="s">รอเก็บเงิน</div></div>
        <div class="chip wait">A/R</div>
      </div></div>
      <div class="card"><div class="stat">
        <div><div class="k">กำไรสุทธิ</div><div class="v">${fmtMoney(net)}</div><div class="s">ยอดขาย - ค่าใช้จ่าย</div></div>
        <div class="chip">NET</div>
      </div></div>
    </div>

    <div class="card">
      <div class="row" style="justify-content:space-between;align-items:center">
        <div>
          <h3 style="margin:0">พฤติกรรมลูกค้า (Top)</h3>
          <div class="hint">ดูยอดซื้อ / จำนวนบิล / ลูกหนี้ค้างรับรายคน</div>
        </div>
        <div class="pillbar no-print">
          <button class="btn ghost" onclick="Actions.go('reports')">ไปหน้า “รายงานช่วงเวลา”</button>
        </div>
      </div>
      <div class="hr"></div>
      <table>
        <thead><tr>
          <th>ลูกค้า</th><th class="tdr">ยอดซื้อ</th><th class="tdr">จำนวนบิล</th><th class="tdr">ค้างรับ</th>
        </tr></thead>
        <tbody>
          ${
            topCustomers.length? topCustomers.map(x=>`
              <tr>
                <td><b>${x.name}</b></td>
                <td class="tdr">${fmtMoney(x.revenue)}</td>
                <td class="tdr">${fmtInt(x.count)}</td>
                <td class="tdr">${fmtMoney(x.receivable)}</td>
              </tr>
            `).join("") : `<tr><td colspan="4" class="muted">ยังไม่มีข้อมูลในช่วงเวลานี้</td></tr>`
          }
        </tbody>
      </table>
    </div>

    <div class="card">
      <h3 style="margin:0">สถานะการย้ายข้อมูล</h3>
      <div class="hr"></div>
      <div class="${DB.meta.migratedFromV1?'okbox':'warnbox'}">
        ${DB.meta.migratedFromV1
          ? "✅ ระบบได้พยายามดึงข้อมูลจากเวอร์ชัน 1 แล้ว (อ่านอย่างเดียว ไม่ลบข้อมูลเดิม)"
          : "⚠️ ยังไม่พบข้อมูลเวอร์ชัน 1 หรือยังไม่ได้ migrate (ถ้าคุณมีข้อมูลเดิมจริง ให้ลองเปิดด้วยเบราว์เซอร์เดิมที่เคยใช้)"
        }
      </div>
      <div class="hint" style="margin-top:10px">
        บันทึก: <br>
        ${ (DB.meta.migrationNotes||[]).slice(-6).map(n=>`• ${n}`).join("<br>") || "—" }
      </div>
    </div>
  `;
  return wrap;
};

Pages.customers = () => {
  setHeader("ลูกค้า", "เพิ่มลูกค้า / เก็บฐานชื่อไว้เลือกในใบขาย");
  const wrap=document.createElement("div");
  wrap.className="grid";
  wrap.innerHTML=`
    <div class="card">
      <h3 style="margin:0">เพิ่มลูกค้าใหม่</h3>
      <div class="hr"></div>
      <div class="grid g3">
        <div><label>ชื่อลูกค้า</label><input id="c_name" placeholder="เช่น ร้าน A / คุณ B"></div>
        <div><label>เบอร์โทร (ถ้ามี)</label><input id="c_phone" placeholder="0xx-xxx-xxxx"></div>
        <div><label>หมายเหตุ</label><input id="c_note" placeholder="เงื่อนไขเครดิต/วันวางบิล"></div>
      </div>
      <div style="height:10px"></div>
      <button class="btn pri" onclick="Actions.addCustomer({name:$$('#c_name').value,phone:$$('#c_phone').value,note:$$('#c_note').value})">บันทึก</button>
    </div>

    <div class="card">
      <div class="row" style="justify-content:space-between;align-items:center">
        <div>
          <h3 style="margin:0">รายชื่อลูกค้า</h3>
          <div class="hint">รวมทั้งลูกค้าที่ migrate มาจากเวอร์ชัน 1</div>
        </div>
        <div class="chip">${fmtInt(DB.customers.length)} ราย</div>
      </div>
      <div class="hr"></div>
      <table>
        <thead><tr><th>ลูกค้า</th><th>โทร</th><th>หมายเหตุ</th></tr></thead>
        <tbody>
          ${
            DB.customers.length? DB.customers.map(c=>`
              <tr>
                <td><b>${c.name}</b></td>
                <td>${c.phone||""}</td>
                <td class="muted">${c.note||""}</td>
              </tr>
            `).join("") : `<tr><td colspan="3" class="muted">ยังไม่มีลูกค้า</td></tr>`
          }
        </tbody>
      </table>
    </div>
  `;
  return wrap;
};

Pages.products = () => {
  setHeader("สินค้า & โครงสร้างต้นทุน", "ปรับทุนหลายชั้น + คำนวณกำไรต่อหน่วย");
  const wrap=document.createElement("div");
  wrap.className="grid";
  wrap.innerHTML=`
    <div class="card">
      <h3 style="margin:0">เพิ่มสินค้า</h3>
      <div class="hr"></div>
      <div class="grid g3">
        <div><label>ชื่อสินค้า</label><input id="p_name" placeholder="เช่น น้ำยำปลาร้า"></div>
        <div><label>ราคาขาย/หน่วย</label><input id="p_price" type="number" placeholder="0"></div>
        <div></div>
        <div><label>ทุนวัตถุดิบ (RM)</label><input id="p_rm" type="number" placeholder="0"></div>
        <div><label>ทุนแฝง</label><input id="p_hidden" type="number" placeholder="0"></div>
        <div><label>ทุนดำเนินการ</label><input id="p_op" type="number" placeholder="0"></div>
        <div><label>ทุนอื่น ๆ</label><input id="p_other" type="number" placeholder="0"></div>
      </div>
      <div style="height:10px"></div>
      <button class="btn pri" onclick="Actions.addProduct({
        name:$$('#p_name').value, price:$$('#p_price').value, rm:$$('#p_rm').value,
        hidden:$$('#p_hidden').value, op:$$('#p_op').value, other:$$('#p_other').value
      })">บันทึกสินค้า</button>
      <div class="hint" style="margin-top:10px">* สินค้าที่ migrate มาจาก v1 อาจมีทุน/ราคาไม่ครบ คุณสามารถปรับได้ที่นี่</div>
    </div>

    <div class="card">
      <div class="row" style="justify-content:space-between;align-items:center">
        <div>
          <h3 style="margin:0">รายการสินค้า</h3>
          <div class="hint">คำนวณ ต้นทุนรวม = RM + แฝง + ดำเนินการ + อื่น ๆ</div>
        </div>
        <div class="chip">${fmtInt(DB.products.length)} รายการ</div>
      </div>
      <div class="hr"></div>
      <table>
        <thead>
          <tr>
            <th>สินค้า</th><th class="tdr">ราคา</th><th class="tdr">ต้นทุนรวม</th><th class="tdr">กำไร/หน่วย</th><th class="tdr">สถานะ</th>
          </tr>
        </thead>
        <tbody>
          ${
            DB.products.length ? DB.products.map(p=>{
              const cost=productCost(p);
              const gp=normalizeNumber(p.price)-cost;
              return `
                <tr>
                  <td><b>${p.name}</b></td>
                  <td class="tdr">${fmtMoney(p.price)}</td>
                  <td class="tdr">${fmtMoney(cost)}</td>
                  <td class="tdr"><b>${fmtMoney(gp)}</b></td>
                  <td class="tdr">
                    <button class="btn ${p.active?'ok':'danger'}" onclick="Actions.toggleProduct('${p.id}')">${p.active?'ใช้งาน':'ปิดใช้งาน'}</button>
                  </td>
                </tr>
              `;
            }).join("")
            : `<tr><td colspan="5" class="muted">ยังไม่มีสินค้า</td></tr>`
          }
        </tbody>
      </table>
    </div>
  `;
  return wrap;
};

Pages.sales = () => {
  setHeader("ขาย / รับเงิน", "ออกบิลขาย (แบบง่าย) + รับชำระ + ติดตามลูกหนี้");
  const activeProducts = DB.products.filter(p=>p.active);
  const wrap=document.createElement("div");
  wrap.className="grid";

  const customerOptions = DB.customers.map(c=>`<option value="${c.id}">${c.name}</option>`).join("");
  const productRows = activeProducts.map(p=>`
    <tr>
      <td><b>${p.name}</b><div class="muted" style="font-size:12px">ราคา: ${fmtMoney(p.price)} | ทุน: ${fmtMoney(productCost(p))}</div></td>
      <td style="width:140px">
        <input type="number" min="0" step="0.01" data-pid="${p.id}" class="saleqty" placeholder="0">
      </td>
      <td style="width:160px">
        <input type="number" min="0" step="0.01" data-ppid="${p.id}" class="saleprice" placeholder="${p.price}">
      </td>
    </tr>
  `).join("");

  const rows = DB.sales.slice(0,60).map(s=>{
    const c = DB.customers.find(x=>x.id===s.customerId);
    const remain = normalizeNumber(s.total)-normalizeNumber(s.paid);
    const chip = s.status==="รับครบ" ? "ok" : "wait";
    return `
      <tr>
        <td>${s.date}</td>
        <td><b>${c?c.name:"(ไม่ระบุลูกค้า)"}</b></td>
        <td class="tdr">${fmtMoney(s.total)}</td>
        <td class="tdr">${fmtMoney(s.paid)}</td>
        <td class="tdr">${fmtMoney(remain)}</td>
        <td class="tdr"><span class="chip ${chip}">${s.status}</span></td>
        <td class="tdr">
          ${s.status!=="รับครบ" ? `<button class="btn ok" onclick="Actions.receivePayment('${s.id}')">รับเงิน</button>` : `<span class="muted">—</span>`}
        </td>
      </tr>
    `;
  }).join("");

  wrap.innerHTML=`
    <div class="card">
      <h3 style="margin:0">ออกบิลขายใหม่</h3>
      <div class="hr"></div>
      <div class="grid g3">
        <div><label>วันที่</label><input id="s_date" type="date" value="${iso()}"></div>
        <div><label>ลูกค้า</label><select id="s_cust"><option value="">— เลือกลูกค้า —</option>${customerOptions}</select></div>
        <div class="hint">* ระบบจะดึงลูกค้าเดิม (จาก v1) มาให้เลือก</div>
      </div>
      <div style="height:10px"></div>
      <table>
        <thead><tr><th>สินค้า</th><th>จำนวน</th><th>ราคา/หน่วย (แก้ได้)</th></tr></thead>
        <tbody>
          ${activeProducts.length?productRows:`<tr><td colspan="3" class="muted">ยังไม่มีสินค้า (หรือถูกปิดใช้งาน)</td></tr>`}
        </tbody>
      </table>
      <div style="height:10px"></div>
      <button class="btn pri" onclick="(function(){
        const items=[];
        document.querySelectorAll('.saleqty').forEach(inp=>{
          const qty=Number(inp.value)||0;
          if(qty>0){
            const pid=inp.getAttribute('data-pid');
            const pinp=document.querySelector('.saleprice[data-ppid=\"'+pid+'\"]');
            const priceAt=Number(pinp?.value)||0;
            items.push({productId:pid,qty:qty,priceAtSale:priceAt});
          }
        });
        Actions.addSale({date:document.getElementById('s_date').value, customerId:document.getElementById('s_cust').value, items});
      })()">บันทึกบิล</button>
    </div>

    <div class="card">
      <div class="row" style="justify-content:space-between;align-items:center">
        <div>
          <h3 style="margin:0">ประวัติขาย / ลูกหนี้</h3>
          <div class="hint">แสดงล่าสุด 60 รายการ (พิมพ์/ทำ PDF ได้จากปุ่มบนสุด)</div>
        </div>
        <div class="chip">ทั้งหมด ${fmtInt(DB.sales.length)} บิล</div>
      </div>
      <div class="hr"></div>
      <table>
        <thead>
          <tr><th>วันที่</th><th>ลูกค้า</th><th class="tdr">ยอดบิล</th><th class="tdr">รับแล้ว</th><th class="tdr">ค้างรับ</th><th class="tdr">สถานะ</th><th class="tdr">จัดการ</th></tr>
        </thead>
        <tbody>${DB.sales.length?rows:`<tr><td colspan="7" class="muted">ยังไม่มีบิล</td></tr>`}</tbody>
      </table>
    </div>
  `;
  return wrap;
};

Pages.expenses = () => {
  setHeader("ค่าใช้จ่าย / ใบเบิก", "บันทึกรายจ่ายเป็นหมวด + ใช้ทำใบเบิกและรายงานช่วงเวลา");
  const cats = ["ทั้งหมด", ...DB.settings.expenseCategories];
  const wrap=document.createElement("div");
  wrap.className="grid";

  const catPills = cats.map(c=>`<div class="pill ${STATE.filters.expenseCat===c?'active':''}" onclick="(function(){STATE.filters.expenseCat='${c}';render();})()">${c}</div>`).join("");
  const list = (STATE.filters.expenseCat==="ทั้งหมด")
    ? DB.expenses
    : DB.expenses.filter(x=>x.category===STATE.filters.expenseCat);

  const rows = list.slice(0,80).map(e=>`
    <tr><td>${e.date}</td><td><b>${e.category}</b></td><td class="tdr">${fmtMoney(e.amount)}</td><td class="muted">${e.note||""}</td></tr>
  `).join("");

  wrap.innerHTML=`
    <div class="card">
      <h3 style="margin:0">บันทึกรายจ่ายใหม่</h3>
      <div class="hr"></div>
      <div class="grid g3">
        <div><label>วันที่</label><input id="e_date" type="date" value="${iso()}"></div>
        <div><label>หมวด</label>
          <select id="e_cat">${DB.settings.expenseCategories.map(c=>`<option value="${c}">${c}</option>`).join("")}</select>
        </div>
        <div><label>จำนวนเงิน</label><input id="e_amt" type="number" placeholder="0"></div>
      </div>
      <div style="height:8px"></div>
      <div><label>รายละเอียด</label><textarea id="e_note" placeholder="เช่น ค่าไฟเดือน ม.ค., ค่าทำบัญชี, ค่าแรงผลิต"></textarea></div>
      <div style="height:10px"></div>
      <button class="btn pri" onclick="Actions.addExpense({
        date:$$('#e_date').value, category:$$('#e_cat').value, amount:$$('#e_amt').value, note:$$('#e_note').value
      })">บันทึกค่าใช้จ่าย</button>
      <div class="hint" style="margin-top:10px">
        * การพิมพ์ใบเบิก/รายงานตามช่วงเวลา → ไปที่หน้า “รายงานช่วงเวลา” แล้วเลือกหมวด + กดพิมพ์/PDF
      </div>
    </div>

    <div class="card">
      <div class="row" style="justify-content:space-between;align-items:center">
        <div>
          <h3 style="margin:0">รายการค่าใช้จ่าย</h3>
          <div class="hint">ใช้ตัวกรองหมวดเพื่อทำใบเบิกเฉพาะหมวดได้</div>
        </div>
        <div class="chip">ทั้งหมด ${fmtInt(DB.expenses.length)} รายการ</div>
      </div>
      <div class="hr"></div>
      <div class="pillbar no-print">${catPills}</div>
      <div style="height:10px"></div>
      <table>
        <thead><tr><th>วันที่</th><th>หมวด</th><th class="tdr">จำนวน</th><th>รายละเอียด</th></tr></thead>
        <tbody>${list.length?rows:`<tr><td colspan="4" class="muted">ยังไม่มีข้อมูล</td></tr>`}</tbody>
      </table>
    </div>
  `;
  return wrap;
};

Pages.reports = () => {
  setHeader("รายงานช่วงเวลา", "เลือกช่วงเวลา → สรุปยอดขาย/ลูกหนี้/ค่าใช้จ่าย/กำไร และพิมพ์เป็น PDF");
  const wrap=document.createElement("div");
  wrap.className="grid";

  const start = STATE.range.start;
  const end = STATE.range.end;
  const s = sumSales(start,end);
  const e = sumExpenses(start,end);
  const net = s.revenue - e.total;

  // breakdown by expense category within range
  const expMap={};
  for(const x of e.list){
    expMap[x.category]= (expMap[x.category]||0)+normalizeNumber(x.amount);
  }
  const expRows = Object.entries(expMap).sort((a,b)=>b[1]-a[1]).map(([cat,val])=>`
    <tr><td><b>${cat}</b></td><td class="tdr">${fmtMoney(val)}</td></tr>
  `).join("");

  // top customers within range
  const custMap={};
  for(const sale of s.list){
    const cid=sale.customerId||"unknown";
    custMap[cid]=custMap[cid]||{revenue:0,paid:0,receivable:0,count:0};
    custMap[cid].revenue += normalizeNumber(sale.total);
    custMap[cid].paid += normalizeNumber(sale.paid);
    custMap[cid].receivable += (normalizeNumber(sale.total)-normalizeNumber(sale.paid));
    custMap[cid].count += 1;
  }
  const custRows = Object.entries(custMap).map(([cid,v])=>{
    const c=DB.customers.find(x=>x.id===cid);
    return {name:c?c.name:"(ไม่ระบุลูกค้า)",...v};
  }).sort((a,b)=>b.revenue-a.revenue).slice(0,12)
    .map(x=>`
      <tr>
        <td><b>${x.name}</b></td>
        <td class="tdr">${fmtMoney(x.revenue)}</td>
        <td class="tdr">${fmtMoney(x.paid)}</td>
        <td class="tdr">${fmtMoney(x.receivable)}</td>
        <td class="tdr">${fmtInt(x.count)}</td>
      </tr>
    `).join("");

  wrap.innerHTML=`
    <div class="card no-print">
      <h3 style="margin:0">ตั้งค่าช่วงเวลา</h3>
      <div class="hr"></div>
      <div class="grid g3">
        <div><label>เริ่มวันที่</label><input id="r_start" type="date" value="${start}"></div>
        <div><label>ถึงวันที่</label><input id="r_end" type="date" value="${end}"></div>
        <div style="display:flex;gap:8px;align-items:flex-end">
          <button class="btn pri" onclick="Actions.setRange($$('#r_start').value,$$('#r_end').value)">คำนวณ</button>
          <button class="btn ghost" onclick="Actions.print()">พิมพ์/PDF</button>
        </div>
      </div>
      <div class="hint" style="margin-top:10px">
        * ใช้หน้าเดียวทำรายงานผู้ถือหุ้น/ใบเบิกค่าแรง (เลือกช่วงเวลา แล้วพิมพ์)
      </div>
    </div>

    <div class="card">
      <div class="row" style="justify-content:space-between;align-items:flex-end">
        <div>
          <h3 style="margin:0">รายงานสรุปผลประกอบการ</h3>
          <div class="hint">ช่วง ${start} ถึง ${end}</div>
        </div>
        <div class="chip">ออกรายงาน: ${iso()}</div>
      </div>
      <div class="hr"></div>
      <div class="grid g4">
        <div class="card hi"><div class="stat"><div><div class="k">ยอดขาย</div><div class="v">${fmtMoney(s.revenue)}</div><div class="s">รวมบิล</div></div><div class="chip">REV</div></div></div>
        <div class="card"><div class="stat"><div><div class="k">รับเงินแล้ว</div><div class="v">${fmtMoney(s.paid)}</div><div class="s">Cash In</div></div><div class="chip ok">PAID</div></div></div>
        <div class="card"><div class="stat"><div><div class="k">ค้างรับ</div><div class="v">${fmtMoney(s.receivable)}</div><div class="s">A/R</div></div><div class="chip wait">DUE</div></div></div>
        <div class="card"><div class="stat"><div><div class="k">กำไรสุทธิ</div><div class="v">${fmtMoney(net)}</div><div class="s">ยอดขาย - รายจ่าย</div></div><div class="chip">NET</div></div></div>
      </div>

      <div style="height:12px"></div>
      <div class="grid g2">
        <div class="card">
          <h3 style="margin:0">ค่าใช้จ่ายแยกตามหมวด</h3>
          <div class="hr"></div>
          <table>
            <thead><tr><th>หมวด</th><th class="tdr">จำนวน</th></tr></thead>
            <tbody>${Object.keys(expMap).length?expRows:`<tr><td colspan="2" class="muted">ไม่มีค่าใช้จ่ายในช่วงนี้</td></tr>`}</tbody>
          </table>
        </div>

        <div class="card">
          <h3 style="margin:0">ลูกค้าสูงสุดในช่วงเวลา</h3>
          <div class="hr"></div>
          <table>
            <thead><tr><th>ลูกค้า</th><th class="tdr">ยอดซื้อ</th><th class="tdr">รับแล้ว</th><th class="tdr">ค้างรับ</th><th class="tdr">จำนวนบิล</th></tr></thead>
            <tbody>${s.list.length?custRows:`<tr><td colspan="5" class="muted">ไม่มีบิลในช่วงนี้</td></tr>`}</tbody>
          </table>
        </div>
      </div>
    </div>
  `;
  return wrap;
};

/* ---------- 9) Boot ---------- */
(function boot(){
  // 1) migrate once before any render
  try{ migrateV1Once(); }catch(e){
    DB.meta.migrationNotes = [...(DB.meta.migrationNotes||[]), `MIGRATE_ERROR@${new Date().toISOString()} ${String(e)}`];
    save();
  }

  // 2) default page
  STATE.page = "dash";

  // 3) render
  render();
})();
</script>
</body>
</html>
